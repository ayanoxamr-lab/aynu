<!DOCTYPE html>
<html lang="en" data-theme="night"> <!-- Default theme set here -->
<head>
  <meta charset="UTF-8" />
  <title>Aynu CEX – AMRChain Cosmic Exchange</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    /* =========================
        GLOBAL RESET & VARIABLES
    ========================== */
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    :root {
      --bg-main: radial-gradient(circle at top, #181b3f 0%, #050617 45%, #020309 100%);
      --bg-panel: rgba(8, 11, 36, 0.96);
      --border-soft: rgba(137, 160, 255, 0.35);
      --border-strong: rgba(152, 180, 255, 0.75);
      --accent-1: #7b5bff;
      --accent-2: #37c5ff;
      --accent-3: #4caf50;
      --accent-4: #ff4b7d;
      --text-main: #f6f7ff;
      --text-muted: #a5afd9;
      --danger: #ff4b7d;
      --success: #4caf50;
      --warning: #ffb74d;
      --shadow-soft: 0 0 18px rgba(0, 0, 0, 0.85);
      --radius-lg: 16px;
      --radius-md: 10px;
      --radius-sm: 6px;
      --transition-fast: 0.15s ease;
      --transition-med: 0.25s ease;
      --nav-h: 64px;
    }
    
    /* Evening Theme */
    [data-theme="evening"] {
      --bg-main: radial-gradient(circle at top, #2a1b3f 0%, #170517 45%, #090209 100%);
      --bg-panel: rgba(22, 11, 36, 0.96);
      --border-soft: rgba(214, 137, 255, 0.35);
      --accent-1: #c05bff;
      --accent-2: #ff37a8;
    }

    /* Night Theme (Default) */
    [data-theme="night"] {
      --bg-main: radial-gradient(circle at top, #0f122e 0%, #050617 45%, #020309 100%);
      --bg-panel: rgba(10, 12, 34, 0.96);
      --border-soft: rgba(137, 160, 255, 0.35);
    }

    /* Holographic Theme */
    [data-theme="holographic"] {
      --bg-main: #020309;
      --bg-panel: rgba(10, 25, 40, 0.85);
      --border-soft: rgba(0, 255, 255, 0.4);
      --border-strong: rgba(0, 255, 255, 0.75);
      --accent-1: #00ffff;
      --accent-2: #ff00ff;
      --accent-3: #00ff00;
      --accent-4: #ff3333;
      --text-main: #f0f8ff;
      --text-muted: #88d4ff;
    }

    html, body {
      width: 100%;
      height: 100%;
      font-family: system-ui, -apple-system, BlinkMacSystemFont,"SF Pro Text","Segoe UI",sans-serif;
      background: #020309;
      color: var(--text-main);
      overflow-x: hidden; /* Allow vertical scroll, hide horizontal */
      overflow-y: auto;
    }
    body {
      background-image: var(--bg-main);
      background-attachment: fixed;
      transition: background var(--transition-med);
    }

    /* =========================
        COSMIC BACKGROUND
    ========================== */
    .cosmic-bg {
      position: fixed;
      inset: 0;
      pointer-events: none;
      z-index: 0;
      overflow: hidden;
    }
    .cosmic-layer {
      position: absolute;
      inset: -10%;
      background:
        radial-gradient(circle at 10% 20%, rgba(93, 151, 255, 0.18) 0, transparent 55%),
        radial-gradient(circle at 80% 10%, rgba(202, 114, 255, 0.25) 0, transparent 45%),
        radial-gradient(circle at 50% 90%, rgba(30, 225, 255, 0.18) 0, transparent 55%);
      filter: blur(1px);
      opacity: 0.8;
      animation: cosmicPulse 24s ease-in-out infinite alternate;
    }
    .starfield {
      position: absolute;
      inset: 0;
      background-image:
        radial-gradient(1px 1px at 10% 20%, rgba(255,255,255,0.6) 0, transparent 60%),
        radial-gradient(1px 1px at 45% 70%, rgba(175,200,255,0.8) 0, transparent 60%),
        radial-gradient(1px 1px at 80% 30%, rgba(200,220,255,0.9) 0, transparent 60%),
        radial-gradient(1px 1px at 15% 80%, rgba(150,190,255,0.7) 0, transparent 60%);
      opacity: 0.9;
      animation: starDrift 60s linear infinite;
    }
    @keyframes cosmicPulse {
      0%   { transform: scale(1) translate3d(0, 0, 0); opacity: 0.7; }
      50%  { transform: scale(1.08) translate3d(0, -10px, 0); opacity: 1; }
      100% { transform: scale(1.05) translate3d(0, 10px, 0); opacity: 0.8; }
    }
    @keyframes starDrift {
      0%   { transform: translateY(0); }
      100% { transform: translateY(40px); }
    }

    /* =========================
        APP LAYOUT
    ========================== */
    #app-root {
      position: relative;
      z-index: 1;
      min-height: 100vh; /* Use min-height for scroll */
      display: flex;
      flex-direction: column;
      backdrop-filter: blur(10px);
    }
    /* Page container for Spot/Futures/Metals */
    .page-container {
      flex: 1;
      display: flex;
      flex-direction: column;
      min-height: 0;
    }
    
    /* NEW: Demo Mode Banner */
    #demo-mode-banner {
      display: none; /* Hidden by default */
      background: linear-gradient(135deg, var(--warning), var(--accent-1));
      color: #000;
      text-align: center;
      padding: 4px;
      font-size: 12px;
      font-weight: 600;
      letter-spacing: 0.05em;
      text-transform: uppercase;
    }

    /* =========================
        TOP NAVBAR (SPACESHIP BRIDGE)
    ========================== */
    .top-nav {
      height: var(--nav-h);
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 16px;
      border-bottom: 1px solid var(--border-strong);
      background:
        linear-gradient(135deg, rgba(12, 16, 40, 0.96), rgba(6, 8, 22, 0.98));
      box-shadow: 0 6px 18px rgba(0, 0, 0, 0.85);
      flex-shrink: 0; /* Prevent nav from shrinking */
      position: sticky; /* Stick to top */
      top: 0;
      z-index: 10;
    }
    [data-theme="holographic"] .top-nav {
      background: rgba(10, 25, 40, 0.85);
      border-bottom: 1px solid var(--border-soft);
      backdrop-filter: blur(5px);
    }
    .nav-logo-area {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .nav-logo-orca {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background:
        radial-gradient(circle at 30% 25%, #ffffff 0, #d5e2ff 22%, #6f9bff 50%, #252848 70%, #02030f 100%);
      box-shadow:
        0 0 18px rgba(95, 140, 255, 0.9),
        0 0 32px rgba(99, 236, 255, 0.5);
      position: relative;
      overflow: hidden;
      /* NEW: Center the SVG */
      display: flex;
      align-items: center;
      justify-content: center;
    }
    [data-theme="holographic"] .nav-logo-orca {
      box-shadow: 0 0 18px var(--accent-1), 0 0 32px var(--accent-1);
    }
    /* REMOVED: ::after */
    
    /* NEW: Dolphin SVG */
    .nav-logo-orca svg {
      width: 65%;
      height: 65%;
      fill: rgba(255, 255, 255, 0.9);
      filter: drop-shadow(0 0 8px rgba(255, 255, 255, 0.7));
      transform: rotate(-10deg) translateY(-2px);
    }
    
    .nav-logo-text {
      display: flex;
      flex-direction: column;
      line-height: 1.1;
    }
    .nav-logo-title {
      text-transform: uppercase;
      letter-spacing: 0.12em;
      font-weight: 700;
      font-size: 14px;
    }
    .nav-logo-sub {
      font-size: 11px;
      color: var(--text-muted);
    }

    .nav-main-menu {
      display: flex;
      align-items: center;
      gap: 6px;
      margin-left: 18px;
    }
    .nav-tab {
      border: none;
      background: transparent;
      color: var(--text-muted);
      font-size: 13px;
      padding: 6px 12px;
      border-radius: 999px;
      cursor: pointer;
      position: relative;
      overflow: hidden;
      transition: background var(--transition-fast), color var(--transition-fast), transform var(--transition-fast);
    }
    .nav-tab::before {
      content: "";
      position: absolute;
      inset: 0;
      background: linear-gradient(120deg, rgba(123, 91, 255, 0.0), var(--accent-1), rgba(55, 197, 255, 0.0));
      opacity: 0;
      transform: translateX(-20%);
      transition: opacity var(--transition-med), transform var(--transition-med);
    }
    .nav-tab span {
      position: relative;
      z-index: 1;
    }
    .nav-tab:hover {
      color: #ffffff;
      transform: translateY(-1px);
    }
    .nav-tab.active {
      background: radial-gradient(circle at top, var(--accent-1), rgba(40, 56, 128, 0.98));
      color: #ffffff;
      box-shadow: 0 0 14px var(--accent-1);
    }
    .nav-tab.active::before {
      opacity: 1;
      transform: translateX(0);
    }

    .nav-right {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .nav-status-pill {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 10px;
      border-radius: 999px;
      background: rgba(21, 29, 64, 0.88);
      border: 1px solid var(--border-soft);
      font-size: 11px;
      color: var(--text-muted);
    }
    .nav-status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: #f44336;
      box-shadow: 0 0 8px rgba(244, 67, 54, 0.8);
    }
    .nav-status-dot.online {
      background: #4caf50;
      box-shadow: 0 0 8px rgba(76, 175, 80, 0.9);
    }
    .nav-wallet-id {
      max-width: 240px;
      font-size: 11px;
      color: var(--text-muted);
      font-family: "JetBrains Mono", ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    .btn {
      border: 1px solid var(--border-strong);
      background: radial-gradient(circle at top, var(--accent-1), rgba(73, 33, 140, 0.98));
      color: #ffffff;
      font-size: 12px;
      padding: 6px 14px;
      border-radius: 999px;
      cursor: pointer;
      box-shadow: 0 0 12px var(--accent-1);
      transition: transform var(--transition-fast), box-shadow var(--transition-fast), background var(--transition-fast);
    }
    .btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 0 16px var(--accent-2);
    }
    .btn.secondary {
      background: rgba(16, 21, 54, 0.96);
      box-shadow: none;
    }
    .btn.small {
      font-size: 11px;
      padding: 4px 10px;
    }

    /* =========================
        MAIN GRID (BINANCE LAYOUT)
    ========================== */
    .main-layout {
      flex: 1;
      display: grid;
      grid-template-columns: 280px 1.8fr 280px;
      grid-template-rows: auto 1fr; /* Row 1 for HUD, Row 2 for content */
      gap: 10px;
      padding: 10px 12px 12px 12px;
      min-height: 0; /* Fix for flexbox overflow */
    }

    /* Top row: cosmic HUD / pair info */
    .hud-strip {
      grid-column: 1 / 4; /* Span all 3 columns */
      display: grid;
      /* NEW: 6 columns for futures data */
      grid-template-columns: 1.2fr repeat(5, 1fr);
      gap: 8px;
      padding: 6px 8px;
      border-radius: var(--radius-lg);
      background:
        radial-gradient(circle at top left, rgba(104, 146, 255, 0.6), transparent 60%),
        linear-gradient(120deg, rgba(11, 15, 40, 0.98), rgba(7, 10, 30, 0.98));
      border: 1px solid var(--border-soft);
      box-shadow: 0 0 20px rgba(0, 0, 0, 0.9);
    }
    [data-theme="holographic"] .hud-strip {
      background: var(--bg-panel);
      backdrop-filter: blur(5px);
    }
    .hud-block {
      display: flex;
      flex-direction: column;
      justify-content: center;
    }
    /* NEW: Hide/show blocks based on mode */
    .hud-block.futures-only { display: none; }
    .hud-block.spot-only { display: flex; }

    .hud-label {
      font-size: 11px;
      color: var(--text-muted);
    }
    .hud-value {
      font-size: 15px;
      font-weight: 600;
    }
    .hud-value.green {
      color: var(--success);
    }
    .hud-value.red {
      color: var(--danger);
    }
    .hud-value.small {
      font-size: 13px;
    }

    /* =========================
        PANEL BASE
    ========================== */
    .panel {
      border-radius: var(--radius-lg);
      background: var(--bg-panel);
      border: 1px solid var(--border-soft);
      box-shadow: var(--shadow-soft);
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }
    .panel-header {
      padding: 8px 10px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      border-bottom: 1px solid rgba(255, 255, 255, 0.04);
      background: linear-gradient(120deg, rgba(24, 30, 75, 0.96), rgba(14, 16, 44, 0.98));
      flex-shrink: 0; /* Prevent header from shrinking */
    }
    [data-theme="holographic"] .panel-header {
      background: rgba(0, 255, 255, 0.1);
    }
    .panel-title {
      font-size: 13px;
      font-weight: 600;
      letter-spacing: 0.04em;
    }
    .panel-actions {
      display: flex;
      align-items: center;
      gap: 4px;
    }
    .icon-btn {
      width: 22px;
      height: 22px;
      border-radius: 50%;
      border: none;
      background: rgba(24, 28, 65, 0.95);
      color: var(--text-muted);
      font-size: 12px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: background var(--transition-fast), transform var(--transition-fast), color var(--transition-fast);
    }
    .icon-btn:hover {
      background: var(--accent-1);
      color: #ffffff;
      transform: translateY(-1px);
    }

    /* =========================
        COLUMN LAYOUTS
    ========================== */
    /* Col 1: Orderbook */
    .orderbook-panel {
      grid-column: 1 / 2;
      grid-row: 2 / 3;
      min-height: 0;
    }
    /* Col 2: Center (Chart, Trade, Positions) */
    .center-column-layout {
      grid-column: 2 / 3;
      grid-row: 2 / 3;
      display: flex;
      flex-direction: column;
      gap: 8px;
      min-height: 0;
      position: relative; /* For drawing tools */
    }
    /* Col 3: Right (Markets, Trades) */
    .right-column-layout {
      grid-column: 3 / 4;
      grid-row: 2 / 3;
      display: flex;
      flex-direction: column;
      gap: 8px;
      min-height: 0;
    }
    
    
    /* =========================
        LEFT COL: ORDERBOOK
    ========================== */
    .orderbook-sides {
      flex: 1; /* Fill the panel */
      display: grid;
      grid-template-rows: 1fr auto 1fr; /* 50% asks, mid, 50% bids */
    }
    .order-side {
      padding: 4px 6px;
      font-size: 11px;
      overflow-y: auto;
    }
    .order-side.asks {
      background: radial-gradient(circle at top, rgba(255, 75, 125, 0.3), transparent 60%);
    }
    .order-side.bids {
      background: radial-gradient(circle at bottom, rgba(76, 175, 80, 0.3), transparent 60%);
    }
    [data-theme="holographic"] .order-side.asks {
      background: linear-gradient(to top, transparent, rgba(255, 0, 0, 0.25));
    }
    [data-theme="holographic"] .order-side.bids {
      background: linear-gradient(to bottom, transparent, rgba(0, 255, 0, 0.25));
    }
    .order-head-row {
      display: grid;
      grid-template-columns: 1.2fr 1fr 1.1fr;
      font-size: 10px;
      color: var(--text-muted);
      margin-bottom: 3px;
    }
    .order-row {
      position: relative;
      display: grid;
      grid-template-columns: 1.2fr 1fr 1.1fr;
      padding: 1px 2px;
    }
    .order-row span {
      padding: 0 2px;
    }
    /* Depth background for order rows */
    .order-row::before {
      content: "";
      position: absolute;
      top: 1px;
      bottom: 1px;
      right: 0; /* Align to right */
      width: var(--depth, 0%); /* Use CSS var for depth */
      z-index: 0;
      opacity: 0.3;
      transition: width 0.1s linear;
    }
    .order-row span {
        position: relative; /* Ensure text is above background */
        z-index: 1;
    }
    .order-row.ask::before {
      background: var(--danger);
    }
    .order-row.bid::before {
      background: var(--success);
    }
    .order-mid {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 4px;
      font-size: 13px;
      font-weight: 600;
      border-top: 1px solid rgba(255, 255, 255, 0.06);
      border-bottom: 1px solid rgba(255, 255, 255, 0.06);
      background: radial-gradient(circle, rgba(110, 150, 255, 0.5), rgba(10, 16, 36, 0.96));
    }

    /* =========================
        CENTER COL: CHART
    ========================== */
    /* REMOVED: .mode-tabs, now controlled by main nav */
    
    .chart-panel {
      border-radius: var(--radius-lg);
      border: 1px solid var(--border-soft);
      background:
        radial-gradient(circle at top, rgba(120, 160, 255, 0.1), transparent 60%),
        rgba(8, 10, 30, 0.98);
      padding: 6px 8px;
      display: flex;
      flex-direction: column;
      gap: 4px;
      flex: 1; /* Make chart panel fill remaining space */
      min-height: 350px; /* Ensure it has a minimum height */
    }
    [data-theme="holographic"] .chart-panel {
      background: transparent;
    }
    .chart-toolbar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 11px;
      gap: 6px;
      flex-wrap: wrap;
    }
    .chart-modes {
      display: inline-flex;
      gap: 4px;
      flex-wrap: wrap;
    }
    .chart-mode-btn {
      border-radius: 999px;
      border: none;
      background: rgba(19, 24, 52, 0.96);
      color: var(--text-muted);
      padding: 3px 8px;
      font-size: 10px;
      cursor: pointer;
      transition: background var(--transition-fast), color var(--transition-fast), transform var(--transition-fast);
    }
    [data-theme="holographic"] .chart-mode-btn {
      background: rgba(0, 255, 255, 0.1);
    }
    .chart-mode-btn.active {
      background: linear-gradient(135deg, var(--accent-1), var(--accent-2));
      color: #ffffff;
      transform: translateY(-1px);
      box-shadow: 0 0 10px var(--accent-1);
    }
    .chart-controls {
      display: flex;
      align-items: center;
      gap: 6px;
      flex-wrap: wrap;
      position: relative; /* For indicators popover */
    }
    .chart-type-switch {
      display: inline-flex;
      border-radius: 999px;
      border: 1px solid var(--border-soft);
      overflow: hidden;
      background: rgba(10, 13, 40, 0.96);
    }
    [data-theme="holographic"] .chart-type-switch {
      background: rgba(0, 255, 255, 0.1);
    }
    .chart-type-btn {
      border: none;
      padding: 3px 8px;
      font-size: 10px;
      color: var(--text-muted);
      background: transparent;
      cursor: pointer;
      transition: background var(--transition-fast), color var(--transition-fast), transform var(--transition-fast);
    }
    .chart-type-btn.active {
      background: radial-gradient(circle at top, var(--accent-1), rgba(70, 90, 160, 0.98));
      color: #ffffff;
      transform: translateY(-1px);
      box-shadow: 0 0 8px var(--accent-1);
    }
    
    /* NEW: Indicators Button */
    .chart-indicators-btn {
      border-radius: 999px;
      border: 1px solid var(--border-soft);
      background: rgba(16, 20, 52, 0.96);
      padding: 3px 8px;
      font-size: 10px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 4px;
      color: var(--text-muted);
      transition: background var(--transition-fast), color var(--transition-fast), transform var(--transition-fast);
    }
    .chart-indicators-btn:hover {
      background: var(--accent-1);
      color: #ffffff;
      transform: translateY(-1px);
      box-shadow: 0 0 10px var(--accent-1);
    }
    
    /* NEW: Indicators Popover */
    #indicators-panel {
      display: none;
      position: absolute;
      right: 0;
      top: 100%;
      margin-top: 4px;
      background: rgba(18, 22, 58, 0.98);
      border: 1px solid var(--border-strong);
      border-radius: var(--radius-md);
      padding: 8px;
      z-index: 20;
      box-shadow: 0 4px 20px rgba(0,0,0,0.6);
      backdrop-filter: blur(5px);
      font-size: 11px;
      width: 160px;
    }
    #indicators-panel.active {
      display: block;
    }
    #indicators-panel label {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 4px;
      cursor: pointer;
      border-radius: var(--radius-sm);
    }
    #indicators-panel label:hover {
      background: rgba(110, 130, 255, 0.1);
    }
    
    .chart-settings-toggle {
      border-radius: 999px;
      border: 1px solid var(--border-soft);
      background: rgba(16, 20, 52, 0.96);
      padding: 3px 8px;
      font-size: 10px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 4px;
      color: var(--text-muted);
      transition: background var(--transition-fast), color var(--transition-fast), transform var(--transition-fast);
    }
    .chart-settings-toggle:hover {
      background: var(--accent-1);
      color: #ffffff;
      transform: translateY(-1px);
      box-shadow: 0 0 10px var(--accent-1);
    }
    .chart-settings-panel {
      margin-top: 4px;
      border-radius: var(--radius-md);
      border: 1px solid var(--border-strong);
      background: rgba(5, 8, 26, 0.98);
      padding: 6px 8px;
      font-size: 10px;
      display: none;
      gap: 8px;
      flex-wrap: wrap;
    }
    .chart-settings-panel.active {
      display: flex;
    }
    .chart-settings-group {
      display: flex;
      flex-direction: column;
      gap: 3px;
      min-width: 120px;
    }
    .chart-settings-label {
      color: var(--text-muted);
    }
    .chart-settings-row {
      display: flex;
      align-items: center;
      gap: 4px;
    }
    .chart-settings-row input[type="color"] {
      width: 34px;
      height: 18px;
      padding: 0;
      border-radius: 4px;
      border: 1px solid var(--border-strong);
      background: transparent;
      cursor: pointer;
    }
    .chart-settings-row input[type="checkbox"] {
      cursor: pointer;
    }
    
    /* NEW: Chart Canvas Layout */
    .chart-canvas {
      width: 100%;
      height: 100%; /* Fill parent chart-panel */
      border-radius: var(--radius-md);
      background:
        linear-gradient(180deg, rgba(21, 28, 68, 0.95), rgba(5, 6, 20, 0.98));
      position: relative;
      overflow: hidden;
      /* NEW: Split layout for sub-charts */
      display: flex;
      flex-direction: column;
    }
    .chart-price-wrapper {
      flex: 3;
      position: relative;
      min-height: 150px;
    }
    .chart-sub-wrapper {
      flex: 1;
      position: relative;
      min-height: 50px;
      border-top: 1px solid var(--border-soft);
    }
    
    [data-theme="holographic"] .chart-canvas {
      background: linear-gradient(180deg, rgba(10, 30, 45, 0.95), rgba(5, 10, 20, 0.98));
    }
    .chart-ohlc-row {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      font-size: 10px;
      color: var(--text-muted);
      margin-top: 4px;
      padding: 2px 0;
    }
    .chart-ohlc-row span {
      min-width: 80px;
    }
    .chart-ohlc-row .up {
      color: var(--success);
    }
    .chart-ohlc-row .down {
      color: var(--danger);
    }
    .chart-grid {
      position: absolute;
      inset: 0;
      background-image:
        linear-gradient(to right, rgba(255, 255, 255, 0.06) 1px, transparent 1px),
        linear-gradient(to top, rgba(255, 255, 255, 0.04) 1px, transparent 1px);
      background-size: 40px 30px;
      opacity: 0.3;
      pointer-events: none;
    }
    [data-theme="holographic"] .chart-grid {
      background-image:
        linear-gradient(to right, var(--border-soft) 1px, transparent 1px),
        linear-gradient(to top, var(--border-soft) 1px, transparent 1px);
      opacity: 0.15;
      animation: holographic-grid 10s linear infinite;
    }
    @keyframes holographic-grid {
      0% { background-position: 0 0; }
      100% { background-position: 40px 30px; }
    }
    .chart-line-bg {
      position: absolute;
      inset: 0;
      background: linear-gradient(120deg, var(--accent-3), var(--accent-1));
      opacity: 0.12;
      filter: blur(18px);
      transform-origin: left center;
      animation: chartWave 9s ease-in-out infinite alternate;
      pointer-events: none;
    }
    
    /* NEW: Canvas positioning */
    .chart-canvas canvas {
      position: absolute;
      inset: 0;
      width: 100%;
      height: 100%;
      display: block;
      cursor: crosshair;
    }
    /* Drawing canvas, on top of price chart but below UI */
    .chart-canvas canvas#draw-canvas {
        z-index: 1; /* Above price, below UI */
        pointer-events: none; /* Interact via main canvas */
    }
    .chart-canvas canvas.y-axis-grabbing {
      cursor: ns-resize;
    }
    @keyframes chartWave {
      0%   { transform: scaleY(0.8) translateY(5px); }
      50%  { transform: scaleY(1.05) translateY(-3px); }
      100% { transform: scaleY(0.9) translateY(3px); }
    }

    /* =========================
        CENTER COL: TRADE FORM
    ========================== */
    .trade-panel {
      display: flex;
      flex-direction: column;
      /* MODIFIED: Make panel flexible */
      flex: 0.8;
      min-height: 250px;
    }
    .trade-toggle {
      display: inline-flex;
      gap: 4px;
      margin: 6px 8px 4px 8px;
      padding: 2px;
      border-radius: 999px;
      border: 1px solid var(--border-soft);
      background: rgba(11, 14, 34, 0.98);
    }
    .trade-side-btn {
      border-radius: 999px;
      border: none;
      padding: 4px 10px;
      font-size: 11px;
      background: transparent;
      color: var(--text-muted);
      cursor: pointer;
      transition: background var(--transition-fast), color var(--transition-fast), transform var(--transition-fast);
    }
    .trade-side-btn.active.buy {
      background: linear-gradient(135deg, var(--success), #87e37a);
      color: #ffffff;
      transform: translateY(-1px);
      box-shadow: 0 0 10px var(--success);
    }
    .trade-side-btn.active.sell {
      background: linear-gradient(135deg, var(--danger), #ff8a65);
      color: #ffffff;
      transform: translateY(-1px);
      box-shadow: 0 0 10px var(--danger);
    }
    .trade-form {
      padding: 4px 8px 8px 8px;
      display: flex;
      flex-direction: column;
      gap: 6px;
      font-size: 11px;
    }
    .form-row {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }
    /* Hideable form row */
    .form-row.hideable {
        display: none; /* Hidden by default */
    }
    /* NEW: Hide/show based on mode */
    .form-row.futures-only { display: none; }
    .form-row.spot-only { display: flex; }

    .form-row label {
      color: var(--text-muted);
      padding-left: 2px;
      font-weight: 500;
      text-transform: uppercase;
      letter-spacing: 0.02em;
    }
    .input-shell {
      display: flex;
      align-items: center;
      border-radius: var(--radius-md);
      border: 1px solid var(--border-soft);
      background: rgba(5, 7, 23, 0.98);
      overflow: hidden;
      transition: border-color var(--transition-fast), box-shadow var(--transition-fast);
    }
    .input-shell:hover {
      border-color: var(--border-strong);
    }
    .input-shell:focus-within {
      border-color: var(--accent-2);
      box-shadow: 0 0 8px var(--accent-2);
    }
    .input-shell input,
    .input-shell select {
      flex: 1;
      padding: 6px 10px;
      border: none;
      outline: none;
      background: transparent;
      color: var(--text-main);
      font-size: 13px;
      font-family: "JetBrains Mono", ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    }
    /* Style for disabled inputs */
    .input-shell input:disabled {
        background: rgba(40, 50, 80, 0.2);
        color: var(--text-muted);
    }
    .input-shell span.suffix {
      padding: 0 8px;
      border-left: 1px solid rgba(255, 255, 255, 0.06);
      font-size: 10px;
      color: var(--text-muted);
    }
    .quick-row {
      display: flex;
      gap: 4px;
    }
    .quick-btn {
      flex: 1;
      border-radius: 999px;
      border: 1px solid var(--border-soft);
      background: transparent;
      color: var(--text-muted);
      font-size: 10px;
      padding: 4px 0;
      cursor: pointer;
      transition: background var(--transition-fast), color var(--transition-fast);
    }
    .quick-btn:hover {
      background: radial-gradient(circle at top, var(--accent-1), rgba(54, 65, 137, 0.95));
      color: #ffffff;
    }
    .fee-row {
      font-size: 10px;
      color: var(--text-muted);
    }
    .trade-submit-btn {
      margin-top: 2px;
      border-radius: var(--radius-md);
      border: none;
      padding: 6px 0;
      font-size: 12px;
      cursor: pointer;
      background: linear-gradient(135deg, var(--success), #9ccc65);
      color: #ffffff;
      box-shadow: 0 0 12px var(--success);
      transition: transform var(--transition-fast), box-shadow var(--transition-fast);
    }
    .trade-submit-btn.sell {
      background: linear-gradient(135deg, var(--danger), #ff8a65);
      box-shadow: 0 0 12px var(--danger);
    }
    .trade-submit-btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 0 14px rgba(255, 255, 255, 0.7);
    }
    /* SL/TP Row for Futures */
    .futures-sl-tp-row {
        display: none; /* Hidden by default */
        gap: 6px;
    }

    /* NEW: Leverage Dropdown Styles */
    .leverage-dropdown-btn {
      border-radius: var(--radius-md);
      border: 1px solid var(--border-soft);
      background: rgba(5, 7, 23, 0.98);
      color: var(--text-main);
      font-size: 13px;
      padding: 6px 10px;
      cursor: pointer;
      text-align: left;
      width: 100%;
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-family: "JetBrains Mono", monospace;
    }
    .leverage-dropdown-btn:hover {
      border-color: var(--border-strong);
    }
    .leverage-popover {
      display: none;
      position: absolute;
      bottom: 100%; /* Show above the button */
      left: 0;
      right: 0;
      background: rgba(18, 22, 58, 0.98);
      border: 1px solid var(--border-strong);
      border-radius: var(--radius-md);
      padding: 8px;
      z-index: 20;
      box-shadow: 0 -4px 20px rgba(0,0,0,0.6);
      backdrop-filter: blur(5px);
    }
    .leverage-popover.active {
      display: block;
    }
    .leverage-quick-btns {
      display: flex;
      gap: 4px;
      margin-bottom: 8px;
    }
    .leverage-quick-btn {
      flex: 1;
      border-radius: 999px;
      border: 1px solid var(--border-soft);
      background: transparent;
      color: var(--text-muted);
      font-size: 10px;
      padding: 4px 0;
      cursor: pointer;
      transition: background var(--transition-fast), color var(--transition-fast);
    }
    .leverage-quick-btn:hover {
      background: radial-gradient(circle at top, var(--accent-1), rgba(54, 65, 137, 0.95));
      color: #ffffff;
    }
    .leverage-popover label {
      font-size: 11px;
      color: var(--text-muted);
    }


    /* Digital Metals section (inside trade panel) */
    .metals-grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(140px, 1fr));
      gap: 8px;
      padding: 8px;
    }
    .metal-card {
      border-radius: var(--radius-md);
      border: 1px solid var(--border-soft);
      background:
        radial-gradient(circle at top, rgba(150, 134, 255, 0.3), transparent 60%),
        rgba(10, 13, 38, 0.98);
      padding: 6px 8px;
      display: flex;
      flex-direction: column;
      gap: 4px;
      box-shadow: 0 0 14px rgba(0, 0, 0, 0.7);
    }
    .metal-name {
      font-size: 12px;
      font-weight: 600;
    }
    .metal-tagline {
      font-size: 10px;
      color: var(--text-muted);
    }
    .metal-price {
      font-size: 11px;
      color: var(--accent-2);
    }
    .metal-badge-row {
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
      font-size: 10px;
    }
    .metal-badge {
      border-radius: 999px;
      padding: 2px 6px;
      background: rgba(8, 14, 40, 0.96);
      border: 1px solid var(--border-soft);
    }
    .metal-footer-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 4px;
    }
    .btn-metal-buy {
      border: none;
      border-radius: 999px;
      padding: 4px 10px;
      font-size: 11px;
      cursor: pointer;
      background: linear-gradient(135deg, var(--accent-1), var(--accent-2));
      color: #ffffff;
      box-shadow: 0 0 10px var(--accent-2);
      transition: transform var(--transition-fast), box-shadow var(--transition-fast);
    }
    .btn-metal-buy:hover {
      transform: translateY(-1px);
      box-shadow: 0 0 12px var(--accent-1);
    }

    /* =========================
        CENTER COL: POSITIONS
    ========================== */
    .positions-panel {
      /* MODIFIED: Make panel flexible */
      flex: 0.7;
      min-height: 150px; /* Min height */
    }
    .positions-table-wrapper {
      flex: 1;
      overflow-y: auto;
    }
    table.positions-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 11px;
    }
    table.positions-table thead {
      background: rgba(20, 25, 60, 0.98);
    }
    [data-theme="holographic"] table.positions-table thead {
      background: rgba(0, 255, 255, 0.1);
    }
    table.positions-table th,
    table.positions-table td {
      padding: 4px 6px;
      text-align: left;
    }
    .tag {
      font-size: 10px;
      padding: 2px 6px;
      border-radius: 999px;
      background: rgba(13, 21, 53, 0.96);
      border: 1px solid var(--border-soft);
      color: var(--text-muted);
    }
    .tag.long {
      color: var(--success);
      border-color: var(--success);
    }
    .tag.short {
      color: var(--danger);
      border-color: var(--danger);
    }

    /* =========================
        RIGHT COL: MARKETS
    ========================== */
    .market-panel {
      flex: 1.5; /* Give more space than trades */
      min-height: 200px;
    }
    .market-search {
      padding: 6px 10px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.04);
    }
    .market-search input {
      width: 100%;
      padding: 6px 8px;
      border-radius: var(--radius-md);
      border: 1px solid var(--border-soft);
      background: rgba(5, 7, 24, 0.98);
      color: var(--text-main);
      font-size: 12px;
      outline: none;
    }
    .market-tabs {
      display: flex;
      gap: 4px;
      padding: 4px 6px 6px 6px;
    }
    .market-tab {
      flex: 1;
      border-radius: 999px;
      border: 1px solid transparent;
      background: rgba(11, 15, 44, 0.96);
      color: var(--text-muted);
      font-size: 11px;
      padding: 3px 4px;
      cursor: pointer;
      transition: border var(--transition-fast), background var(--transition-fast), color var(--transition-fast);
    }
    .market-tab.active {
      border-color: var(--border-strong);
      background: radial-gradient(circle at top, var(--accent-1), rgba(45, 55, 122, 0.98));
      color: #ffffff;
      box-shadow: 0 0 12px var(--accent-1);
    }
    .market-table-wrapper {
      flex: 1;
      overflow-y: auto;
    }
    .market-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 11px;
    }
    .market-table thead {
      background: rgba(15, 20, 54, 0.98);
      position: sticky;
      top: 0;
      z-index: 1;
    }
    [data-theme="holographic"] .market-table thead {
      background: rgba(0, 255, 255, 0.1);
    }
    .market-table th,
    .market-table td {
      padding: 4px 6px;
      text-align: left;
    }
    .market-table tbody tr {
      cursor: pointer;
      transition: background var(--transition-fast);
    }
    .market-table tbody tr:nth-child(even) {
      background: rgba(10, 12, 32, 0.96);
    }
    [data-theme="holographic"] .market-table tbody tr:nth-child(even) {
      background: rgba(0, 255, 255, 0.03);
    }
    .market-table tbody tr:hover {
      background: radial-gradient(circle at left, var(--accent-1), rgba(17, 22, 55, 0.98));
    }
    .change-up {
      color: var(--success);
    }
    .change-down {
      color: var(--danger);
    }

    /* =========================
        RIGHT COL: RECENT TRADES
    ========================== */
    .trades-panel {
      pointer-events: auto;
      border-radius: var(--radius-lg);
      background: var(--bg-panel);
      border: 1px solid var(--border-soft);
      box-shadow: var(--shadow-soft);
      display: flex;
      flex-direction: column;
      overflow: hidden;
      flex: 1; /* Take remaining space */
      min-height: 150px;
    }
    .bottom-panel-header { /* Renamed from .bottom-panel-header */
      padding: 6px 8px;
      font-size: 12px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.05);
      background: linear-gradient(120deg, rgba(25, 31, 76, 0.96), rgba(10, 12, 36, 0.98));
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    [data-theme="holographic"] .bottom-panel-header {
      background: rgba(0, 255, 255, 0.1);
    }
    .bottom-panel-body { /* Renamed from .bottom-panel-body */
      flex: 1;
      overflow-y: auto;
    }
    table.trades-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 11px;
    }
    table.trades-table th,
    table.trades-table td {
      padding: 4px 6px;
      text-align: left;
    }
    table.trades-table thead {
      background: rgba(19, 24, 64, 0.98);
    }
    [data-theme="holographic"] table.trades-table thead {
      background: rgba(0, 255, 255, 0.1);
    }
    .buy-text {
      color: var(--success);
    }
    .sell-text {
      color: var(--danger);
    }

    /* =========================
        NEW: RIGHT COL: TOKEN INFO
    ========================== */
    .token-info-panel {
      flex: 1.2; /* Give it space */
      min-height: 200px;
    }
    .token-info-header {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 10px;
    }
    .token-info-logo {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background: var(--accent-1);
    }
    .token-info-title-wrap {
      display: flex;
      flex-direction: column;
    }
    .token-info-title {
      font-size: 16px;
      font-weight: 600;
    }
    .token-info-symbol {
      font-size: 11px;
      color: var(--text-muted);
    }
    .token-info-body {
      padding: 4px 10px 10px;
      font-size: 11px;
      color: var(--text-muted);
      flex: 1;
      overflow-y: auto;
    }
    .token-info-description {
      margin-bottom: 10px;
      line-height: 1.5;
    }
    .token-info-metrics {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 8px;
    }
    .token-info-metric {
      display: flex;
      flex-direction: column;
      gap: 2px;
      background: rgba(5, 7, 24, 0.98);
      border-radius: var(--radius-sm);
      padding: 5px 8px;
      border: 1px solid var(--border-soft);
    }
    .token-info-metric-label {
      font-size: 10px;
      color: var(--text-muted);
      text-transform: uppercase;
    }
    .token-info-metric-value {
      font-size: 12px;
      color: var(--text-main);
      font-family: "JetBrains Mono", monospace;
    }


    /* =========================
        MODALS
    ========================== */
    /* REMOVED: Wallet Modal */

    /* Toasts */
    .toast-container {
      position: fixed;
      right: 16px;
      top: calc(var(--nav-h) + 16px);
      bottom: auto; 
      display: flex;
      flex-direction: column;
      gap: 6px;
      z-index: 30;
    }
    .toast {
      min-width: 220px;
      max-width: 320px;
      border-radius: var(--radius-md);
      background: rgba(10, 12, 34, 0.98);
      border: 1px solid var(--border-strong);
      box-shadow: var(--shadow-soft);
      padding: 6px 8px;
      font-size: 11px;
    }
    .toast-title {
      font-weight: 600;
      margin-bottom: 2px;
    }
    .toast-msg {
      color: var(--text-muted);
    }
    .toast.success {
      border-color: var(--success);
    }
    .toast.error {
      border-color: var(--danger);
    }
    .toast.info {
      border-color: var(--accent-2);
    }

    /* =========================
        NEW: FUTURES/METALS PLACEHOLDER
    ========================== */
    .placeholder-page {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      text-align: center;
      flex: 1;
      padding: 40px;
      gap: 12px;
    }
    .placeholder-title {
      font-size: 24px;
      font-weight: 600;
      color: var(--text-main);
    }
    .placeholder-sub {
      font-size: 16px;
      color: var(--text-muted);
      max-width: 400px;
    }

    /* =========================
        REMOVED: HOLOGRAPHIC METALS VAULT
    ========================== */

    /* =========================
        NEW: QUICK ACTIONS HUD
    ========================== */
    #quick-actions-hud {
      position: fixed;
      display: none;
      flex-direction: column;
      gap: 4px;
      background: rgba(10, 15, 40, 0.9);
      border: 1px solid var(--border-strong);
      border-radius: var(--radius-md);
      padding: 6px;
      z-index: 100;
      backdrop-filter: blur(5px);
      box-shadow: 0 0 20px rgba(0,0,0,0.5);
    }
    .quick-action-btn {
      border: none;
      background: rgba(30, 40, 80, 0.8);
      color: var(--text-main);
      padding: 6px 10px;
      border-radius: var(--radius-sm);
      font-size: 12px;
      cursor: pointer;
      text-align: left;
      transition: background var(--transition-fast);
    }
    .quick-action-btn:hover {
      background: var(--accent-1);
    }

    /* =========================
        NEW: DRAWING TOOLBAR
    ========================== */
    .chart-drawing-toolbar {
      position: absolute;
      left: 10px;
      top: 100px;
      display: flex;
      flex-direction: column;
      gap: 4px;
      background: rgba(10, 15, 40, 0.9);
      border: 1px solid var(--border-soft);
      border-radius: var(--radius-md);
      padding: 6px;
      z-index: 5;
    }
    .drawing-tool-btn {
      width: 32px;
      height: 32px;
      border: none;
      border-radius: var(--radius-sm);
      background: rgba(30, 40, 80, 0.8);
      color: var(--text-muted);
      cursor: pointer;
      transition: background var(--transition-fast), color var(--transition-fast);
      padding: 6px;
    }
    .drawing-tool-btn:hover {
      background: var(--accent-1);
      color: var(--text-main);
    }
    .drawing-tool-btn.active {
      background: var(--accent-2);
      color: var(--text-main);
      box-shadow: 0 0 8px var(--accent-2);
    }
    .drawing-tool-btn svg {
      width: 100%;
      height: 100%;
      stroke-width: 2;
    }

    /* =========================
        NEW: ORDER ANIMATION
    ========================== */
    .order-animation-line {
      position: fixed;
      width: 2px;
      height: 2px;
      background: var(--success);
      box-shadow: 0 0 5px var(--success), 0 0 10px var(--success);
      border-radius: 50%;
      z-index: 1000;
      transition: transform 0.5s cubic-bezier(0.5, 0, 1, 0.5), opacity 0.3s 0.2s;
      pointer-events: none;
    }
    
    /* REMOVED: Quick Wallet Panel CSS */

    /* REMOVED: Wallet Page CSS */

    /* =========================
        RESPONSIVE
    ========================== */
    @media (max-width: 1180px) {
      .main-layout {
        /* Switch to 2-col layout */
        grid-template-columns: 1.5fr 1fr;
        grid-template-rows: auto auto 1fr;
      }
      .hud-strip {
        grid-column: 1 / 3;
      }
      .orderbook-panel {
        grid-column: 1 / 2;
        grid-row: 2 / 3;
      }
      .right-column-layout { /* Markets/Trades */
        grid-column: 2 / 3;
        grid-row: 2 / 4; /* Span 2 rows */
      }
      .center-column-layout { /* Chart/Trade/Positions */
        grid-column: 1 / 2;
        grid-row: 3 / 4;
      }
    }
    @media (max-width: 900px) {
      body {
        overflow-y: auto;
      }
      .main-layout {
        display: flex;
        flex-direction: column;
        height: auto;
        padding-bottom: 12px;
      }
      /* All panels stack vertically */
    }
    @media (max-width: 720px) {
      .top-nav {
        flex-wrap: wrap;
        gap: 6px;
        height: auto;
        padding-bottom: 8px;
      }
      .nav-main-menu {
        width: 100%;
        justify-content: center;
        flex-wrap: wrap;
      }
      .nav-right {
        width: 100%;
        justify-content: flex-end;
      }
      .hud-strip {
        /* 6-col to 2-col */
        grid-template-columns: repeat(2, minmax(0, 1fr));
        grid-auto-rows: auto;
      }
    }

  </style>
</head>
<body data-theme="night"> <!-- Default theme -->
  <!-- COSMIC BACKGROUND -->
  <div class="cosmic-bg">
    <div class="cosmic-layer"></div>
    <div class="starfield"></div>
  </div>

  <!-- APP ROOT -->
  <div id="app-root">
    
    <!-- NEW: DEMO MODE BANNER -->
    <div id="demo-mode-banner">
      Demo Mode: Trading with simulated funds
    </div>
    
    <!-- TOP NAVBAR -->
    <header class="top-nav">
      <div class="nav-logo-area">
        <div class="nav-logo-orca">
          <!-- NEW: SVG Dolphin -->
          <svg viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
            <path d="M 85.7,35.9 C 75.1,28.2 62.4,30.7 54.7,41.3 C 51.5,45.7 49.3,50.7 48.1,55.9 C 43,49.1 36.5,44.2 28.5,41.7 C 19.3,38.8 9.9,40.1 2.5,46.1 C 1.8,46.6 1.3,47.3 1,48.1 C 0.7,48.9 0.7,49.9 1,50.8 C 2.5,55.5 5.5,59.3 9.4,61.9 C 13.5,64.6 18.2,65.8 22.9,65.2 C 29.5,64.5 35.5,61.4 39.8,56.6 C 40.5,55.7 41,54.7 41.3,53.6 C 41.6,52.5 41.6,51.3 41.3,50.2 C 40.8,48.3 40.1,46.5 39.2,44.8 C 42.1,47.9 44.3,51.5 45.7,55.5 C 46.8,58.7 48,61.7 49.4,64.5 C 50.8,67.3 52.4,69.9 54.3,72.2 C 60.5,79.5 70.3,83.1 80.3,81.3 C 88.5,79.8 95.5,74.5 98.8,66.9 C 100.1,64 100.5,60.9 100,57.9 C 99.5,54.8 98.1,51.9 96.1,49.5 C 92.5,45.2 87.7,42 82.3,40.2 C 86.1,39.3 89.5,37.3 85.7,35.9 Z"/>
          </svg>
        </div>
        <div class="nav-logo-text">
          <span class="nav-logo-title">AYNU CEX</span>
        </div>
        <nav class="nav-main-menu">
          <!-- data-view attributes for page switching -->
          <!-- 'kyc' tab now opens the wallet connection -->
          <button class="nav-tab" data-view="connect"><span>home</span></button>
          <button class="nav-tab active" data-view="spot"><span>Spot</span></button>
          <button class="nav-tab" data-view="futures"><span>Futures</span></button>
          <!-- REMOVED: Wallet Tab -->
          <button class="nav-tab" data-view="dex"><span>DEX</span></button>
          <button class="nav-tab" data-view="demo"><span>Demo</span></button>
        </nav>
      </div>
      <div class="nav-right">
        <div class="nav-status-pill" id="status-pill">
          <span class="nav-status-dot" id="status-dot"></span>
          <span id="status-text">RPC: Disconnected</span>
        </div>
        <span class="nav-wallet-id" id="wallet-label">Wallet: Not linked</span>
        <!-- MODIFIED: Auth button changed to Aynu Wallet -->
        <button class="btn secondary small" id="btn-connect-wallet">
          Connect Aynu Wallet
        </button>
      </div>
    </header>

    <!-- =========================
        PAGE CONTAINER: SPOT & FUTURES (Unified Layout)
    ========================== -->
    <div class="page-container" id="page-spot"> <!-- This single container handles spot AND futures -->
      <main class="main-layout">
        <!-- HUD STRIP -->
        <section class="hud-strip">
          <div class="hud-block">
            <span class="hud-label" id="hud-pair-label">Pair</span>
            <span class="hud-value" id="hud-pair">AMR / NVR</span>
          </div>
          <div class="hud-block">
            <span class="hud-label" id="hud-last-label">Last Price (NVR)</span>
            <span class="hud-value" id="hud-last">...</span>
          </div>
          <!-- Spot Only -->
          <div class="hud-block spot-only">
            <span class="hud-label">24h Change</span>
            <span class="hud-value green" id="hud-change">+0.00%</span>
          </div>
          <div class="hud-block spot-only">
            <span class="hud-label">24h High</span>
            <span class="hud-value small" id="hud-high">...</span>
          </div>
          <div class="hud-block spot-only">
            <span class="hud-label">24h Low</span>
            <span class="hud-value small" id="hud-low">...</span>
          </div>
          <!-- Futures Only -->
          <div class="hud-block futures-only">
            <span class="hud-label">Open Interest</span>
            <span class="hud-value small" id="hud-oi">$0.00</span>
          </div>
          <div class="hud-block futures-only">
            <span class="hud-label">Funding / Countdown</span>
            <span class="hud-value small green" id="hud-funding">+0.001% / 07:55:10</span>
          </div>
        </section>

        <!-- Col 1: Orderbook -->
        <div class="panel orderbook-panel">
          <div class="panel-header">
            <span class="panel-title" id="orderbook-title">Spot Orderbook</span>
            <div class="panel-actions">
              <button class="icon-btn" id="btn-depth-chart" title="3D Depth Map">⧉</button>
              <button class="icon-btn" id="btn-sync-orderbook" title="Resync">⟳</button>
            </div>
          </div>
          <div class="orderbook-sides">
            <div class="order-side asks">
              <div class="order-head-row">
                <span>Price</span>
                <span>Amount</span>
                <span>Total</span>
              </div>
              <div id="asks-body"></div>
            </div>
            <div class="order-mid">
              <span id="mid-price">...</span>
              <span style="font-size:10px;color:var(--text-muted)">NVR</span>
            </div>
            <div class="order-side bids">
              <div class="order-head-row">
                <span>Price</span>
                <span>Amount</span>
                <span>Total</span>
              </div>
              <div id="bids-body"></div>
            </div>
          </div>
        </div>
        
        <!-- Col 2: Chart, Trade, Positions -->
        <section class="center-column-layout">
          <!-- Drawing Toolbar -->
          <div class="chart-drawing-toolbar" id="drawing-toolbar">
            <button class="drawing-tool-btn active" data-tool="crosshair" title="Crosshair">
              <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4"></path></svg>
            </button>
            <button class="drawing-tool-btn" data-tool="trendline" title="Trend Line">
              <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M4.5 19.5l15-15m-15 0l15 15"></path></svg>
            </button>
            <button class="drawing-tool-btn" data-tool="horizontal" title="Horizontal Line">
              <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M4 12h16"></path></svg>
            </button>
            <button class="drawing-tool-btn" data-tool="fibo" title="Fibonacci">
              <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M4 4h16M4 8h16M4 12h10M4 16h6"></path></svg>
            </button>
             <button class="drawing-tool-btn" data-tool="rect" title="Rectangle">
              <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><rect x="4" y="6" width="16" height="12"></rect></svg>
            </button>
             <button class="drawing-tool-btn" data-tool="brush" title="Brush">
              <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.536L16.732 3.732z"></path></svg>
            </button>
          </div>

          <!-- REMOVED: Mode Tabs -->
          
          <div class="panel chart-panel">
              <div class="chart-toolbar">
                <div style="display:flex;flex-direction:column;gap:2px;">
                  <span style="font-size:11px;">Cosmic Price Trace</span>
                  <span style="font-size:10px;color:var(--text-muted);" id="chart-subtitle">
                    Interactive OHLC Chart
                  </span>
                </div>
                <div class="chart-controls">
                  <div class="chart-type-switch">
                    <button class="chart-type-btn active" data-chart-type="candles">Candles</button>
                    <button class="chart-type-btn" data-chart-type="line">Line</button>
                  </div>
                  <div class="chart-modes">
                    <button class="chart-mode-btn active" data-tf="1m">1m</button>
                    <button class="chart-mode-btn" data-tf="15m">15m</button>
                    <button class="chart-mode-btn" data-tf="1h">1h</button>
                    <button class="chart-mode-btn" data-tf="4h">4h</button>
                    <button class="chart-mode-btn" data-tf="1d">1d</button>
                  </div>
                  
                  <!-- NEW: Indicators Button -->
                  <button class="chart-indicators-btn" id="chart-indicators-btn">
                    <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" width="14" height="14"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 12l3-3 3 3 4-4"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 12l3-3 3 3 4-4m-1 1v6m-4-6v6m-4-6v6M3 20h18"></path></svg>
                    Indicators
                  </button>
                  
                  <button class="chart-settings-toggle" id="chart-settings-toggle">
                    ⚙ Chart Style
                  </button>
                  
                  <!-- NEW: Indicators Popover -->
                  <div id="indicators-panel">
                    <label>
                      <input type="checkbox" id="ind-vol" checked />
                      Volume
                    </label>
                    <label>
                      <input type="checkbox" id="ind-rsi" />
                      RSI (coming soon)
                    </label>
                    <label>
                      <input type="checkbox" id="ind-macd" />
                      MACD (coming soon)
                    </label>
                  </div>
                  
                </div>
              </div>
              <div class="chart-ohlc-row" id="chart-ohlc-row"></div>
              <div class="chart-settings-panel" id="chart-settings-panel">
                <div class="chart-settings-group">
                  <span class="chart-settings-label">Candle Colors</span>
                  <div class="chart-settings-row">
                    <span>Up</span>
                    <input type="color" id="candle-up-color" value="#4caf50" />
                    <span>Down</span>
                    <input type="color" id="candle-down-color" value="#ff4b7d" />
                  </div>
                </div>
                <div class="chart-settings-group">
                  <span class="chart-settings-label">Visibility</span>
                  <div class="chart-settings-row">
                    <label><input type="checkbox" id="show-grid" checked /> Grid</label>
                  </div>
                  <div class="chart-settings-row">
                    <label><input type="checkbox" id="show-wicks" checked /> Wicks</label>
                  </div>
                </div>
                <div class="chart-settings-group">
                  <span class="chart-settings-label">Theme</span>
                  <div class="chart-settings-row">
                    <select id="chart-theme" style="font-size:10px;padding:2px 4px;border-radius:6px;border:1px solid rgba(150,176,255,0.9);background:#05071a;color:var(--text-main);">
                      <option value="night">Night (Default)</option>
                      <option value="evening">Evening</option>
                      <option value="holographic">Holographic</option>
                    </select>
                  </div>
                </div>
              </div>
              
              <!-- NEW: Chart Canvas Layout -->
              <div class="chart-canvas">
                <div class="chart-price-wrapper">
                  <div class="chart-grid" id="chart-grid-layer"></div>
                  <div class="chart-line-bg" id="chart-line-bg"></div>
                  <!-- Main price chart canvas -->
                  <canvas id="price-chart"></canvas>
                  <!-- Canvas for drawing orders/positions on top -->
                  <canvas id="draw-canvas"></canvas>
                </div>
                <div class="chart-sub-wrapper">
                  <!-- NEW: Sub-chart for indicators -->
                  <canvas id="sub-chart"></canvas>
                </div>
              </div>
          </div>

          <div class="panel trade-panel">
            <div class="panel-header">
              <span class="panel-title" id="trade-panel-title">Spot Trade – AMR / NVR</span>
              <div class="panel-actions">
                <span class="tag" id="leverage-badge">Cross · 1x</span>
              </div>
            </div>
            
            <!-- NEW: Wrapper for Metals Grid -->
            <div id="metals-wrapper" style="display:none; flex: 1; overflow-y: auto;">
              <div style="padding:6px 8px 2px 8px;font-size:11px;color:var(--text-muted);">
                Buy asset-backed digital metals on AMRChain.
              </div>
              <div class="metals-grid" id="metals-grid">
                <!-- Populated by JS -->
              </div>
            </div>
            
            <!-- NEW: Wrapper for Trade Forms -->
            <div id="trade-forms-wrapper">
              <div class="trade-toggle">
                <button class="trade-side-btn active buy" data-side="buy">Buy</button>
                <button class="trade-side-btn sell" data-side="sell">Sell</button>
              </div>
              
              <!-- NEW: Leverage Dropdown -->
              <div class="form-row futures-only" id="leverage-row" style="padding: 4px 8px; position: relative;">
                <label>Leverage</label>
                <button type="button" class="leverage-dropdown-btn" id="leverage-dropdown-btn">
                  <span id="leverage-display">10x</span> <span>▼</span>
                </button>
                <div class="leverage-popover" id="leverage-popover">
                  <div class="leverage-quick-btns">
                    <button type="button" class="leverage-quick-btn" data-lev="5">5x</button>
                    <button type="button" class="leverage-quick-btn" data-lev="10">10x</button>
                    <button type="button" class="leverage-quick-btn" data-lev="20">20x</button>
                    <button type="button" class="leverage-quick-btn" data-lev="50">50x</button>
                    <button type="button" class="leverage-quick-btn" data-lev="100">100x</button>
                  </div>
                  <label>Custom: <span id="leverage-custom-display">10x</span></label>
                  <input type="range" id="leverage-slider" min="1" max="100" value="10" style="width: 100%;">
                </div>
              </div>
              
              <form class="trade-form" id="trade-form">
                <div class="form-row">
                  <label for="order-type">Order Type</label>
                  <div class="input-shell">
                    <select id="order-type">
                      <option value="limit">Limit</option>
                      <option value="market">Market</option>
                      <option value="stop-limit">Stop Limit</option>
                      <option value="tp-limit">Take Profit Limit</option>
                    </select>
                    <span class="suffix" id="order-type-label">Spot</span>
                  </div>
                </div>
                
                <!-- Stop Price Row -->
                <div class="form-row hideable" id="stop-price-row">
                  <label>Stop Price</label>
                  <div class="input-shell">
                    <input type="number" id="input-stop-price" step="0.00000001" min="0" />
                    <span class="suffix" id="stop-price-quote">NVR</span>
                  </div>
                </div>

                <div class="form-row" id="limit-price-row">
                  <label>Price</label>
                  <div class="input-shell">
                    <input type="number" id="input-price" step="0.00000001" min="0" />
                    <span class="suffix" id="price-quote">NVR</span>
                  </div>
                </div>
                <div class="form-row">
                  <label>Amount</label>
                  <div class="input-shell">
                    <input type="number" id="input-amount" step="0.00000001" min="0" />
                    <span class="suffix" id="amount-base">AMR</span>
                  </div>
                </div>
                <div class="form-row">
                  <label>Total</label>
                  <div class="input-shell">
                    <input type="text" id="input-total" readonly />
                    <span class="suffix" id="total-quote">NVR</span>
                  </div>
                </div>

                <!-- Futures SL/TP Row -->
                <div class="form-row futures-sl-tp-row" id="futures-sl-tp-row">
                    <div class="form-row" style="flex:1;">
                      <label>Take Profit</label>
                      <div class="input-shell">
                        <input type="number" id="input-tp" step="0.00000001" min="0" />
                      </div>
                    </div>
                    <div class="form-row" style="flex:1;">
                      <label>Stop Loss</label>
                      <div class="input-shell">
                        <input type="number" id="input-sl" step="0.00000001" min="0" />
                      </div>
                    </div>
                </div>

                <div class="form-row">
                  <label>Balance (Quote)</label>
                  <div class="input-shell">
                    <input type="text" id="balance-quote" readonly />
                    <span class="suffix" id="balance-quote-symbol">NVR</span>
                  </div>
                </div>
                <div class="form-row">
                  <div class="quick-row">
                    <button type="button" class="quick-btn" data-pct="25">25%</button>
                    <button type="button" class="quick-btn" data-pct="50">50%</button>
                    <button type="button" class="quick-btn" data-pct="75">75%</button>
                    <button type="button" class="quick-btn" data-pct="100">100%</button>
                  </div>
                </div>
                <div class="fee-row">
                  Fee: <span id="fee-rate">0.10%</span> · Est: <span id="fee-estimate">0.00000000</span> NVR
                </div>
                <button class="trade-submit-btn" id="btn-submit-order" type="submit">
                  Connect Wallet to Trade
                </button>
              </form>
            </div>
            
          </div>

          <div class="panel positions-panel">
            <div class="panel-header">
              <span class="panel-title" id="active-panel-title">Open Positions (Futures)</span>
              <div class="panel-actions">
                <button class="icon-btn" id="btn-close-all">⨉</button>
              </div>
            </div>
            <div class="positions-table-wrapper">
              <table class="positions-table">
                <thead id="active-orders-thead">
                  <tr>
                    <th>Pair</th>
                    <th>Side</th>
                    <th>Size</th>
                    <th>Entry</th>
                    <th>PnL</th>
                  </tr>
                </thead>
                <tbody id="active-tbody"></tbody>
              </table>
            </div>
          </div>
        </section>

        <!-- Col 3: Markets, Trades -->
        <section class="right-column-layout">
          <!-- REMOVED: Quick Wallet Panel -->
          
          <!-- NEW: Token Info Panel -->
          <aside class="panel token-info-panel">
            <div class="panel-header">
              <span class="panel-title">Token Info</span>
            </div>
            <div class="token-info-header" id="token-info-header">
              <div class="token-info-logo" id="token-info-logo"></div>
              <div class="token-info-title-wrap">
                <span class="token-info-title" id="token-info-name">...</span>
                <span class="token-info-symbol" id="token-info-symbol">...</span>
              </div>
            </div>
            <div class="token-info-body">
              <p class="token-info-description" id="token-info-desc">
                Loading token information...
              </p>
              <div class="token-info-metrics" id="token-info-metrics">
                <!-- Metrics loaded by JS -->
              </div>
            </div>
          </aside>

          <aside class="panel market-panel">
            <div class="panel-header">
              <span class="panel-title">Markets</span>
              <div class="panel-actions">
                <button class="icon-btn" id="btn-refresh-markets" title="Refresh">⟳</button>
              </div>
            </div>
            <div class="market-search">
              <input type="text" id="market-search-input" placeholder="Search pair (e.g. AMR/NVR)" />
            </div>
            <div class="market-tabs">
              <button class="market-tab active" data-market-tab="all">All</button>
              <button class="market-tab" data-market-tab="amr">AMR</button>
              <button class="market-tab" data-market-tab="nvr">NVR</button>
              <button class="market-tab" data-market-tab="ionx">IONX</button>
              <button class="market-tab" data-market-tab="fav">★</button>
            </div>
            <div class="market-table-wrapper">
              <table class="market-table">
                <thead>
                  <tr>
                    <th>Pair</th>
                    <th>Last</th>
                    <th>24h%</th>
                    <th>Vol</th>
                  </tr>
                </thead>
                <tbody id="market-body"></tbody>
              </table>
            </div>
          </aside>

          <div class="trades-panel">
            <div class="bottom-panel-header">
              <span>Recent Trades</span>
              <button class="icon-btn" id="btn-refresh-trades">⟳</button>
            </div>
            <div class="bottom-panel-body">
              <table class="trades-table">
                <thead>
                  <tr>
                    <th>Time</th>
                    <th>Price</th>
                    <th>Amount</th>
                    <th>Side</th>
                  </tr>
                </thead>
                <tbody id="trades-body"></tbody>
              </table>
            </div>
          </div>
          
          <div class="trades-panel">
            <div class="bottom-panel-header">
              <span>System Activity</span>
            </div>
            <div class="bottom-panel-body" id="activity-log" style="font-size:11px;color:var(--text-muted);padding:4px 6px;"></div>
          </div>
        </section>
        
      </main>
    </div> <!-- End #page-spot -->

    <!-- =========================
     PAGE: WALLET (REMOVED)
    ========================= -->

    <!-- =========================
        PAGE CONTAINER: FUTURES (REMOVED - Merged with Spot page)
    ========================== -->

    <!-- =========================
        PAGE CONTAINER: METALS VAULT (REMOVED - Merged with Trade Panel)
    ========================== -->


    <!-- NEW: PLACEHOLDER PAGES -->
    <div class="page-container" id="page-dex" style="display:none;">
        <div class="placeholder-page">
            <div class="placeholder-title">Aynu DEX</div>
            <div class="placeholder-sub">Decentralized Exchange interface coming soon.</div>
        </div>
    </div>
    
    <!-- REMOVED: Demo placeholder, it now uses page-spot -->


    <!-- =========================
        MODALS & OVERLAYS
    ========================== -->

    <!-- Quick Actions HUD -->
    <div id="quick-actions-hud">
      <button class="quick-action-btn" id="hud-buy-market">Buy Market</button>
      <button class="quick-action-btn" id="hud-sell-market">Sell Market</button>
      <button class="quick-action-btn" id="hud-buy-limit">Buy Limit</button>
      <button class="quick-action-btn" id="hud-draw-line">Draw Line</button>
    </div>

    <!-- REMOVED: ZK-KYC MODAL -->
    
    <!-- REMOVED: WALLET MODAL -->


    <!-- TOASTS -->
    <div class="toast-container" id="toast-container"></div>

  <script>
    // ==============================
    // NEW: API BASE URL
    // ==============================
    const API_BASE_URL = "https://price.orcaamr.com";
    
    // ==============================
    // BASIC STATE
    // ==============================
    const state = {
      connected: false,
      wallet: null, // Will be like 'amr-galaxy-...'
      mode: "spot",     // "spot" | "futures" | "metals" | "demo"
      view: "spot",    // "spot" | "futures" | "metals" | "demo" | "dex"
      markets: [],
      walletAssets: [], // Still needed for balance checks
      orderbook: { bids: [], asks: [] },
      trades: [], // This will be populated by /cex/trades
      positions: [],
      openOrders: [],
      metals: [],
      feeRate: 0.001, // 0.1%
      selectedMarket: null,
      selectedHologram: null, // For metals vault
    };
    
    // ==============================
    // NEW: TOKEN INFO MOCK DATA
    // ==============================
    const tokenInfoData = {
        "AMR": {
            name: "AMRChain",
            symbol: "AMR",
            description: "AMRChain is the native L1 token for the Aynu ecosystem, powering transactions, governance, and staking across the network.",
            logo: "var(--accent-1)",
            metrics: {
                "Market Cap": "$150,000,000",
                "TVL": "$45,000,000",
                "All-Time High": "$1.50",
                "All-Time Low": "$0.002",
            }
        },
        "NVR": {
            name: "Novera",
            symbol: "NVR",
            description: "Novera is the native stablecoin of the AMRChain ecosystem, designed to maintain a stable peg for seamless trading and payments.",
            logo: "var(--accent-3)",
            metrics: {
                "Market Cap": "$80,000,000",
                "TVL": "N/A",
                "All-Time High": "$1.02",
                "All-Time Low": "$0.98",
            }
        },
        "IONX": {
            name: "IonFluid",
            symbol: "IONX",
            description: "IonFluid is the gas token of the AMRChain network, used to pay for computational fees and facilitate network operations.",
            logo: "var(--accent-2)",
            metrics: {
                "Market Cap": "$30,000,000",
                "TVL": "N/A",
                "All-Time High": "$0.10",
                "All-Time Low": "$0.01",
            }
        }
    };

    // ==============================
    // CHART STATE (TradingView-style)
    // ==============================
    const chartState = {
      type: "candles",
      timeFrame: "1m",
      upColor: "#4caf50",
      downColor: "#ff4b7d",
      showGrid: true,
      showWicks: true,
      theme: "night", // Default theme
      candles: [], // This will be built from state.trades
      // Price range
      minPrice: 0,
      maxPrice: 0,
      // Time range
      minTs: 0,
      maxTs: 0,
      // Interaction state
      isDragging: false,
      lastDragY: 0,
      yAxisWidth: 60,
      currentTool: 'crosshair', // For drawing tools
      // NEW: Indicators state
      indicators: {
        volume: true,
        rsi: false,
        macd: false
      }
    };

    // ==============================
    // DOM HELPERS
    // ==============================
    const qs = s => document.querySelector(s);
    const qsa = s => Array.from(document.querySelectorAll(s));

    function logActivity(message) {
      const log = qs("#activity-log");
      if (!log) return;
      const timestamp = new Date().toLocaleTimeString("en-US", { hour12: false });
      const line = document.createElement("div");
      line.textContent = `[${timestamp}] ${message}`;
      log.prepend(line);
      const maxLines = 50;
      while (log.children.length > maxLines) {
        log.removeChild(log.lastChild);
      }
    }

    function showToast(title, msg, type = "info", timeout = 3200) {
      const container = qs("#toast-container");
      if (!container) return;
      const t = document.createElement("div");
      t.className = "toast " + type;
      t.innerHTML = `<div class="toast-title">${title}</div><div class="toast-msg">${msg}</div>`;
      container.appendChild(t);
      setTimeout(() => {
        t.style.opacity = "0";
        t.style.transform = "translateY(4px)";
        setTimeout(() => container.removeChild(t), 400);
      }, timeout);
    }

    // ==============================
    // MOCK DATA (Only for Metals/Wallet Demo)
    // ==============================
    function initMockData() {
      // Markets are now fetched live
      
      // NEW: Demo mode check for wallet balances
      if (state.mode === 'demo') {
        state.walletAssets = [
          { asset: "AMR", total: 10000, available: 10000, inOrders: 0 },
          { asset: "NVR", total: 100000, available: 100000, inOrders: 0 },
          { asset: "IONX", total: 50000, available: 50000, inOrders: 0 }
        ];
        logActivity("Demo Mode: Loaded simulated funds.");
      } else {
         state.walletAssets = [
          { asset: "AMR", total: 1000, available: 800, inOrders: 200 },
          { asset: "NVR", total: 5000, available: 3000, inOrders: 2000 },
          { asset: "IONX", total: 120, available: 80, inOrders: 40 }
        ];
      }

      // Positions and orders will be added by the user
      state.positions = [];
      state.openOrders = [];

      state.metals = [
        { id: "LEX", name: "Lexirium", price: 500.0, desc: "High-density digital metal", tags: ["Core Reserve", "High Cov."], apy: "—", color1: "#7b5bff", color2: "#37c5ff" },
        { id: "CRY", name: "Crystal Shards", price: 50000.0, desc: "Ultra rare crystal layer", tags: ["Ultra Rare", "Illiquid"], apy: "—", color1: "#ff00ff", color2: "#ffffff" },
        { id: "GLD", name: "Digital Gold", price: 1000.0, desc: "1g gold-pegged digital bar", tags: ["Stable", "Backed"], apy: "—", color1: "#ffd700", color2: "#ffec80" },
        { id: "DMS", name: "Dark Matter", price: 10000.0, desc: "Exotic liquidity gravity", tags: ["Experimental", "Cosmic"], apy: "—", color1: "#000000", color2: "#ff00ff" }
      ];
      state.selectedHologram = state.metals[0];

      // We no longer generate mock trades or orderbooks
      // We will initialize the chart AFTER fetching real data
    }


    // ==============================
    // LIVE CEX DATA (REST via Go Node)
    // ==============================
    let cexPollTimer = null;

    function initLiveData() {
      // Available markets (static, but prices from /cex/best)
      state.markets = [
        { pair: "AMR/NVR",  last: 0, change: 0.0, vol: 0, base: "AMR", quote: "NVR", group: "amr" },
        { pair: "AMR/IONX", last: 0, change: 0.0, vol: 0, base: "AMR", quote: "IONX", group: "amr" },
        { pair: "NVR/IONX", last: 0, change: 0.0, vol: 0, base: "NVR", quote: "IONX", group: "nvr" }
      ];
      state.selectedMarket = state.markets[0];

      // Demo wallets
      initMockData(); // This loads walletAssets and metals
      
      state.orderbook = { bids: [], asks: [] };
      state.trades = []; // Start with empty trades

      // First render (will show "no data" for chart)
      renderAll();
      renderTokenInfo(state.selectedMarket); // Render info for default market

      // Start real polling from /cex/*
      startCexPolling();
    }

    async function fetchBestForCurrent() {
      const m = state.selectedMarket;
      if (!m) return;
      try {
        const res = await fetch(`${API_BASE_URL}/cex/best?pair=${encodeURIComponent(m.pair)}`);
        if (!res.ok) return;
        const data = await res.json(); // {bid, ask}
        if (typeof data.bid === "number" && typeof data.ask === "number") {
          const old = m.last || ((data.bid + data.ask) / 2);
          const mid = (data.bid + data.ask) / 2;
          m.last = mid;
          if (old > 0) {
            const diff = mid - old;
            const pct = (diff / old) * 100;
            // Accumulate change simply
            m.change += pct;
          }
          
          // Update 24h high/low (mocked from mid)
          qs("#hud-high").textContent = (mid * 1.02).toFixed(8); // Mock
          qs("#hud-low").textContent = (mid * 0.98).toFixed(8); // Mock
        }
      } catch (e) {
        console.error("fetchBestForCurrent failed", e);
      }
    }

    async function fetchDepthForCurrent() {
      const m = state.selectedMarket;
      if (!m) return;
      try {
        const res = await fetch(`${API_BASE_URL}/cex/depth?pair=${encodeURIComponent(m.pair)}`);
        if (!res.ok) return;
        const data = await res.json();
        // C++ depth_to_json: {buys:[{price,qty},...], sells:[{price,qty},...], timestamp:...}
        const asks = (data.sells || []).map(level => ({
          price: Number(level.price),
          amount: Number(level.qty),
          total: Number(level.price) * Number(level.qty)
        }));
        const bids = (data.buys || []).map(level => ({
          price: Number(level.price),
          amount: Number(level.qty),
          total: Number(level.price) * Number(level.qty)
        }));
        state.orderbook.asks = asks;
        state.orderbook.bids = bids;
      } catch (e) {
        console.error("fetchDepthForCurrent failed", e);
      }
    }

    let lastTradePrice = null;
    async function fetchTradesForCurrent() {
      const m = state.selectedMarket;
      if (!m) return;
      try {
        const res = await fetch(`${API_BASE_URL}/cex/trades?pair=${encodeURIComponent(m.pair)}`);
        if (!res.ok) return;
        const data = await res.json();
        const raw = data.trades || [];
        const mapped = [];
        
        // C++: { id, side, price, quantity, timestamp }
        raw.forEach(t => {
          const price = parseFloat(t.price);
          const amount = parseFloat(t.quantity || t.amount || 0);
          mapped.push({
            price,
            amount,
            ts: parseInt(t.ts || t.timestamp || Date.now()),
            side: t.side, // 'buy' or 'sell'
            id: t.id || t.trade_id || ""
          });
        });
        
        // Store trades, sorted by time (oldest first for candle building)
        mapped.sort((a, b) => a.ts - b.ts);
        state.trades = mapped;
        
        // Update lastTradePrice for UI display
        if (state.trades.length > 0) {
            lastTradePrice = state.trades[state.trades.length - 1].price;
        }

      } catch (e) {
        console.error("fetchTradesForCurrent failed", e);
      }
    }

    async function fetchCexSnapshot() {
      if (!state.selectedMarket) return;
      try {
        await Promise.all([
          fetchBestForCurrent(),
          fetchDepthForCurrent(),
          fetchTradesForCurrent(), // This now populates state.trades
        ]);

        // Update chart data AFTER fetching trades
        initChartData();

        // Then render everything
        renderAll();
      } catch (err) {
        console.error("[CEX Live] fetchCexSnapshot error", err);
      }
    }

    function startCexPolling() {
      if (cexPollTimer) clearInterval(cexPollTimer);
      // First load
      fetchCexSnapshot();
      // Then every 3 seconds
      cexPollTimer = setInterval(fetchCexSnapshot, 3000);
    }

    // ==============================
    // CHART DATA (CANDLES)
    // ==============================

    /**
     * Build Candles from Real Trades
     * @param {Array} trades - The state.trades array
     * @param {String} timeframeStr - e.g., "1m", "15m"
     * @param {Number} maxCandles - Max number of candles to return
     */
    function buildCandlesFromTrades(trades, timeframeStr, maxCandles = 80) {
      let minutes = 1;
      switch (timeframeStr) {
        case "15m": minutes = 15; break;
        case "1h":  minutes = 60; break;
        case "4h":  minutes = 240; break;
        case "1d":  minutes = 1440; break;
        case "1m":
        default:    minutes = 1; break;
      }
      const tfMs = minutes * 60 * 1000;

      const buckets = new Map();

      (trades || []).forEach(tr => {
        const ts = tr.ts || Date.now();
        const price = tr.price;
        const vol   = tr.amount || 0;

        if (!price || isNaN(price) || price <= 0) return;

        // Find the start time of the bucket this trade belongs to
        const bucketTs = Math.floor(ts / tfMs) * tfMs;

        let c = buckets.get(bucketTs);
        if (!c) {
          // New bucket, create new candle
          c = {
            time:   bucketTs, // Use 'time' to match old 'buildRandomCandles'
            open:   price,
            high:   price,
            low:    price,
            close:  price,
            volume: 0,
          };
          buckets.set(bucketTs, c);
        } else {
          // Update existing candle
          if (price > c.high) c.high = price;
          if (price < c.low)  c.low  = price;
          c.close = price; // Always update close to the latest trade in bucket
        }
        c.volume += vol;
      });

      // Convert map to array and sort by time
      let arr = Array.from(buckets.values()).sort((a, b) => a.time - b.time);

      // Enforce maxCandles limit
      if (maxCandles && arr.length > maxCandles) {
        arr = arr.slice(arr.length - maxCandles);
      }
      return arr;
    }

    /**
     * MODIFIED: initChartData now uses real trades
     */
    function initChartData() {
      const tf = chartState.timeFrame || "1m";

      // Build candles from state.trades
      chartState.candles = buildCandlesFromTrades(state.trades, tf, 80);

      // If no trades yet, set a default range around the last price
      if (!chartState.candles || chartState.candles.length === 0) {
        const basePrice =
          (state.selectedMarket && state.selectedMarket.last) ||
          (lastTradePrice) ||
           0.00005;

        chartState.minPrice = basePrice * 0.95;
        chartState.maxPrice = basePrice * 1.05;
        const now = Date.now();
        // Set a default time range (e.g., last 80 minutes for 1m tf)
        let tfMs = 60 * 1000;
        try {
            const unit = tf.slice(-1);
            const val = parseInt(tf.slice(0, -1));
            if (unit === 'm') tfMs = val * 60 * 1000;
            if (unit === 'h') tfMs = val * 60 * 60 * 1000;
            if (unit === 'd') tfMs = val * 24 * 60 * 60 * 1000;
        } catch(e) {}
        chartState.minTs = now - 80 * tfMs;
        chartState.maxTs = now;
        return;
      }

      // Calculate price and time range from the real candles
      const prices = chartState.candles.flatMap(c => [c.high, c.low]);
      let minP = Math.min(...prices);
      let maxP = Math.max(...prices);
      
      if (!isFinite(minP) || !isFinite(maxP) || minP === maxP) {
        const basePrice =
          (state.selectedMarket && state.selectedMarket.last) || 
          (lastTradePrice) || 
          0.00005;
        minP = basePrice * 0.95;
        maxP = basePrice * 1.05;
      }

      const padding = (maxP - minP) * 0.1 || minP * 0.05;
      chartState.minPrice = minP - padding;
      chartState.maxPrice = maxP + padding;

      chartState.minTs = chartState.candles[0].time;
      chartState.maxTs = chartState.candles[chartState.candles.length - 1].time;
    }

    // ==============================
    // ===== NEW MASTER RENDERER ====
    // ==============================
    function renderAll() {
      if (!state.selectedMarket) return;
      
      // Render components based on the active page
      if (state.view === 'spot' || state.view === 'futures' || state.view === 'metals' || state.view === 'demo') {
        renderMarkets();
        renderHud(state.selectedMarket);
        renderOrderbook();
        renderTrades(); // Uses real state.trades
        renderActiveOrdersAndPositions();
        
        updateTradeFormUI(); 
        renderChart(); // Uses real chartState.candles
        renderTokenInfo(state.selectedMarket); // Render token info
      }
      
      // REMOVED: renderWallet() call
    }

    function updateTradeFormUI() {
      const m = state.selectedMarket;
      if (!m) return;

      // Check if trade form elements exist on this page
      const tradePanelTitle = qs("#trade-panel-title");
      if (!tradePanelTitle) return; // Exit if not on trade page

      const base = m.base;
      const quote = m.quote;
      const isFutures = state.mode === 'futures';
      const isMetals = state.mode === 'metals'; // NEW: Metals check
      const modeTitle = isFutures ? "Futures" : (isMetals ? "Metals Vault" : "Spot");
      const orderType = qs("#order-type").value;
      
      // NEW: Show/hide trade form vs metals grid
      qs("#trade-forms-wrapper").style.display = isMetals ? "none" : "block";
      qs("#metals-wrapper").style.display = isMetals ? "block" : "none";
      
      if (isMetals) {
        tradePanelTitle.textContent = "Digital Metals Vault";
        renderMetalsGrid(); // NEW: Populate metals grid
        return; // Don't need to update the rest of the form
      }
      
      // Update titles and labels
      tradePanelTitle.textContent = `${modeTitle} Trade – ${m.pair}`;
      qs("#price-quote").textContent = quote;
      qs("#amount-base").textContent = base;
      qs("#total-quote").textContent = quote;
      qs("#balance-quote-symbol").textContent = quote;
      qs("#stop-price-quote").textContent = quote;
      qs("#orderbook-title").textContent = `${modeTitle} Orderbook`;
      
      const buyBtn = qs(".trade-side-btn[data-side='buy']");
      const sellBtn = qs(".trade-side-btn[data-side='sell']");
      if(buyBtn) buyBtn.textContent = isFutures ? "Long" : "Buy";
      if(sellBtn) sellBtn.textContent = isFutures ? "Short" : "Sell";

      const quoteWallet = state.walletAssets.find(a => a.asset === quote);
      qs("#balance-quote").value = quoteWallet ? quoteWallet.available.toFixed(8) : "0.00000000";
      
      // Show/hide form rows based on mode and order type
      const isStop = orderType === 'stop-limit' || orderType === 'tp-limit';
      const isMarket = orderType === 'market';

      qs("#stop-price-row").style.display = isStop ? 'flex' : 'none';
      qs("#limit-price-row").style.display = isMarket ? 'none' : 'flex';
      qs("#input-price").disabled = isMarket;
      
      // Show/hide Futures-specific elements
      qsa(".futures-only").forEach(el => el.style.display = isFutures ? 'flex' : 'none');
      qsa(".spot-only").forEach(el => el.style.display = isFutures ? 'none' : 'flex');
      qs("#leverage-badge").style.display = isFutures ? 'inline-flex' : 'none';
      
      // NEW: Update both leverage displays
      const currentLev = qs("#leverage-slider")?.value || 10;
      qs("#leverage-badge").textContent = isFutures ? `Isolated · ${currentLev}x` : "Spot";
      qs("#leverage-display").textContent = `${currentLev}x`;
      
      qs("#order-type-label").textContent = state.mode === "spot" ? "Spot" : "Futures";

      // Update submit button text based on login state
      const submitBtn = qs("#btn-submit-order");
      if (state.connected) {
        const side = getOrderSide();
        if (isFutures) {
            submitBtn.textContent = side === 'buy' ? "Open Long" : "Open Short";
        } else {
            submitBtn.textContent = side === 'buy' ? "Place Buy Order" : "Place Sell Order";
        }
      } else {
        submitBtn.textContent = "Connect Wallet to Trade";
      }
    }
    
    // NEW: Render Metals Grid
    function renderMetalsGrid() {
      const grid = qs("#metals-grid");
      if (!grid) return;
      grid.innerHTML = "";
      state.metals.forEach(metal => {
        const card = document.createElement("div");
        card.className = "metal-card";
        card.innerHTML = `
          <div class="metal-name">${metal.name}</div>
          <div class="metal-tagline">${metal.desc}</div>
          <div class="metal-price">${metal.price.toFixed(2)} NVR</div>
          <div class="metal-badge-row">
            ${metal.tags.map(tag => `<span class="metal-badge">${tag}</span>`).join('')}
          </div>
          <div class="metal-footer-row">
            <button class="btn-metal-buy" data-id="${metal.id}">Buy</button>
          </div>
        `;
        card.querySelector('.btn-metal-buy').addEventListener('click', (e) => {
          e.stopPropagation();
          showToast("Metals Vault", `Buying ${metal.name} (demo)...`, "info");
        });
        grid.appendChild(card);
      });
    }

    // ==============================
    // RENDER FUNCTIONS (Individual)
    // ==============================
    function renderMarkets() {
      const tbody = qs("#market-body");
      if (!tbody) return;
      const searchInput = qs("#market-search-input");
      const search = searchInput ? searchInput.value.trim().toUpperCase() : "";
      const activeTab = qsa(".market-tab").find(t => t.classList.contains("active"))?.dataset.marketTab || "all";
      tbody.innerHTML = "";
      state.markets
        .filter(m => {
          if (search && !m.pair.toUpperCase().includes(search)) return false;
          if (activeTab === "all") return true;
          if (activeTab === "fav") return m.pair === "AMR/NVR"; // Simple fav logic
          return m.group === activeTab;
        })
        .forEach(m => {
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${m.pair}</td>
            <td>${m.last > 0 ? m.last.toFixed(8) : '...'}</td>
            <td class="${m.change > 0 ? "change-up" : m.change < 0 ? "change-down" : ""}">
              ${m.change >= 0 ? "+" : ""}${m.change.toFixed(2)}%
            </td>
            <td>${formatVol(m.vol)}</td>
          `;
          tr.addEventListener("click", () => onSelectMarket(m));
          tbody.appendChild(tr);
        });
    }

    function renderHud(pairObj) {
      const m = pairObj || state.markets[0];
      if (!m) return;
      const isFutures = state.mode === 'futures';
      
      // Show/hide HUD blocks
      qsa(".hud-block.spot-only").forEach(el => el.style.display = isFutures ? 'none' : 'flex');
      qsa(".hud-block.futures-only").forEach(el => el.style.display = isFutures ? 'flex' : 'none');

      // Update labels
      qs("#hud-pair-label").textContent = isFutures ? "Perpetual Pair" : (state.mode === 'demo' ? "Demo Pair" : "Pair");
      qs("#hud-last-label").textContent = isFutures ? "Mark Price (NVR)" : "Last Price (NVR)";
      
      // Update values
      qs("#hud-pair").textContent = m.pair;
      qs("#hud-last").textContent = m.last > 0 ? m.last.toFixed(8) : '...';
      
      if(!isFutures) {
        const changeEl = qs("#hud-change");
        changeEl.textContent = (m.change >= 0 ? "+" : "") + m.change.toFixed(2) + "%";
        changeEl.classList.toggle("green", m.change >= 0);
        changeEl.classList.toggle("red", m.change < 0);
      } else {
        // Mock futures data
        qs("#hud-oi").textContent = `$${(m.vol * m.last * 20).toLocaleString('en-US', {maximumFractionDigits: 0})}`; // Mock OI
        // Mock funding rate logic here if needed
      }
    }

    function renderOrderbook() {
      const asksBox = qs("#asks-body");
      const bidsBox = qs("#bids-body");
      if (!asksBox || !bidsBox) return;
      asksBox.innerHTML = "";
      bidsBox.innerHTML = "";
      
      const asks = [...state.orderbook.asks].sort((a, b) => a.price - b.price).slice(0, 14); // Limit
      const bids = [...state.orderbook.bids].sort((a, b) => b.price - a.price).slice(0, 14); // Limit
      
      const maxAskTotal = Math.max(...asks.map(a => a.total), 0);
      const maxBidTotal = Math.max(...bids.map(b => b.total), 0);

      asks.reverse().forEach(row => { // Reverse for display (lowest ask at bottom)
        const el = document.createElement("div");
        el.className = "order-row ask";
        const depth = (row.total / maxAskTotal) * 100;
        el.style.setProperty('--depth', `${depth.toFixed(1)}%`);
        el.innerHTML = `
          <span>${row.price.toFixed(8)}</span>
          <span>${row.amount.toFixed(2)}</span>
          <span>${row.total.toFixed(6)}</span>
        `;
        asksBox.appendChild(el);
      });

      bids.forEach(row => {
        const el = document.createElement("div");
        el.className = "order-row bid";
        const depth = (row.total / maxBidTotal) * 100;
        el.style.setProperty('--depth', `${depth.toFixed(1)}%`);
        el.innerHTML = `
          <span>${row.price.toFixed(8)}</span>
          <span>${row.amount.toFixed(2)}</span>
          <span>${row.total.toFixed(6)}</span>
        `;
        bidsBox.appendChild(el);
      });

      const bestAsk = asks[asks.length - 1]?.price || 0; // Last after reverse
      const bestBid = bids[0]?.price || 0;
      const mid = bestAsk && bestBid ? (bestAsk + bestBid) / 2 : (state.selectedMarket?.last || 0);
      qs("#mid-price").textContent = mid > 0 ? mid.toFixed(8) : '...';
    }

    function renderTrades() {
      const tbody = qs("#trades-body");
      if (!tbody) return;
      tbody.innerHTML = "";
      [...state.trades].reverse().slice(0, 40).forEach(t => {
        const tr = document.createElement("tr");
        const timeStr = new Date(t.ts).toLocaleTimeString("en-US", { hour12: false });
        tr.innerHTML = `
          <td>${timeStr}</td>
          <td>${t.price.toFixed(8)}</td>
          <td>${t.amount.toFixed(2)}</td>
          <td class="${t.side === "buy" ? "buy-text" : "sell-text"}">${t.side.toUpperCase()}</td>
        `;
        tbody.appendChild(tr);
      });
    }

    // REMOVED: renderWallet() function

    function renderActiveOrdersAndPositions() {
      const tbody = qs("#active-tbody");
      const thead = qs("#active-orders-thead");
      const title = qs("#active-panel-title");
      if (!tbody || !thead || !title) return;
      tbody.innerHTML = "";
      
      const titleSuffix = state.mode === 'demo' ? " (Demo)" : (state.mode === 'futures' ? " (Futures)" : " (Spot)");

      if (state.mode === 'futures' || (state.mode === 'demo' && state.positions.length > 0)) {
        title.textContent = "Open Positions" + titleSuffix;
        thead.innerHTML = `
          <tr>
            <th>Pair</th>
            <th>Side</th>
            <th>Size</th>
            <th>Entry</th>
            <th>Mark</th>
            <th>PnL</th>
            <th>SL/TP</th>
          </tr>
        `;
        state.positions.forEach(p => {
          const tr = document.createElement("tr");
          const markPrice = state.selectedMarket.last;
          const pnlValue = (markPrice - p.entry) * p.size * (p.side === 'long' ? 1 : -1);
          const pnlPct = (pnlValue / (p.entry * p.size)) * 100 * p.leverage; // Simplified PnL %
          
          const pnlClass = pnlValue >= 0 ? "buy-text" : "sell-text";
          tr.innerHTML = `
            <td>${p.pair}</td>
            <td><span class="tag ${p.side}">${p.side.toUpperCase()}</span></td>
            <td>${p.size.toFixed(2)}</td>
            <td>${p.entry.toFixed(8)}</td>
            <td>${markPrice.toFixed(8)}</td>
            <td class="${pnlClass}">${pnlValue.toFixed(4)} (${pnlPct.toFixed(2)}%)</td>
            <td>${p.tp || '–'} / ${p.sl || '–'}</td>
          `;
          tbody.appendChild(tr);
        });
      } else {
        // Render Spot/Demo Orders
        title.textContent = "Open Orders" + titleSuffix;
        thead.innerHTML = `
          <tr>
            <th>Pair</th>
            <th>Side</th>
            <th>Amount</th>
            <th>Price</th>
            <th>Stop Price</th>
            <th>Total</th>
          </tr>
        `;
        state.openOrders.forEach(o => {
          const tr = document.createElement("tr");
          const sideClass = o.side === "buy" ? "buy-text" : "sell-text";
          tr.innerHTML = `
            <td>${o.pair}</td>
            <td class="${sideClass}">${o.side.toUpperCase()}</td>
            <td>${o.amount.toFixed(2)}</td>
            <td>${o.price.toFixed(8)}</td>
            <td>${o.stopPrice ? o.stopPrice.toFixed(8) : 'N/A'}</td>
            <td>${o.total.toFixed(8)}</td>
          `;
          tbody.appendChild(tr);
        });
      }
    }

    // REMOVED: renderQuickWallet()

    // NEW: Render Token Info Panel
    function renderTokenInfo(market) {
        if (!market) return;
        const info = tokenInfoData[market.base]; // Get info for the BASE currency
        if (!info) {
            // Clear panel if no info
            qs("#token-info-name").textContent = market.base;
            qs("#token-info-symbol").textContent = "No data";
            qs("#token-info-logo").style.background = "#333";
            qs("#token-info-desc").textContent = "No information available for this token.";
            qs("#token-info-metrics").innerHTML = "";
            return;
        }

        qs("#token-info-name").textContent = info.name;
        qs("#token-info-symbol").textContent = info.symbol;
        qs("#token-info-logo").style.background = info.logo;
        qs("#token-info-desc").textContent = info.description;
        
        const metricsContainer = qs("#token-info-metrics");
        metricsContainer.innerHTML = ""; // Clear old metrics
        
        for (const [label, value] of Object.entries(info.metrics)) {
            const metricEl = document.createElement("div");
            metricEl.className = "token-info-metric";
            metricEl.innerHTML = `
                <span class="token-info-metric-label">${label}</span>
                <span class="token-info-metric-value">${value}</span>
            `;
            metricsContainer.appendChild(metricEl);
        }
    }


    // REMOVED: renderMetalsVault, renderHologram

    // ==============================
    // PAGE/MODE SWITCHING
    // ==============================
    function switchView(view) {
      state.view = view;
      
      // Hide all pages
      qsa(".page-container").forEach(p => p.style.display = "none");
      qs("#demo-mode-banner").style.display = "none";
      
      // Show the selected one
      let page;
      if (view === 'spot' || view === 'futures' || view === 'metals' || view === 'demo') {
        page = qs(`#page-spot`); // All trading views use the 'spot' page container
        state.mode = view; // Set the trading mode
        
        if (view === 'demo') {
            qs("#demo-mode-banner").style.display = "block";
            initMockData(); // Reload with demo funds
        } else if (view === 'spot') {
            initMockData(); // Reload with real (mock) funds
        }
        
      } else {
        page = qs(`#page-${view}`); // e.g., page-dex
      }
      
      if (page) {
        page.style.display = "flex";
      }
      
      logActivity(`Switched to ${view} page`);
      renderAll();
      // Recalculate chart data on view switch if it's a chart page
      if (view === 'spot' || view === 'futures' || view === 'demo' || view === 'metals') {
        initChartData();
        renderChart();
      }
    }

    // REMOVED: switchTradeMode, it's handled by switchView

    function onSelectMarket(m) {
      state.selectedMarket = m;
      logActivity(`Selected market ${m.pair}`);
      
      // Fetch new data for this market
      fetchCexSnapshot();
      
      // Renders will happen inside fetchCexSnapshot
      renderTokenInfo(m); // Update token info panel
    }

    // ==============================
    // TRADE FORM LOGIC
    // ==============================
    function getOrderSide() {
      const active = qsa(".trade-side-btn").find(b => b.classList.contains("active"));
      return active?.dataset.side || "buy";
    }

    function recalcTrade() {
      const priceEl = qs("#input-price");
      const amountEl = qs("#input-amount");
      const totalEl = qs("#input-total");
      if (!priceEl || !amountEl || !totalEl) return;

      const price = parseFloat(priceEl.value) || 0;
      const amount = parseFloat(amountEl.value) || 0;
      const total = price * amount;
      totalEl.value = total ? total.toFixed(8) : "";
      const fee = total * state.feeRate;
      qs("#fee-rate").textContent = (state.feeRate * 100).toFixed(2) + "%";
      qs("#fee-estimate").textContent = fee.toFixed(8);
    }

    function handleQuickPct(pct) {
      if (!state.selectedMarket) return;
      const quoteWallet = state.walletAssets.find(a => a.asset === state.selectedMarket.quote);
      const baseWallet = state.walletAssets.find(a => a.asset === state.selectedMarket.base);
      
      const quoteBal = quoteWallet ? quoteWallet.available : 0;
      const baseBal = baseWallet ? baseWallet.available : 0;

      const priceEl = qs("#input-price");
      const price = parseFloat(priceEl.value) || (state.selectedMarket.last || 0.00005);
      if (price === 0) return; // Avoid division by zero
      
      const side = getOrderSide();
      let amount = 0;
      
      if (side === "buy") {
        const maxSpend = quoteBal * (pct / 100);
        amount = maxSpend / price;
      } else {
        const maxSell = baseBal * (pct / 100);
        amount = maxSell;
      }

      const amountEl = qs("#input-amount");
      if (amountEl) amountEl.value = amount.toFixed(8);
      recalcTrade();
    }

    /**
     * REBUILT: submitOrder with full wallet logic.
     */
    async function submitOrder(e) {
      e.preventDefault();

      if (!state.connected) {
        showToast("Order Failed", "Please connect your wallet first", "error");
        connectAynuWallet();
        return;
      }

      const side  = getOrderSide();               // buy / sell
      const type  = qs("#order-type")?.value || "limit"; // limit / market / stop-limit
      const priceEl = qs("#input-price");
      const amountEl = qs("#input-amount");

      let price = parseFloat(priceEl.value) || 0;
      const amount = parseFloat(amountEl.value) || 0;
      const stopPrice = parseFloat(qs("#input-stop-price").value) || 0;
      
      // For market orders, estimate price
      if (type === 'market') {
          price = state.selectedMarket.last;
      }
      
      const total  = price * amount;
      
      const sl = parseFloat(qs("#input-sl").value) || 0;
      const tp = parseFloat(qs("#input-tp").value) || 0;

      // Validation
      if (type !== 'market' && price <= 0) {
        showToast("Order rejected", "Please enter a valid price", "error"); return;
      }
      if (amount <= 0) {
        showToast("Order rejected", "Please enter a valid amount", "error"); return;
      }
      if (type === 'stop-limit' && stopPrice <= 0) {
        showToast("Order rejected", "Please enter a valid stop price", "error"); return;
      }


      const baseSymbol  = state.selectedMarket.base;
      const quoteSymbol = state.selectedMarket.quote;
      const baseWallet  = state.walletAssets.find(a => a.asset === baseSymbol);
      const quoteWallet = state.walletAssets.find(a => a.asset === quoteSymbol);

      if (!baseWallet || !quoteWallet) {
        showToast("Order Failed", "Wallet assets not found", "error");
        return;
      }

      // Check balance
      if (side === 'buy') {
        if (quoteWallet.available < total) {
          showToast("Order Failed", `Insufficient ${quoteSymbol} balance.`, "error");
          return;
        }
      } else { // sell
        if (baseWallet.available < amount) {
          showToast("Order Failed", `Insufficient ${baseSymbol} balance.`, "error");
          return;
        }
      }

      // Build order for aynu_engine
      const pair = state.selectedMarket.pair;
      const nowMs = Date.now();
      const clientOrderId = `web-${pair.replace('/','-')}-${nowMs}-${Math.floor(Math.random() * 1e6)}`;
      const traderId = state.wallet || "web-demo";

      const orderEnvelope = {
        order: {
          pair:      pair,
          id:        clientOrderId,
          type:      type.includes('limit') ? 'limit' : 'market', // Engine understands 'limit' or 'market'
          side:      side,                 // "buy" / "sell"
          price:     type === "market" ? 0 : price,
          stop_price: stopPrice, // Pass stop price
          quantity:  amount,
          trader_id: traderId,
          timestamp: nowMs
        }
      };
      
      // --- NEW: DEMO & FUTURES LOGIC ---
      if (state.mode === 'futures' || state.mode === 'demo') {
          const isDemo = state.mode === 'demo';
          const modeName = isDemo ? "Demo" : "Futures";
          
          // Simulate local order/position
          const newPos = {
              pair: pair,
              side: side === 'buy' ? 'long' : 'short',
              size: amount,
              entry: state.selectedMarket.last, // Mark at current price
              leverage: parseInt(qs("#leverage-slider")?.value || 1),
              sl: sl || null,
              tp: tp || null,
          };
          state.positions.push(newPos);
          showToast(`${modeName} Position Opened`, `${modeName} ${newPos.side} ${newPos.size} ${baseSymbol} @ ${newPos.entry}`, "success");
          
          // Simulate balance change
          if (side === 'buy') {
            quoteWallet.available -= total;
            quoteWallet.inOrders += total;
          } else {
            baseWallet.available -= amount;
            baseWallet.inOrders  += amount;
          }

          // Clear form
          amountEl.value = "";
          recalcTrade();
          renderAll(); // Will show position in table and on chart
          return;
      }
      // --- END DEMO/FUTURES LOGIC ---


      try {
        const res = await fetch(`${API_BASE_URL}/cex/place`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(orderEnvelope)
        });
        const data = await res.json().catch(() => ({}));

        if (!res.ok || data.ok === false) {
          const msg = data.error || `Engine rejected order (${res.status})`;
          showToast("Order Failed", msg, "error");
          return;
        }

        // On success, update local wallet state
        if (side === 'buy') {
          quoteWallet.available -= total;
          quoteWallet.inOrders += total;
        } else {
          baseWallet.available -= amount;
          baseWallet.inOrders  += amount;
        }

        // Add to local open orders list
        state.openOrders.push({
          pair: pair,
          side: side,
          type: type,
          amount: amount,
          price: price,
          stopPrice: stopPrice,
          total: total
        });

        const logMsg = `Order sent to AynuEngine · ${side.toUpperCase()} ${amount} ${baseSymbol} @ ${price} ${quoteSymbol} (${pair})`;
        showToast("Order Placed", logMsg, "success");

        playOrderAnimation(side);
        logActivity(logMsg);

        // Clear form
        amountEl.value = "";
        recalcTrade();

        // Fetch new snapshot to update orderbook
        fetchCexSnapshot();

      } catch (err) {
        console.error("submitOrder failed", err);
        showToast("Network Error", "Could not connect to AynuEngine", "error");
      }
    }

    
    // Order Execution Animation
    function playOrderAnimation(side) {
        const btn = qs("#btn-submit-order");
        const chart = qs("#price-chart");
        if (!btn || !chart) return;

        const btnRect = btn.getBoundingClientRect();
        const chartRect = chart.getBoundingClientRect();
        
        const line = document.createElement('div');
        line.className = 'order-animation-line';
        
        const startX = btnRect.left + btnRect.width / 2;
        const startY = btnRect.top + btnRect.height / 2;
        const endX = chartRect.left + chartRect.width * 0.75; // Land on chart
        const endY = chartRect.top + chartRect.height / 2;

        line.style.left = `${startX}px`;
        line.style.top = `${startY}px`;
        line.style.background = side === 'buy' ? 'var(--success)' : 'var(--danger)';
        line.style.boxShadow = `0 0 5px ${side === 'buy' ? 'var(--success)' : 'var(--danger)'}`;

        document.body.appendChild(line);

        requestAnimationFrame(() => {
            const deltaX = endX - startX;
            const deltaY = endY - startY;
            line.style.transform = `translate(${deltaX}px, ${deltaY}px) scale(5.0)`;
            line.style.opacity = '0';
        });

        line.addEventListener('transitionend', () => {
            line.remove();
        });
    }

    // ==============================
    // MODAL LOGIC (REMOVED)
    // ==============================
    // ... openWalletModal, closeWalletModal removed ...

    // ==============================================
    // Aynu Wallet Auth Flow (Simulated)
    // ==============================================
    async function connectAynuWallet() {
      // This is a simulation of the flow.
      const mockAynuWallet = {
        address: "amr-galaxy0orca-" + Math.random().toString(16).slice(2, 14),
        async signMessage(message) {
          // Simulate signing delay
          await new Promise(r => setTimeout(r, 300));
          // Fake signature based on message
          return "sig_0x" + message.length.toString(16) + Math.random().toString(16).slice(2, 50);
        }
      };

      try {
        // 1. Simulate getting nonce from server
        await new Promise(r => setTimeout(r, 200));
        const nonce = "Login to Aynu CEX: " + Math.floor(Math.random() * 1000000);

        // 2. Internal wallet signs the message
        const signature = await mockAynuWallet.signMessage(nonce);

        // 3. Simulate sending to server for verification
        await new Promise(r => setTimeout(r, 400));
        const verificationSuccess = true; // Always succeed in demo

        if (verificationSuccess) {
          state.connected = true;
          state.wallet = mockAynuWallet.address;
          
          qs("#wallet-label").textContent = "Wallet: " + state.wallet;
          qs("#status-dot").classList.add("online");
          qs("#status-text").textContent = "RPC: Connected (NebulaNet)";
          
          showToast("Success", "Aynu Wallet Connected", "success");
          logActivity(`Wallet connected: ${state.wallet}`);
          
          renderAll(); // Re-render to update trade button
        } else {
          showToast("Error", "Invalid signature (demo)", "error");
        }

      } catch (e) {
        showToast("Error", "Wallet connection failed (demo)", "error");
      }
    }
    
    // ==============================
    // THEME LOGIC
    // ==============================
    function setTheme(themeName) {
        document.body.dataset.theme = themeName;
        chartState.theme = themeName;
        
        // Update the dropdown
        const themeSelect = qs("#chart-theme");
        if (themeSelect) themeSelect.value = themeName;
        
        logActivity(`Theme changed to: ${themeName}`);
        renderChart();
    }

    function applyTimeBasedTheme() {
        const hour = new Date().getHours();
        if (hour > 5 && hour < 12) { // 6am - 11:59am
            setTheme('night'); // Default 'dark' mode
        } else if (hour >= 12 && hour < 18) { // 12pm - 5:59pm
            setTheme('evening'); // 'Evening' mode
        } else { // 6pm - 5:59am
            setTheme('night'); // 'Night' mode
        }
    }

    // ==============================
    // ADVANCED CHART RENDERING
    // ==============================
    function updateOhlcLabel(candle) {
      const row = qs("#chart-ohlc-row");
      if (!row || !candle) {
          if (row) row.innerHTML = `<span>O: ...</span><span>H: ...</span><span>L: ...</span><span>C: ...</span>`;
          return;
      }

      const dirClass = candle.close >= candle.open ? "up" : "down";
      row.innerHTML = `
        <span>O: ${candle.open.toFixed(8)}</span>
        <span>H: ${candle.high.toFixed(8)}</span>
        <span>L: ${candle.low.toFixed(8)}</span>
        <span class="${dirClass}">C: ${candle.close.toFixed(8)}</span>
        <span>Vol: ${candle.volume.toFixed(2)}</span>
      `;
    }

    // Helper function to map price to Y-coordinate
    function yFor(price, min, max, height, padTop, padBottom) {
        const drawHeight = height - padTop - padBottom;
        const priceRange = max - min;
        if (priceRange <= 0) return padTop + drawHeight / 2; // Default to middle
        
        const ratio = (price - min) / priceRange;
        return padTop + (1 - ratio) * drawHeight;
    }

    function renderChart() {
      renderMainChart();
      renderSubChart(); // NEW: Render indicators
      renderChartDrawings(); // Render drawings on top
    }
    
    function renderMainChart() {
      const canvas = qs("#price-chart");
      if (!canvas) return;

      const rect = canvas.getBoundingClientRect();
      if (rect.width === 0 || rect.height === 0) return;

      const dpr = window.devicePixelRatio || 1;
      const ctx = canvas.getContext("2d");

      canvas.width = rect.width * dpr;
      canvas.height = rect.height * dpr;
      ctx.save();
      ctx.scale(dpr, dpr);

      ctx.clearRect(0, 0, rect.width, rect.height);

      const candles = chartState.candles;
      if (!candles || candles.length === 0) {
        ctx.fillStyle = chartState.theme === 'holographic' ? 'var(--text-muted)' : 'rgba(150, 170, 255, 0.8)';
        ctx.font = "14px system-ui";
        ctx.textAlign = "center";
        ctx.fillText("No candle data available for this pair...", rect.width / 2, rect.height / 2);
        updateOhlcLabel(null);
        ctx.restore();
        return;
      }

      updateOhlcLabel(candles[candles.length - 1]);

      // Theme-aware colors
      const upColor = chartState.theme === 'holographic' ? 'var(--accent-3)' : chartState.upColor;
      const downColor = chartState.theme === 'holographic' ? 'var(--accent-4)' : chartState.downColor;
      const gridColor = chartState.theme === 'holographic' ? 'rgba(0, 255, 255, 0.2)' : 'rgba(255, 255, 255, 0.06)';
      const textColor = chartState.theme === 'holographic' ? 'var(--text-muted)' : 'rgba(150, 170, 255, 0.8)';

      const bgLayer = qs(".chart-canvas");
      const lineBg = qs("#chart-line-bg");
      if (chartState.theme === "holographic") {
         // Handled by CSS
      } else if (chartState.theme === "evening") {
        bgLayer.style.background = "linear-gradient(180deg,#1c122a,#0e0513)";
        lineBg.style.opacity = "0.20";
      } else { // night
        bgLayer.style.background = "linear-gradient(180deg,rgba(21,28,68,0.9),rgba(8,7,22,0.98))";
        lineBg.style.opacity = "0.12";
      }

      const gridLayer = qs("#chart-grid-layer");
      gridLayer.style.display = chartState.showGrid ? "block" : "none";

      const paddingLeft = 8;
      const paddingRight = chartState.yAxisWidth;
      const paddingTop = 10;
      const paddingBottom = 14;
      const width = rect.width - paddingLeft - paddingRight;
      const height = rect.height; // Use full height for yFor

      const { minPrice, maxPrice } = chartState;
      if (!isFinite(minPrice) || !isFinite(maxPrice)) {
        ctx.restore(); return;
      }
      const priceRange = maxPrice - minPrice;
      if (priceRange <= 0) {
        ctx.restore(); return;
      }

      const candleCount = candles.length;
      const slotWidth = width / candleCount;
      const candleWidth = Math.max(4, slotWidth * 0.6);

      // --- Draw Y-Axis (Price Scale) ---
      ctx.strokeStyle = gridColor;
      ctx.fillStyle = textColor;
      ctx.lineWidth = 1;
      ctx.font = "10px 'JetBrains Mono', monospace";
      ctx.textAlign = "left";
      ctx.textBaseline = "middle";

      ctx.beginPath();
      ctx.moveTo(width + paddingLeft, paddingTop);
      ctx.lineTo(width + paddingLeft, height - paddingBottom);
      ctx.stroke();

      const numLabels = 5;
      for (let i = 0; i <= numLabels; i++) {
        const ratio = i / numLabels;
        const price = maxPrice - (priceRange * ratio);
        const y = yFor(price, minPrice, maxPrice, height, paddingTop, paddingBottom);

        ctx.beginPath();
        ctx.moveTo(width + paddingLeft, y);
        ctx.lineTo(width + paddingLeft + 5, y);
        ctx.stroke();
        ctx.fillText(price.toFixed(8), width + paddingLeft + 8, y);
      }


      // LINE mode
      if (chartState.type === "line") {
        ctx.beginPath();
        ctx.lineWidth = 1.4;
        ctx.strokeStyle = chartState.theme === 'holographic' ? 'var(--accent-1)' : "#7ecbff";

        candles.forEach((c, i) => {
          const xCenter = paddingLeft + (i + 0.5) * slotWidth;
          const y = yFor(c.close, minPrice, maxPrice, height, paddingTop, paddingBottom);
          if (i === 0) ctx.moveTo(xCenter, y);
          else ctx.lineTo(xCenter, y);
        });
        ctx.stroke();

        ctx.lineTo(paddingLeft + (candleCount - 0.5) * slotWidth, height - paddingBottom);
        ctx.lineTo(paddingLeft + (0.5) * slotWidth, height - paddingBottom);
        ctx.closePath();
        ctx.fillStyle = chartState.theme === 'holographic' ? 'rgba(0, 255, 255, 0.15)' : "rgba(126,203,255,0.12)";
        ctx.fill();
        
        ctx.restore();
        return;
      }

      // CANDLE mode
      candles.forEach((c, i) => {
        const xCenter = paddingLeft + (i + 0.5) * slotWidth;
        const x = xCenter - candleWidth / 2;
        const yOpen = yFor(c.open, minPrice, maxPrice, height, paddingTop, paddingBottom);
        const yClose = yFor(c.close, minPrice, maxPrice, height, paddingTop, paddingBottom);
        const yHigh = yFor(c.high, minPrice, maxPrice, height, paddingTop, paddingBottom);
        const yLow = yFor(c.low, minPrice, maxPrice, height, paddingTop, paddingBottom);
        const isUp = c.close >= c.open;
        const color = isUp ? upColor : downColor;

        if (chartState.showWicks) {
          ctx.beginPath();
          ctx.strokeStyle = color;
          ctx.lineWidth = 1;
          ctx.moveTo(xCenter, yHigh);
          ctx.lineTo(xCenter, yLow);
          ctx.stroke();
        }

        const bodyTop = Math.min(yOpen, yClose);
        const bodyBottom = Math.max(yOpen, yClose);
        let bodyHeight = bodyBottom - bodyTop;
        if (bodyHeight < 1) bodyHeight = 1;

        ctx.fillStyle = color + "33"; // transparent
        ctx.fillRect(x - 0.5, bodyTop - 0.5, candleWidth + 1, bodyHeight + 1);
        ctx.fillStyle = color;
        ctx.fillRect(x, bodyTop, candleWidth, bodyHeight);
      });

      ctx.restore();
    }
    
    /**
     * NEW: Render Sub-Chart (Indicators)
     */
    function renderSubChart() {
      const canvas = qs("#sub-chart");
      if (!canvas) return;

      const rect = canvas.getBoundingClientRect();
      if (rect.width === 0 || rect.height === 0) return;

      const dpr = window.devicePixelRatio || 1;
      const ctx = canvas.getContext("2d");

      canvas.width = rect.width * dpr;
      canvas.height = rect.height * dpr;
      ctx.save();
      ctx.scale(dpr, dpr);
      ctx.clearRect(0, 0, rect.width, rect.height);
      
      const candles = chartState.candles;
      
      // If no indicators, clear and hide
      if (!chartState.indicators.volume && !chartState.indicators.rsi && !chartState.indicators.macd) {
          qs(".chart-sub-wrapper").style.display = "none";
          ctx.restore();
          return;
      }
      
      qs(".chart-sub-wrapper").style.display = "block";
      
      // --- Render Volume ---
      if (chartState.indicators.volume && candles && candles.length > 0) {
          const paddingLeft = 8;
          const paddingRight = chartState.yAxisWidth;
          const paddingTop = 10;
          const paddingBottom = 10;
          const width = rect.width - paddingLeft - paddingRight;
          const height = rect.height;
          const drawHeight = height - paddingTop - paddingBottom;

          const maxVol = Math.max(...candles.map(c => c.volume));
          if (maxVol <= 0) { ctx.restore(); return; }
          
          const candleCount = candles.length;
          const slotWidth = width / candleCount;
          const candleWidth = Math.max(4, slotWidth * 0.6);
          
          candles.forEach((c, i) => {
              const xCenter = paddingLeft + (i + 0.5) * slotWidth;
              const x = xCenter - candleWidth / 2;
              const volRatio = c.volume / maxVol;
              const barHeight = volRatio * drawHeight;
              const yTop = paddingTop + (drawHeight - barHeight);
              
              const isUp = c.close >= c.open;
              ctx.fillStyle = isUp ? "var(--success)" : "var(--danger)";
              ctx.globalAlpha = 0.3;
              ctx.fillRect(x, yTop, candleWidth, barHeight);
              ctx.globalAlpha = 1.0;
          });
      }
      
      // (Placeholder for RSI/MACD rendering)
      
      ctx.restore();
    }
    
    /**
     * Render orders and positions on the drawing canvas
     */
    function renderChartDrawings() {
        const canvas = qs("#draw-canvas");
        const mainChartCanvas = qs("#price-chart");
        if (!canvas || !mainChartCanvas) return;
        
        const rect = mainChartCanvas.getBoundingClientRect(); // Get size from main chart
        if (rect.width === 0 || rect.height === 0) return;

        const dpr = window.devicePixelRatio || 1;
        const ctx = canvas.getContext("2d");

        canvas.width = rect.width * dpr;
        canvas.height = rect.height * dpr;
        ctx.save();
        ctx.scale(dpr, dpr);
        ctx.clearRect(0, 0, rect.width, rect.height);
        
        const paddingLeft = 8;
        const paddingRight = chartState.yAxisWidth;
        const paddingTop = 10;
        const paddingBottom = 14;
        const width = rect.width - paddingLeft - paddingRight;
        const height = rect.height;
        
        const { minPrice, maxPrice } = chartState;

        // 1. Draw Open Orders (Spot)
        state.openOrders.forEach(o => {
            const y = yFor(o.price, minPrice, maxPrice, height, paddingTop, paddingBottom);
            const color = o.side === 'buy' ? 'var(--success)' : 'var(--danger)';
            const label = `${o.side.toUpperCase()} ${o.type} ${o.amount}`;
            
            ctx.beginPath();
            ctx.setLineDash([5, 3]);
            ctx.strokeStyle = color;
            ctx.lineWidth = 1;
            ctx.moveTo(paddingLeft, y);
            ctx.lineTo(width, y);
            ctx.stroke();
            ctx.setLineDash([]);
            
            ctx.fillStyle = color;
            ctx.fillRect(paddingLeft + 5, y - 8, ctx.measureText(label).width + 8, 16);
            ctx.fillStyle = '#ffffff';
            ctx.font = "10px system-ui";
            ctx.textBaseline = "middle";
            ctx.textAlign = "left";
            ctx.fillText(label, paddingLeft + 9, y);
        });
        
        // 2. Draw Open Positions (Futures)
        state.positions.forEach(p => {
            const y = yFor(p.entry, minPrice, maxPrice, height, paddingTop, paddingBottom);
            const color = p.side === 'long' ? 'var(--success)' : 'var(--danger)';
            const label = `${p.side.toUpperCase()} ${p.size} @ ${p.entry.toFixed(8)}`;
            
            // Draw entry price line
            ctx.beginPath();
            ctx.setLineDash([]);
            ctx.strokeStyle = color;
            ctx.lineWidth = 1;
            ctx.moveTo(paddingLeft, y);
            ctx.lineTo(width, y);
            ctx.stroke();

            // Calculate PnL for the box
            const markPrice = state.selectedMarket.last;
            const pnlValue = (markPrice - p.entry) * p.size * (p.side === 'long' ? 1 : -1);
            const pnlColor = pnlValue >= 0 ? 'var(--success)' : 'var(--danger)';
            const pnlLabel = `PnL: ${pnlValue.toFixed(4)}`;

            // Draw box at the end of the line
            const boxWidth = ctx.measureText(pnlLabel).width + 8;
            ctx.fillStyle = pnlColor;
            ctx.fillRect(width - boxWidth, y - 8, boxWidth, 16);
            
            ctx.fillStyle = '#ffffff';
            ctx.font = "10px system-ui";
            ctx.textBaseline = "middle";
            ctx.textAlign = "right";
            ctx.fillText(pnlLabel, width - 4, y);
        });

        ctx.restore();
    }


    // ==============================
    // CHART SETTINGS HANDLERS
    // ==============================
    function bindChartSettings() {
      // chart type
      qsa(".chart-type-btn").forEach(btn => {
        btn.addEventListener("click", () => {
          qsa(".chart-type-btn").forEach(b => b.classList.remove("active"));
          btn.classList.add("active");
          chartState.type = btn.dataset.chartType;
          logActivity(`Chart type: ${chartState.type}`);
          renderChart();
        });
      });

      // timeframe buttons
      qsa(".chart-mode-btn").forEach(btn => {
        btn.addEventListener("click", () => {
          qsa(".chart-mode-btn").forEach(b => b.classList.remove("active"));
          btn.classList.add("active");
          
          chartState.timeFrame = btn.dataset.tf || "1m";

          // Rebuild candles from state.trades
          chartState.candles = buildCandlesFromTrades(
            state.trades,
            chartState.timeFrame,
            80
          );

          // Recalculate price range
          const prices = chartState.candles.flatMap(c => [c.high, c.low]);
          if (prices.length > 0) {
            let minP = Math.min(...prices);
            let maxP = Math.max(...prices);
            const padding = (maxP - minP) * 0.1 || minP * 0.05;
            chartState.minPrice = minP - padding;
            chartState.maxPrice = maxP + padding;
          } else {
            // No data, use initChartData to set defaults
            initChartData();
          }

          logActivity(`Timeframe: ${chartState.timeFrame}`);
          renderChart();
        });
      });
      
      // NEW: Indicators
      const indBtn = qs("#chart-indicators-btn");
      const indPanel = qs("#indicators-panel");
      if (indBtn) indBtn.addEventListener("click", (e) => {
          e.stopPropagation();
          if (indPanel) indPanel.classList.toggle("active");
      });
      qsa("#indicators-panel input").forEach(check => {
          check.addEventListener("change", (e) => {
              const id = e.target.id;
              if (id === 'ind-vol') chartState.indicators.volume = e.target.checked;
              if (id === 'ind-rsi') chartState.indicators.rsi = e.target.checked;
              if (id === 'ind-macd') chartState.indicators.macd = e.target.checked;
              
              if (id !== 'ind-vol') { // Placeholders
                if(e.target.checked) showToast("Coming Soon", `${id.replace('ind-','').toUpperCase()} indicator is in development.`, "info");
                e.target.checked = false;
                chartState.indicators[id.replace('ind-','')] = false;
              }
              
              renderChart();
          });
      });
      

      // settings panel toggle
      const toggle = qs("#chart-settings-toggle");
      const panel = qs("#chart-settings-panel");
      if (toggle) {
        toggle.addEventListener("click", (e) => {
          e.stopPropagation();
          if (panel) panel.classList.toggle("active");
        });
      }

      // colors
      const candleUp = qs("#candle-up-color");
      if (candleUp) candleUp.addEventListener("input", (e) => {
        chartState.upColor = e.target.value;
        renderChart();
      });
      const candleDown = qs("#candle-down-color");
      if (candleDown) candleDown.addEventListener("input", (e) => {
        chartState.downColor = e.target.value;
        renderChart();
      });

      // grid / wicks
      const showGrid = qs("#show-grid");
      if (showGrid) showGrid.addEventListener("change", (e) => {
        chartState.showGrid = e.target.checked;
        renderChart();
      });
      const showWicks = qs("#show-wicks");
      if (showWicks) showWicks.addEventListener("change", (e) => {
        chartState.showWicks = e.target.checked;
        renderChart();
      });

      // theme
      const chartTheme = qs("#chart-theme");
      if (chartTheme) chartTheme.addEventListener("change", (e) => {
        setTheme(e.target.value);
      });

      // resize
      window.addEventListener("resize", () => {
        renderChart();
      });
    }

    // ==============================
    // UTILITIES & BINDINGS
    // ==============================
    function formatVol(v) {
      if (v > 1e9) return (v / 1e9).toFixed(2) + "B";
      if (v > 1e6) return (v / 1e6).toFixed(2) + "M";
      if (v > 1e3) return (v / 1e3).toFixed(2) + "K";
      return v.toFixed(2);
    }

    function bindEvents() {
      // nav tabs
      qsa(".nav-tab").forEach(btn => {
        btn.addEventListener("click", (e) => {
          e.preventDefault();
          qsa(".nav-tab").forEach(b => b.classList.remove("active"));
          btn.classList.add("active");
          
          const view = btn.dataset.view;
          if (view === "connect") {
            // 'Connect' tab now also tries to connect wallet
            connectAynuWallet();
          } else {
            switchView(view);
          }
        });
      });

      // market tabs
      qsa(".market-tab").forEach(btn => {
        btn.addEventListener("click", () => {
          qsa(".market-tab").forEach(b => b.classList.remove("active"));
          btn.classList.add("active");
          renderMarkets();
        });
      });
      
      const marketSearch = qs("#market-search-input");
      if (marketSearch) marketSearch.addEventListener("input", renderMarkets);
      
      const btnRefreshMarkets = qs("#btn-refresh-markets");
      if(btnRefreshMarkets) btnRefreshMarkets.addEventListener("click", () => {
        fetchCexSnapshot(); // Fetch all data
        showToast("Markets", "Markets refreshed", "info");
      });

      // REMOVED: mode tabs (now part of nav)

      // order form
      const orderTypeSelect = qs("#order-type");
      if (orderTypeSelect) orderTypeSelect.addEventListener("change", updateTradeFormUI);
      
      const inputPrice = qs("#input-price");
      if (inputPrice) inputPrice.addEventListener("input", recalcTrade);

      const inputAmount = qs("#input-amount");
      if (inputAmount) inputAmount.addEventListener("input", recalcTrade);

      qsa(".quick-btn").forEach(btn => {
        btn.addEventListener("click", () => handleQuickPct(parseFloat(btn.dataset.pct)));
      });
      qsa(".trade-side-btn").forEach(btn => {
        btn.addEventListener("click", () => {
          qsa(".trade-side-btn").forEach(b => b.classList.remove("active"));
          btn.classList.add("active");
          const side = btn.dataset.side;
          const submit = qs("#btn-submit-order");
          if (submit) {
            submit.classList.toggle("sell", side === "sell");
            if (state.connected) {
                if (state.mode === 'futures') {
                    submit.textContent = side === 'buy' ? "Open Long" : "Open Short";
                } else {
                    submit.textContent = side === 'buy' ? "Place Buy Order" : "Place Sell Order";
                }
            } else {
                submit.textContent = "Connect Wallet to Trade";
            }
          }
        });
      });
      const tradeForm = qs("#trade-form");
      if (tradeForm) tradeForm.addEventListener("submit", submitOrder);
      
      // NEW: Leverage Dropdown Logic
      const levBtn = qs("#leverage-dropdown-btn");
      const levPopover = qs("#leverage-popover");
      const levSlider = qs("#leverage-slider");
      const levDisplay = qs("#leverage-display"); // The one on the button
      const levCustomDisplay = qs("#leverage-custom-display"); // The one in the popover
      const levBadge = qs("#leverage-badge");

      // Function to set leverage
      function setLeverage(val) {
          val = parseInt(val);
          if (levSlider) levSlider.value = val;
          if (levDisplay) levDisplay.textContent = `${val}x`;
          if (levCustomDisplay) levCustomDisplay.textContent = `${val}x`;
          if (levBadge) levBadge.textContent = `Isolated · ${val}x`;
      }

      // Toggle Popover
      if (levBtn) levBtn.addEventListener("click", (e) => {
          e.stopPropagation();
          if (levPopover) levPopover.classList.toggle("active");
      });
      
      // Close popover when clicking outside
      window.addEventListener("click", (e) => {
          // Close leverage popover
          if (levPopover && levPopover.classList.contains("active") && !levPopover.contains(e.target) && e.target !== levBtn) {
              levPopover.classList.remove("active");
          }
          
          // Close indicators popover
          const indPanel = qs("#indicators-panel");
          const indBtn = qs("#chart-indicators-btn");
          if (indPanel && indPanel.classList.contains("active") && !indPanel.contains(e.target) && e.target !== indBtn) {
              indPanel.classList.remove("active");
          }
          
          // Close settings popover
          const setPanel = qs("#chart-settings-panel");
          const setBtn = qs("#chart-settings-toggle");
          if (setPanel && setPanel.classList.contains("active") && !setPanel.contains(e.target) && e.target !== setBtn) {
              setPanel.classList.remove("active");
          }
      });

      // Quick Buttons
      qsa(".leverage-quick-btn").forEach(btn => {
          btn.addEventListener("click", () => {
              setLeverage(btn.dataset.lev);
              if (levPopover) levPopover.classList.remove("active"); // Close on select
          });
      });

      // Slider Input
      if (levSlider) levSlider.addEventListener("input", (e) => {
          setLeverage(e.target.value);
      });


      // trades / orderbook buttons
      const btnSyncOrderbook = qs("#btn-sync-orderbook");
      if (btnSyncOrderbook) btnSyncOrderbook.addEventListener("click", () => {
        fetchDepthForCurrent().then(renderOrderbook);
        showToast("Orderbook", "Orderbook refreshed", "info");
      });
      const btnRefreshTrades = qs("#btn-refresh-trades");
      if (btnRefreshTrades) btnRefreshTrades.addEventListener("click", () => {
        fetchTradesForCurrent().then(renderTrades);
        showToast("Trades", "Trades refreshed", "info");
      });

      // wallet actions (in modal) - REMOVED
      
      const btnCloseAll = qs("#btn-close-all");
      if (btnCloseAll) btnCloseAll.addEventListener("click", () => {
        if (state.mode === 'futures' || state.mode === 'demo') {
            state.positions = [];
            showToast("Positions", "All positions closed (demo)", "info");
        } else {
            state.openOrders = [];
            showToast("Orders", "All orders cancelled (demo)","info");
        }
        renderActiveOrdersAndPositions();
        renderChartDrawings(); // Clear drawings
      });

      // Bind new auth button
      const btnConnect = qs("#btn-connect-wallet");
      if (btnConnect) btnConnect.addEventListener("click", connectAynuWallet);

      // REMOVED: wallet modal listeners

      // Chart settings
      bindChartSettings();

      // --- Chart Price Axis Interaction ---
      const canvas = qs("#price-chart");
      if (!canvas) {
        console.error("Chart canvas not found, interactions disabled.");
        return; // Exit if canvas not found
      }
      canvas.addEventListener("mousedown", (e) => {
        const rect = canvas.getBoundingClientRect();
        const x = e.offsetX;
        if (x > rect.width - chartState.yAxisWidth) {
          chartState.isDragging = true;
          chartState.lastDragY = e.clientY;
          canvas.classList.add("y-axis-grabbing");
          e.preventDefault();
        }
      });

      window.addEventListener("mousemove", (e) => {
        if (!chartState.isDragging) return;
        const deltaY = e.clientY - chartState.lastDragY;
        chartState.lastDragY = e.clientY;
        const rect = canvas.getBoundingClientRect();
        const height = rect.height - 10 - 14; // paddingTop/Bottom
        const priceRange = chartState.maxPrice - chartState.minPrice;
        if (height > 0 && priceRange > 0) {
            const pricePerPixel = priceRange / height;
            const priceDelta = deltaY * pricePerPixel;
            chartState.minPrice += priceDelta;
            chartState.maxPrice += priceDelta;
            renderChart();
        }
      });

      window.addEventListener("mouseup", () => {
        chartState.isDragging = false;
        canvas.classList.remove("y-axis-grabbing");
      });

      canvas.addEventListener("wheel", (e) => {
        const rect = canvas.getBoundingClientRect();
        const x = e.offsetX;
        if (x > rect.width - chartState.yAxisWidth) {
          e.preventDefault();
          const zoomFactor = e.deltaY > 0 ? 1.05 : 0.95;
          const priceRange = chartState.maxPrice - chartState.minPrice;
          const newRange = priceRange * zoomFactor;
          const midPrice = (chartState.maxPrice + chartState.minPrice) / 2;
          chartState.minPrice = midPrice - newRange / 2;
          chartState.maxPrice = midPrice + newRange / 2;
          renderChart();
        }
      });
      
      // REMOVED: Quick Wallet Listeners

      // Quick Actions HUD
      canvas.addEventListener("contextmenu", (e) => {
          e.preventDefault();
          const hud = qs("#quick-actions-hud");
          hud.style.display = 'flex';
          hud.style.top = `${e.clientY}px`;
          hud.style.left = `${e.clientX}px`;
      });
      window.addEventListener("click", (e) => {
          const hud = qs("#quick-actions-hud");
          if (hud && hud.style.display === 'flex' && !hud.contains(e.target)) {
              hud.style.display = 'none';
          }
      });
      
      const hudBuy = qs("#hud-buy-market");
      if (hudBuy) hudBuy.addEventListener("click", () => {
          showToast("Quick Action", "Executed: Buy Market (demo)", "success");
          qs("#quick-actions-hud").style.display = 'none';
      });
      
      const hudSell = qs("#hud-sell-market");
      if (hudSell) hudSell.addEventListener("click", () => {
          showToast("Quick Action", "Executed: Sell Market (demo)", "error");
          qs("#quick-actions-hud").style.display = 'none';
      });

      // Drawing Tools
      qsa(".drawing-tool-btn").forEach(btn => {
          btn.addEventListener("click", () => {
              qsa(".drawing-tool-btn").forEach(b => b.classList.remove("active"));
              btn.classList.add("active");
              chartState.currentTool = btn.dataset.tool;
              logActivity(`Draw tool: ${chartState.currentTool}`);
          });
      });

      // 3D Depth Map Button
      const depthBtn = qs("#btn-depth-chart");
      if(depthBtn) depthBtn.addEventListener("click", () => {
          showToast("3D Depth Map", "3D Depth Map will be shown here (in development)", "info");
      });
    }

    // ==============================
    // INIT
    // ==============================
    function init() {
      bindEvents();

      // Set initial page view
      switchView('spot');

      // Set initial theme
      applyTimeBasedTheme();

      logActivity("Aynu CEX UI Initialized · Connecting to AynuEngine via Node.");

      // Use real data from /cex/*
      initLiveData();
    }

    window.addEventListener("load", init);
  </script>

  <!-- REMOVED: Second script block for wallet page -->

</body>
</html>
