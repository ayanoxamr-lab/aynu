<!DOCTYPE html>
<html lang="en" data-theme="night"> <!-- NEW: Default theme set here -->
<head>
  <meta charset="UTF-8" />
  <title>Aynu CEX – AMRChain Cosmic Exchange</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    /* =========================
        GLOBAL RESET & VARIABLES
    ========================== */
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    :root {
      --bg-main: radial-gradient(circle at top, #181b3f 0%, #050617 45%, #020309 100%);
      --bg-panel: rgba(8, 11, 36, 0.96);
      --border-soft: rgba(137, 160, 255, 0.35);
      --border-strong: rgba(152, 180, 255, 0.75);
      --accent-1: #7b5bff;
      --accent-2: #37c5ff;
      --accent-3: #4caf50;
      --accent-4: #ff4b7d;
      --text-main: #f6f7ff;
      --text-muted: #a5afd9;
      --danger: #ff4b7d;
      --success: #4caf50;
      --warning: #ffb74d;
      --shadow-soft: 0 0 18px rgba(0, 0, 0, 0.85);
      --radius-lg: 16px;
      --radius-md: 10px;
      --radius-sm: 6px;
      --transition-fast: 0.15s ease;
      --transition-med: 0.25s ease;
      --nav-h: 64px;
    }
    
    /* NEW: Evening Theme */
    [data-theme="evening"] {
      --bg-main: radial-gradient(circle at top, #2a1b3f 0%, #170517 45%, #090209 100%);
      --bg-panel: rgba(22, 11, 36, 0.96);
      --border-soft: rgba(214, 137, 255, 0.35);
      --accent-1: #c05bff;
      --accent-2: #ff37a8;
    }


    /* NEW: Night Theme (Default) */
    [data-theme="night"] {
      --bg-main: radial-gradient(circle at top, #0f122e 0%, #050617 45%, #020309 100%);
      --bg-panel: rgba(10, 12, 34, 0.96);
      --border-soft: rgba(137, 160, 255, 0.35);
    }

    /* NEW: Holographic Theme */
    [data-theme="holographic"] {
      --bg-main: #020309;
      --bg-panel: rgba(10, 25, 40, 0.85);
      --border-soft: rgba(0, 255, 255, 0.4);
      --border-strong: rgba(0, 255, 255, 0.75);
      --accent-1: #00ffff;
      --accent-2: #ff00ff;
      --accent-3: #00ff00;
      --accent-4: #ff3333;
      --text-main: #f0f8ff;
      --text-muted: #88d4ff;
    }

    html, body {
      width: 100%;
      height: 100%;
      font-family: system-ui, -apple-system, BlinkMacSystemFont,"SF Pro Text","Segoe UI",sans-serif;
      background: #020309;
      color: var(--text-main);
      overflow-x: hidden; /* Allow vertical scroll, hide horizontal */
      overflow-y: auto;
    }
    body {
      background-image: var(--bg-main);
      background-attachment: fixed;
      transition: background var(--transition-med);
    }

    /* =========================
        COSMIC BACKGROUND
    ========================== */
    .cosmic-bg {
      position: fixed;
      inset: 0;
      pointer-events: none;
      z-index: 0;
      overflow: hidden;
    }
    .cosmic-layer {
      position: absolute;
      inset: -10%;
      background:
        radial-gradient(circle at 10% 20%, rgba(93, 151, 255, 0.18) 0, transparent 55%),
        radial-gradient(circle at 80% 10%, rgba(202, 114, 255, 0.25) 0, transparent 45%),
        radial-gradient(circle at 50% 90%, rgba(30, 225, 255, 0.18) 0, transparent 55%);
      filter: blur(1px);
      opacity: 0.8;
      animation: cosmicPulse 24s ease-in-out infinite alternate;
    }
    .starfield {
      position: absolute;
      inset: 0;
      background-image:
        radial-gradient(1px 1px at 10% 20%, rgba(255,255,255,0.6) 0, transparent 60%),
        radial-gradient(1px 1px at 45% 70%, rgba(175,200,255,0.8) 0, transparent 60%),
        radial-gradient(1px 1px at 80% 30%, rgba(200,220,255,0.9) 0, transparent 60%),
        radial-gradient(1px 1px at 15% 80%, rgba(150,190,255,0.7) 0, transparent 60%);
      opacity: 0.9;
      animation: starDrift 60s linear infinite;
    }
    @keyframes cosmicPulse {
      0%   { transform: scale(1) translate3d(0, 0, 0); opacity: 0.7; }
      50%  { transform: scale(1.08) translate3d(0, -10px, 0); opacity: 1; }
      100% { transform: scale(1.05) translate3d(0, 10px, 0); opacity: 0.8; }
    }
    @keyframes starDrift {
      0%   { transform: translateY(0); }
      100% { transform: translateY(40px); }
    }

    /* =========================
        APP LAYOUT
    ========================== */
    #app-root {
      position: relative;
      z-index: 1;
      min-height: 100vh; /* Use min-height for scroll */
      display: flex;
      flex-direction: column;
      backdrop-filter: blur(10px);
    }
    /* NEW: Page container for Spot/Futures/Metals */
    .page-container {
      flex: 1;
      display: flex;
      flex-direction: column;
      min-height: 0;
    }

    /* =========================
        TOP NAVBAR (SPACESHIP BRIDGE)
    ========================== */
    .top-nav {
      height: var(--nav-h);
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 16px;
      border-bottom: 1px solid var(--border-strong);
      background:
        linear-gradient(135deg, rgba(12, 16, 40, 0.96), rgba(6, 8, 22, 0.98));
      box-shadow: 0 6px 18px rgba(0, 0, 0, 0.85);
      flex-shrink: 0; /* Prevent nav from shrinking */
      position: sticky; /* Stick to top */
      top: 0;
      z-index: 10;
    }
    [data-theme="holographic"] .top-nav {
      background: rgba(10, 25, 40, 0.85);
      border-bottom: 1px solid var(--border-soft);
      backdrop-filter: blur(5px);
    }
    .nav-logo-area {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .nav-logo-orca {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background:
        radial-gradient(circle at 30% 25%, #ffffff 0, #d5e2ff 22%, #6f9bff 50%, #252848 70%, #02030f 100%);
      box-shadow:
        0 0 18px rgba(95, 140, 255, 0.9),
        0 0 32px rgba(99, 236, 255, 0.5);
      position: relative;
      overflow: hidden;
    }
    [data-theme="holographic"] .nav-logo-orca {
      box-shadow: 0 0 18px var(--accent-1), 0 0 32px var(--accent-1);
    }
    .nav-logo-orca::after {
      content: "";
      position: absolute;
      inset: 18%;
      border-radius: 50%;
      border: 2px solid rgba(255, 255, 255, 0.12);
      box-shadow: 0 0 24px rgba(255, 255, 255, 0.35);
    }
    .nav-logo-text {
      display: flex;
      flex-direction: column;
      line-height: 1.1;
    }
    .nav-logo-title {
      text-transform: uppercase;
      letter-spacing: 0.12em;
      font-weight: 700;
      font-size: 14px;
    }
    .nav-logo-sub {
      font-size: 11px;
      color: var(--text-muted);
    }

    .nav-main-menu {
      display: flex;
      align-items: center;
      gap: 6px;
      margin-left: 18px;
    }
    .nav-tab {
      border: none;
      background: transparent;
      color: var(--text-muted);
      font-size: 13px;
      padding: 6px 12px;
      border-radius: 999px;
      cursor: pointer;
      position: relative;
      overflow: hidden;
      transition: background var(--transition-fast), color var(--transition-fast), transform var(--transition-fast);
    }
    .nav-tab::before {
      content: "";
      position: absolute;
      inset: 0;
      background: linear-gradient(120deg, rgba(123, 91, 255, 0.0), var(--accent-1), rgba(55, 197, 255, 0.0));
      opacity: 0;
      transform: translateX(-20%);
      transition: opacity var(--transition-med), transform var(--transition-med);
    }
    .nav-tab span {
      position: relative;
      z-index: 1;
    }
    .nav-tab:hover {
      color: #ffffff;
      transform: translateY(-1px);
    }
    .nav-tab.active {
      background: radial-gradient(circle at top, var(--accent-1), rgba(40, 56, 128, 0.98));
      color: #ffffff;
      box-shadow: 0 0 14px var(--accent-1);
    }
    .nav-tab.active::before {
      opacity: 1;
      transform: translateX(0);
    }

    .nav-right {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .nav-status-pill {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 10px;
      border-radius: 999px;
      background: rgba(21, 29, 64, 0.88);
      border: 1px solid var(--border-soft);
      font-size: 11px;
      color: var(--text-muted);
    }
    .nav-status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: #f44336;
      box-shadow: 0 0 8px rgba(244, 67, 54, 0.8);
    }
    .nav-status-dot.online {
      background: #4caf50;
      box-shadow: 0 0 8px rgba(76, 175, 80, 0.9);
    }
    .nav-wallet-id {
      max-width: 240px;
      font-size: 11px;
      color: var(--text-muted);
      font-family: "JetBrains Mono", ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    .btn {
      border: 1px solid var(--border-strong);
      background: radial-gradient(circle at top, var(--accent-1), rgba(73, 33, 140, 0.98));
      color: #ffffff;
      font-size: 12px;
      padding: 6px 14px;
      border-radius: 999px;
      cursor: pointer;
      box-shadow: 0 0 12px var(--accent-1);
      transition: transform var(--transition-fast), box-shadow var(--transition-fast), background var(--transition-fast);
    }
    .btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 0 16px var(--accent-2);
    }
    .btn.secondary {
      background: rgba(16, 21, 54, 0.96);
      box-shadow: none;
    }
    .btn.small {
      font-size: 11px;
      padding: 4px 10px;
    }

    /* =========================
        MAIN GRID (BINANCE LAYOUT)
    ========================== */
    .main-layout {
      flex: 1;
      display: grid;
      grid-template-columns: 280px 1.8fr 280px;
      grid-template-rows: auto 1fr; /* Row 1 for HUD, Row 2 for content */
      gap: 10px;
      padding: 10px 12px 12px 12px;
      min-height: 0; /* Fix for flexbox overflow */
    }

    /* Top row: cosmic HUD / pair info */
    .hud-strip {
      grid-column: 1 / 4; /* Span all 3 columns */
      display: grid;
      grid-template-columns: 1.2fr repeat(4, 1fr);
      gap: 8px;
      padding: 6px 8px;
      border-radius: var(--radius-lg);
      background:
        radial-gradient(circle at top left, rgba(104, 146, 255, 0.6), transparent 60%),
        linear-gradient(120deg, rgba(11, 15, 40, 0.98), rgba(7, 10, 30, 0.98));
      border: 1px solid var(--border-soft);
      box-shadow: 0 0 20px rgba(0, 0, 0, 0.9);
    }
    [data-theme="holographic"] .hud-strip {
      background: var(--bg-panel);
      backdrop-filter: blur(5px);
    }
    .hud-block {
      display: flex;
      flex-direction: column;
      justify-content: center;
    }
    .hud-label {
      font-size: 11px;
      color: var(--text-muted);
    }
    .hud-value {
      font-size: 15px;
      font-weight: 600;
    }
    .hud-value.green {
      color: var(--success);
    }
    .hud-value.red {
      color: var(--danger);
    }
    .hud-value.small {
      font-size: 13px;
    }

    /* =========================
        PANEL BASE
    ========================== */
    .panel {
      border-radius: var(--radius-lg);
      background: var(--bg-panel);
      border: 1px solid var(--border-soft);
      box-shadow: var(--shadow-soft);
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }
    .panel-header {
      padding: 8px 10px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      border-bottom: 1px solid rgba(255, 255, 255, 0.04);
      background: linear-gradient(120deg, rgba(24, 30, 75, 0.96), rgba(14, 16, 44, 0.98));
      flex-shrink: 0; /* Prevent header from shrinking */
    }
    [data-theme="holographic"] .panel-header {
      background: rgba(0, 255, 255, 0.1);
    }
    .panel-title {
      font-size: 13px;
      font-weight: 600;
      letter-spacing: 0.04em;
    }
    .panel-actions {
      display: flex;
      align-items: center;
      gap: 4px;
    }
    .icon-btn {
      width: 22px;
      height: 22px;
      border-radius: 50%;
      border: none;
      background: rgba(24, 28, 65, 0.95);
      color: var(--text-muted);
      font-size: 12px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: background var(--transition-fast), transform var(--transition-fast), color var(--transition-fast);
    }
    .icon-btn:hover {
      background: var(--accent-1);
      color: #ffffff;
      transform: translateY(-1px);
    }

    /* =========================
        COLUMN LAYOUTS
    ========================== */
    /* Col 1: Orderbook */
    .orderbook-panel {
      grid-column: 1 / 2;
      grid-row: 2 / 3;
      min-height: 0;
    }
    /* Col 2: Center (Chart, Trade, Positions) */
    .center-column-layout {
      grid-column: 2 / 3;
      grid-row: 2 / 3;
      display: flex;
      flex-direction: column;
      gap: 8px;
      min-height: 0;
      position: relative; /* For drawing tools */
    }
    /* Col 3: Right (Markets, Trades) */
    .right-column-layout {
      grid-column: 3 / 4;
      grid-row: 2 / 3;
      display: flex;
      flex-direction: column;
      gap: 8px;
      min-height: 0;
    }
    
    
    /* =========================
        LEFT COL: ORDERBOOK
    ========================== */
    .orderbook-sides {
      flex: 1; /* Fill the panel */
      display: grid;
      grid-template-rows: 1fr auto 1fr; /* 50% asks, mid, 50% bids */
    }
    .order-side {
      padding: 4px 6px;
      font-size: 11px;
      overflow-y: auto;
    }
    .order-side.asks {
      background: radial-gradient(circle at top, rgba(255, 75, 125, 0.3), transparent 60%);
    }
    .order-side.bids {
      background: radial-gradient(circle at bottom, rgba(76, 175, 80, 0.3), transparent 60%);
    }
    [data-theme="holographic"] .order-side.asks {
      background: linear-gradient(to top, transparent, rgba(255, 0, 0, 0.25));
    }
    [data-theme="holographic"] .order-side.bids {
      background: linear-gradient(to bottom, transparent, rgba(0, 255, 0, 0.25));
    }
    .order-head-row {
      display: grid;
      grid-template-columns: 1.2fr 1fr 1.1fr;
      font-size: 10px;
      color: var(--text-muted);
      margin-bottom: 3px;
    }
    .order-row {
      position: relative;
      display: grid;
      grid-template-columns: 1.2fr 1fr 1.1fr;
      padding: 1px 2px;
    }
    .order-row span {
      padding: 0 2px;
    }
    .order-row::before {
      content: "";
      position: absolute;
      inset: 1px;
      border-radius: 3px;
      z-index: -1;
      opacity: 0.3;
    }
    .order-row.ask::before {
      background: linear-gradient(90deg, transparent, var(--danger));
    }
    .order-row.bid::before {
      background: linear-gradient(90deg, transparent, var(--success));
    }
    .order-mid {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 4px;
      font-size: 13px;
      font-weight: 600;
      border-top: 1px solid rgba(255, 255, 255, 0.06);
      border-bottom: 1px solid rgba(255, 255, 255, 0.06);
      background: radial-gradient(circle, rgba(110, 150, 255, 0.5), rgba(10, 16, 36, 0.96));
    }

    /* =========================
        CENTER COL: CHART
    ========================== */
    .mode-tabs {
      display: inline-flex;
      align-self: flex-start;
      margin: 2px 0 2px 2px;
      padding: 2px;
      border-radius: 999px;
      background: rgba(10, 14, 40, 0.95);
      border: 1px solid var(--border-soft);
      flex-shrink: 0;
    }
    .mode-tab {
      border: none;
      border-radius: 999px;
      padding: 5px 12px;
      font-size: 11px;
      color: var(--text-muted);
      background: transparent;
      cursor: pointer;
      transition: background var(--transition-fast), color var(--transition-fast), transform var(--transition-fast);
    }
    .mode-tab.active {
      background: radial-gradient(circle at top, var(--accent-1), rgba(70, 90, 160, 0.98));
      color: #ffffff;
      transform: translateY(-1px);
      box-shadow: 0 0 12px var(--accent-1);
    }
    
    .chart-panel {
      border-radius: var(--radius-lg);
      border: 1px solid var(--border-soft);
      background:
        radial-gradient(circle at top, rgba(120, 160, 255, 0.1), transparent 60%),
        rgba(8, 10, 30, 0.98);
      padding: 6px 8px;
      display: flex;
      flex-direction: column;
      gap: 4px;
      flex: 1; /* Make chart panel fill remaining space */
      min-height: 350px; /* Ensure it has a minimum height */
    }
    [data-theme="holographic"] .chart-panel {
      background: transparent;
    }
    .chart-toolbar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 11px;
      gap: 6px;
      flex-wrap: wrap;
    }
    .chart-modes {
      display: inline-flex;
      gap: 4px;
      flex-wrap: wrap;
    }
    .chart-mode-btn {
      border-radius: 999px;
      border: none;
      background: rgba(19, 24, 52, 0.96);
      color: var(--text-muted);
      padding: 3px 8px;
      font-size: 10px;
      cursor: pointer;
      transition: background var(--transition-fast), color var(--transition-fast), transform var(--transition-fast);
    }
    [data-theme="holographic"] .chart-mode-btn {
      background: rgba(0, 255, 255, 0.1);
    }
    .chart-mode-btn.active {
      background: linear-gradient(135deg, var(--accent-1), var(--accent-2));
      color: #ffffff;
      transform: translateY(-1px);
      box-shadow: 0 0 10px var(--accent-1);
    }
    .chart-controls {
      display: flex;
      align-items: center;
      gap: 6px;
      flex-wrap: wrap;
    }
    .chart-type-switch {
      display: inline-flex;
      border-radius: 999px;
      border: 1px solid var(--border-soft);
      overflow: hidden;
      background: rgba(10, 13, 40, 0.96);
    }
    [data-theme="holographic"] .chart-type-switch {
      background: rgba(0, 255, 255, 0.1);
    }
    .chart-type-btn {
      border: none;
      padding: 3px 8px;
      font-size: 10px;
      color: var(--text-muted);
      background: transparent;
      cursor: pointer;
      transition: background var(--transition-fast), color var(--transition-fast), transform var(--transition-fast);
    }
    .chart-type-btn.active {
      background: radial-gradient(circle at top, var(--accent-1), rgba(70, 90, 160, 0.98));
      color: #ffffff;
      transform: translateY(-1px);
      box-shadow: 0 0 8px var(--accent-1);
    }
    .chart-settings-toggle {
      border-radius: 999px;
      border: 1px solid var(--border-soft);
      background: rgba(16, 20, 52, 0.96);
      padding: 3px 8px;
      font-size: 10px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 4px;
      color: var(--text-muted);
      transition: background var(--transition-fast), color var(--transition-fast), transform var(--transition-fast);
    }
    .chart-settings-toggle:hover {
      background: var(--accent-1);
      color: #ffffff;
      transform: translateY(-1px);
      box-shadow: 0 0 10px var(--accent-1);
    }
    .chart-settings-panel {
      margin-top: 4px;
      border-radius: var(--radius-md);
      border: 1px solid var(--border-strong);
      background: rgba(5, 8, 26, 0.98);
      padding: 6px 8px;
      font-size: 10px;
      display: none;
      gap: 8px;
      flex-wrap: wrap;
    }
    .chart-settings-panel.active {
      display: flex;
    }
    .chart-settings-group {
      display: flex;
      flex-direction: column;
      gap: 3px;
      min-width: 120px;
    }
    .chart-settings-label {
      color: var(--text-muted);
    }
    .chart-settings-row {
      display: flex;
      align-items: center;
      gap: 4px;
    }
    .chart-settings-row input[type="color"] {
      width: 34px;
      height: 18px;
      padding: 0;
      border-radius: 4px;
      border: 1px solid var(--border-strong);
      background: transparent;
      cursor: pointer;
    }
    .chart-settings-row input[type="checkbox"] {
      cursor: pointer;
    }
    .chart-canvas {
      width: 100%;
      height: 100%; /* Fill parent chart-panel */
      border-radius: var(--radius-md);
      background:
        linear-gradient(180deg, rgba(21, 28, 68, 0.95), rgba(5, 6, 20, 0.98));
      position: relative;
      overflow: hidden;
    }
    [data-theme="holographic"] .chart-canvas {
      background: linear-gradient(180deg, rgba(10, 30, 45, 0.95), rgba(5, 10, 20, 0.98));
    }
    .chart-ohlc-row {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      font-size: 10px;
      color: var(--text-muted);
      margin-top: 4px;
      padding: 2px 0;
    }
    .chart-ohlc-row span {
      min-width: 80px;
    }
    .chart-ohlc-row .up {
      color: var(--success);
    }
    .chart-ohlc-row .down {
      color: var(--danger);
    }
    .chart-grid {
      position: absolute;
      inset: 0;
      background-image:
        linear-gradient(to right, rgba(255, 255, 255, 0.06) 1px, transparent 1px),
        linear-gradient(to top, rgba(255, 255, 255, 0.04) 1px, transparent 1px);
      background-size: 40px 30px;
      opacity: 0.3;
      pointer-events: none;
    }
    [data-theme="holographic"] .chart-grid {
      background-image:
        linear-gradient(to right, var(--border-soft) 1px, transparent 1px),
        linear-gradient(to top, var(--border-soft) 1px, transparent 1px);
      opacity: 0.15;
      animation: holographic-grid 10s linear infinite;
    }
    @keyframes holographic-grid {
      0% { background-position: 0 0; }
      100% { background-position: 40px 30px; }
    }
    .chart-line-bg {
      position: absolute;
      inset: 0;
      background: linear-gradient(120deg, var(--accent-3), var(--accent-1));
      opacity: 0.12;
      filter: blur(18px);
      transform-origin: left center;
      animation: chartWave 9s ease-in-out infinite alternate;
      pointer-events: none;
    }
    .chart-canvas canvas {
      position: absolute;
      inset: 0;
      width: 100%;
      height: 100%;
      display: block;
      cursor: crosshair;
    }
    .chart-canvas canvas.y-axis-grabbing {
      cursor: ns-resize;
    }
    @keyframes chartWave {
      0%   { transform: scaleY(0.8) translateY(5px); }
      50%  { transform: scaleY(1.05) translateY(-3px); }
      100% { transform: scaleY(0.9) translateY(3px); }
    }

    /* =========================
        CENTER COL: TRADE FORM
    ========================== */
    .trade-panel {
      display: flex;
      flex-direction: column;
      flex-shrink: 0; /* Prevent shrinking */
    }
    .trade-toggle {
      display: inline-flex;
      gap: 4px;
      margin: 6px 8px 4px 8px;
      padding: 2px;
      border-radius: 999px;
      border: 1px solid var(--border-soft);
      background: rgba(11, 14, 34, 0.98);
    }
    .trade-side-btn {
      border-radius: 999px;
      border: none;
      padding: 4px 10px;
      font-size: 11px;
      background: transparent;
      color: var(--text-muted);
      cursor: pointer;
      transition: background var(--transition-fast), color var(--transition-fast), transform var(--transition-fast);
    }
    .trade-side-btn.active.buy {
      background: linear-gradient(135deg, var(--success), #87e37a);
      color: #ffffff;
      transform: translateY(-1px);
      box-shadow: 0 0 10px var(--success);
    }
    .trade-side-btn.active.sell {
      background: linear-gradient(135deg, var(--danger), #ff8a65);
      color: #ffffff;
      transform: translateY(-1px);
      box-shadow: 0 0 10px var(--danger);
    }
    .trade-form {
      padding: 4px 8px 8px 8px;
      display: flex;
      flex-direction: column;
      gap: 6px;
      font-size: 11px;
    }
    .form-row {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }
    .form-row label {
      color: var(--text-muted);
      padding-left: 2px;
      font-weight: 500;
      text-transform: uppercase;
      letter-spacing: 0.02em;
    }
    .input-shell {
      display: flex;
      align-items: center;
      border-radius: var(--radius-md);
      border: 1px solid var(--border-soft);
      background: rgba(5, 7, 23, 0.98);
      overflow: hidden;
      transition: border-color var(--transition-fast), box-shadow var(--transition-fast);
    }
    .input-shell:hover {
      border-color: var(--border-strong);
    }
    .input-shell:focus-within {
      border-color: var(--accent-2);
      box-shadow: 0 0 8px var(--accent-2);
    }
    .input-shell input,
    .input-shell select {
      flex: 1;
      padding: 6px 10px;
      border: none;
      outline: none;
      background: transparent;
      color: var(--text-main);
      font-size: 13px;
      font-family: "JetBrains Mono", ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
    }
    .input-shell span.suffix {
      padding: 0 8px;
      border-left: 1px solid rgba(255, 255, 255, 0.06);
      font-size: 10px;
      color: var(--text-muted);
    }
    .quick-row {
      display: flex;
      gap: 4px;
    }
    .quick-btn {
      flex: 1;
      border-radius: 999px;
      border: 1px solid var(--border-soft);
      background: transparent;
      color: var(--text-muted);
      font-size: 10px;
      padding: 4px 0;
      cursor: pointer;
      transition: background var(--transition-fast), color var(--transition-fast);
    }
    .quick-btn:hover {
      background: radial-gradient(circle at top, var(--accent-1), rgba(54, 65, 137, 0.95));
      color: #ffffff;
    }
    .fee-row {
      font-size: 10px;
      color: var(--text-muted);
    }
    .trade-submit-btn {
      margin-top: 2px;
      border-radius: var(--radius-md);
      border: none;
      padding: 6px 0;
      font-size: 12px;
      cursor: pointer;
      background: linear-gradient(135deg, var(--success), #9ccc65);
      color: #ffffff;
      box-shadow: 0 0 12px var(--success);
      transition: transform var(--transition-fast), box-shadow var(--transition-fast);
    }
    .trade-submit-btn.sell {
      background: linear-gradient(135deg, var(--danger), #ff8a65);
      box-shadow: 0 0 12px var(--danger);
    }
    .trade-submit-btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 0 14px rgba(255, 255, 255, 0.7);
    }

    /* Digital Metals section (inside trade panel) */
    .metals-grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(140px, 1fr));
      gap: 8px;
      padding: 8px;
    }
    .metal-card {
      border-radius: var(--radius-md);
      border: 1px solid var(--border-soft);
      background:
        radial-gradient(circle at top, rgba(150, 134, 255, 0.3), transparent 60%),
        rgba(10, 13, 38, 0.98);
      padding: 6px 8px;
      display: flex;
      flex-direction: column;
      gap: 4px;
      box-shadow: 0 0 14px rgba(0, 0, 0, 0.7);
    }
    .metal-name {
      font-size: 12px;
      font-weight: 600;
    }
    .metal-tagline {
      font-size: 10px;
      color: var(--text-muted);
    }
    .metal-price {
      font-size: 11px;
      color: var(--accent-2);
    }
    .metal-badge-row {
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
      font-size: 10px;
    }
    .metal-badge {
      border-radius: 999px;
      padding: 2px 6px;
      background: rgba(8, 14, 40, 0.96);
      border: 1px solid var(--border-soft);
    }
    .metal-footer-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 4px;
    }
    .btn-metal-buy {
      border: none;
      border-radius: 999px;
      padding: 4px 10px;
      font-size: 11px;
      cursor: pointer;
      background: linear-gradient(135deg, var(--accent-1), var(--accent-2));
      color: #ffffff;
      box-shadow: 0 0 10px var(--accent-2);
      transition: transform var(--transition-fast), box-shadow var(--transition-fast);
    }
    .btn-metal-buy:hover {
      transform: translateY(-1px);
      box-shadow: 0 0 12px var(--accent-1);
    }

    /* =========================
        CENTER COL: POSITIONS
    ========================== */
    .positions-panel {
      flex: 1; /* Take remaining space */
      min-height: 150px; /* Min height */
    }
    .positions-table-wrapper {
      flex: 1;
      overflow-y: auto;
    }
    table.positions-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 11px;
    }
    table.positions-table thead {
      background: rgba(20, 25, 60, 0.98);
    }
    [data-theme="holographic"] table.positions-table thead {
      background: rgba(0, 255, 255, 0.1);
    }
    table.positions-table th,
    table.positions-table td {
      padding: 4px 6px;
      text-align: left;
    }
    .tag {
      font-size: 10px;
      padding: 2px 6px;
      border-radius: 999px;
      background: rgba(13, 21, 53, 0.96);
      border: 1px solid var(--border-soft);
      color: var(--text-muted);
    }
    .tag.long {
      color: var(--success);
      border-color: var(--success);
    }
    .tag.short {
      color: var(--danger);
      border-color: var(--danger);
    }

    /* =========================
        RIGHT COL: MARKETS
    ========================== */
    .market-panel {
      flex: 1.5; /* Give more space than trades */
      min-height: 200px;
    }
    .market-search {
      padding: 6px 10px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.04);
    }
    .market-search input {
      width: 100%;
      padding: 6px 8px;
      border-radius: var(--radius-md);
      border: 1px solid var(--border-soft);
      background: rgba(5, 7, 24, 0.98);
      color: var(--text-main);
      font-size: 12px;
      outline: none;
    }
    .market-tabs {
      display: flex;
      gap: 4px;
      padding: 4px 6px 6px 6px;
    }
    .market-tab {
      flex: 1;
      border-radius: 999px;
      border: 1px solid transparent;
      background: rgba(11, 15, 44, 0.96);
      color: var(--text-muted);
      font-size: 11px;
      padding: 3px 4px;
      cursor: pointer;
      transition: border var(--transition-fast), background var(--transition-fast), color var(--transition-fast);
    }
    .market-tab.active {
      border-color: var(--border-strong);
      background: radial-gradient(circle at top, var(--accent-1), rgba(45, 55, 122, 0.98));
      color: #ffffff;
      box-shadow: 0 0 12px var(--accent-1);
    }
    .market-table-wrapper {
      flex: 1;
      overflow-y: auto;
    }
    .market-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 11px;
    }
    .market-table thead {
      background: rgba(15, 20, 54, 0.98);
      position: sticky;
      top: 0;
      z-index: 1;
    }
    [data-theme="holographic"] .market-table thead {
      background: rgba(0, 255, 255, 0.1);
    }
    .market-table th,
    .market-table td {
      padding: 4px 6px;
      text-align: left;
    }
    .market-table tbody tr {
      cursor: pointer;
      transition: background var(--transition-fast);
    }
    .market-table tbody tr:nth-child(even) {
      background: rgba(10, 12, 32, 0.96);
    }
    [data-theme="holographic"] .market-table tbody tr:nth-child(even) {
      background: rgba(0, 255, 255, 0.03);
    }
    .market-table tbody tr:hover {
      background: radial-gradient(circle at left, var(--accent-1), rgba(17, 22, 55, 0.98));
    }
    .change-up {
      color: var(--success);
    }
    .change-down {
      color: var(--danger);
    }

    /* =========================
        RIGHT COL: RECENT TRADES
    ========================== */
    .trades-panel {
      pointer-events: auto;
      border-radius: var(--radius-lg);
      background: var(--bg-panel);
      border: 1px solid var(--border-soft);
      box-shadow: var(--shadow-soft);
      display: flex;
      flex-direction: column;
      overflow: hidden;
      flex: 1; /* Take remaining space */
      min-height: 150px;
    }
    .bottom-panel-header { /* Renamed from .bottom-panel-header */
      padding: 6px 8px;
      font-size: 12px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.05);
      background: linear-gradient(120deg, rgba(25, 31, 76, 0.96), rgba(10, 12, 36, 0.98));
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    [data-theme="holographic"] .bottom-panel-header {
      background: rgba(0, 255, 255, 0.1);
    }
    .bottom-panel-body { /* Renamed from .bottom-panel-body */
      flex: 1;
      overflow-y: auto;
    }
    table.trades-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 11px;
    }
    table.trades-table th,
    table.trades-table td {
      padding: 4px 6px;
      text-align: left;
    }
    table.trades-table thead {
      background: rgba(19, 24, 64, 0.98);
    }
    [data-theme="holographic"] table.trades-table thead {
      background: rgba(0, 255, 255, 0.1);
    }
    .buy-text {
      color: var(--success);
    }
    .sell-text {
      color: var(--danger);
    }

    /* =========================
        LOGIN / REGISTER / ZK-KYS MODAL
    ========================== */
    .modal-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(1, 2, 16, 0.85);
      backdrop-filter: blur(5px);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 20;
    }
    .modal-backdrop.active {
      display: flex;
    }
    .auth-modal {
      width: 340px;
      max-width: 95vw;
      border-radius: var(--radius-lg);
      border: 1px solid var(--border-strong);
      background:
        radial-gradient(circle at top, rgba(134, 168, 255, 0.45), transparent 65%),
        rgba(4, 6, 22, 0.98);
      box-shadow: 0 0 36px rgba(0, 0, 0, 0.92);
      padding: 12px 14px 14px;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    [data-theme="holographic"] .auth-modal {
      background:
        radial-gradient(circle at top, var(--accent-1), transparent 65%),
        rgba(4, 20, 30, 0.98);
      border: 1px solid var(--accent-1);
    }
    .auth-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .auth-title {
      font-size: 15px;
      font-weight: 600;
    }
    .auth-sub {
      font-size: 11px;
      color: var(--text-muted);
    }
    .auth-close {
      border-radius: 999px;
      border: none;
      background: rgba(12, 16, 40, 0.98);
      color: var(--text-muted);
      width: 22px;
      height: 22px;
      cursor: pointer;
      font-size: 12px;
    }
    .auth-form {
      display: flex;
      flex-direction: column;
      gap: 8px;
      margin-top: 4px;
    }
    .auth-row {
      display: flex;
      flex-direction: column;
      gap: 2px;
      font-size: 11px;
    }
    .auth-row label {
      color: var(--text-muted);
    }
    .auth-row input {
      border-radius: var(--radius-md);
      border: 1px solid var(--border-strong);
      background: rgba(5, 7, 26, 0.98);
      padding: 6px 8px;
      font-size: 12px;
      color: var(--text-main);
      outline: none;
    }
    .auth-row small {
      font-size: 10px;
      color: var(--text-muted);
    }
    .auth-actions {
      display: flex;
      justify-content: space-between;
      gap: 8px;
      margin-top: 4px;
    }
    .auth-btn {
      flex: 1;
      border-radius: 999px;
      border: none;
      padding: 6px 0;
      font-size: 12px;
      cursor: pointer;
      background: linear-gradient(135deg, var(--accent-1), var(--accent-2));
      color: #ffffff;
      box-shadow: 0 0 12px var(--accent-2);
    }
    .auth-btn.secondary {
      background: rgba(17, 23, 60, 0.98);
      box-shadow: none;
    }
    .auth-footer {
      margin-top: 6px;
      font-size: 10px;
      color: var(--text-muted);
    }
    .zk-pill {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 3px 8px;
      border-radius: 999px;
      border: 1px solid var(--border-strong);
      background: rgba(4, 12, 28, 0.98);
      font-size: 10px;
      color: var(--text-muted);
    }
    .zk-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: rgba(80, 227, 194, 0.95);
      box-shadow: 0 0 10px rgba(128, 222, 234, 0.9);
    }

    /* Toasts */
    .toast-container {
      position: fixed;
      right: 16px;
      top: calc(var(--nav-h) + 16px);
      bottom: auto; 
      display: flex;
      flex-direction: column;
      gap: 6px;
      z-index: 30;
    }
    .toast {
      min-width: 220px;
      max-width: 320px;
      border-radius: var(--radius-md);
      background: rgba(10, 12, 34, 0.98);
      border: 1px solid var(--border-strong);
      box-shadow: var(--shadow-soft);
      padding: 6px 8px;
      font-size: 11px;
    }
    .toast-title {
      font-weight: 600;
      margin-bottom: 2px;
    }
    .toast-msg {
      color: var(--text-muted);
    }
    .toast.success {
      border-color: var(--success);
    }
    .toast.error {
      border-color: var(--danger);
    }
    .toast.info {
      border-color: var(--accent-2);
    }

    /* =========================
        NEW: FUTURES/METALS PLACEHOLDER
    ========================== */
    .placeholder-page {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      text-align: center;
      flex: 1;
      padding: 40px;
      gap: 12px;
    }
    .placeholder-title {
      font-size: 24px;
      font-weight: 600;
      color: var(--text-main);
    }
    .placeholder-sub {
      font-size: 16px;
      color: var(--text-muted);
      max-width: 400px;
    }

    /* =========================
        NEW: HOLOGRAPHIC METALS VAULT
    ========================== */
    .vault-layout {
      flex: 1;
      display: flex;
      flex-direction: column;
      padding: 16px;
      gap: 16px;
    }
    .vault-display {
      flex-basis: 300px;
      flex-shrink: 0;
      border-radius: var(--radius-lg);
      border: 1px solid var(--border-soft);
      background: var(--bg-panel);
      display: flex;
      align-items: center;
      justify-content: center;
      perspective: 800px; /* 3D space */
      position: relative;
      overflow: hidden;
    }
    .hologram-object {
      width: 150px;
      height: 150px;
      transform-style: preserve-3d;
      animation: hologram-rotate 20s linear infinite;
    }
    .hologram-face {
      position: absolute;
      width: 100%;
      height: 100%;
      border-radius: 10px;
      background: linear-gradient(135deg, var(--accent-1), var(--accent-2));
      box-shadow: 0 0 20px var(--accent-1), 0 0 40px var(--accent-2);
      opacity: 0.8;
    }
    /* Simple 3D cube effect */
    .hologram-face.front  { transform: translateZ(75px); }
    .hologram-face.back   { transform: translateZ(-75px) rotateY(180deg); }
    .hologram-face.left   { transform: translateX(-75px) rotateY(-90deg); }
    .hologram-face.right  { transform: translateX(75px) rotateY(90deg); }
    .hologram-face.top    { transform: translateY(-75px) rotateX(90deg); }
    .hologram-face.bottom { transform: translateY(75px) rotateX(-90deg); }

    .hologram-info {
      position: absolute;
      bottom: 20px;
      left: 20px;
      color: var(--text-main);
      text-shadow: 0 0 5px #000;
    }
    .hologram-title {
      font-size: 22px;
      font-weight: 600;
    }
    .hologram-price {
      font-size: 16px;
      color: var(--text-muted);
    }
    @keyframes hologram-rotate {
      0% { transform: rotateY(0deg) rotateX(10deg); }
      100% { transform: rotateY(360deg) rotateX(10deg); }
    }

    .vault-grid {
      flex: 1;
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 12px;
      overflow-y: auto;
    }
    .vault-metal-card {
      border-radius: var(--radius-md);
      border: 1px solid var(--border-soft);
      background: var(--bg-panel);
      padding: 12px;
      display: flex;
      flex-direction: column;
      gap: 6px;
      cursor: pointer;
      transition: transform var(--transition-fast), box-shadow var(--transition-fast);
    }
    .vault-metal-card:hover {
      transform: translateY(-3px);
      box-shadow: 0 0 20px var(--accent-1);
      border-color: var(--border-strong);
    }
    .vault-metal-name {
      font-size: 16px;
      font-weight: 600;
      color: var(--text-main);
    }
    .vault-metal-tagline {
      font-size: 12px;
      color: var(--text-muted);
    }
    .vault-metal-price {
      font-size: 13px;
      color: var(--accent-2);
      margin-top: auto;
    }

    /* =========================
        NEW: QUICK ACTIONS HUD
    ========================== */
    #quick-actions-hud {
      position: fixed;
      display: none;
      flex-direction: column;
      gap: 4px;
      background: rgba(10, 15, 40, 0.9);
      border: 1px solid var(--border-strong);
      border-radius: var(--radius-md);
      padding: 6px;
      z-index: 100;
      backdrop-filter: blur(5px);
      box-shadow: 0 0 20px rgba(0,0,0,0.5);
    }
    .quick-action-btn {
      border: none;
      background: rgba(30, 40, 80, 0.8);
      color: var(--text-main);
      padding: 6px 10px;
      border-radius: var(--radius-sm);
      font-size: 12px;
      cursor: pointer;
      text-align: left;
      transition: background var(--transition-fast);
    }
    .quick-action-btn:hover {
      background: var(--accent-1);
    }

    /* =========================
        NEW: DRAWING TOOLBAR
    ========================== */
    .chart-drawing-toolbar {
      position: absolute;
      left: 10px;
      top: 100px;
      display: flex;
      flex-direction: column;
      gap: 4px;
      background: rgba(10, 15, 40, 0.9);
      border: 1px solid var(--border-soft);
      border-radius: var(--radius-md);
      padding: 6px;
      z-index: 5;
    }
    .drawing-tool-btn {
      width: 32px;
      height: 32px;
      border: none;
      border-radius: var(--radius-sm);
      background: rgba(30, 40, 80, 0.8);
      color: var(--text-muted);
      cursor: pointer;
      transition: background var(--transition-fast), color var(--transition-fast);
      padding: 6px;
    }
    .drawing-tool-btn:hover {
      background: var(--accent-1);
      color: var(--text-main);
    }
    .drawing-tool-btn.active {
      background: var(--accent-2);
      color: var(--text-main);
      box-shadow: 0 0 8px var(--accent-2);
    }
    .drawing-tool-btn svg {
      width: 100%;
      height: 100%;
      stroke-width: 2;
    }

    /* =========================
        NEW: ORDER ANIMATION
    ========================== */
    .order-animation-line {
      position: fixed;
      width: 2px;
      height: 2px;
      background: var(--success);
      box-shadow: 0 0 5px var(--success), 0 0 10px var(--success);
      border-radius: 50%;
      z-index: 1000;
      transition: transform 0.5s cubic-bezier(0.5, 0, 1, 0.5), opacity 0.3s 0.2s;
      pointer-events: none;
    }


    /* =========================
        RESPONSIVE
    ========================== */
    @media (max-width: 1180px) {
      .main-layout {
        /* Switch to 2-col layout */
        grid-template-columns: 1.5fr 1fr;
        grid-template-rows: auto auto 1fr;
      }
      .hud-strip {
        grid-column: 1 / 3;
      }
      .orderbook-panel {
        grid-column: 1 / 2;
        grid-row: 2 / 3;
      }
      .right-column-layout { /* Markets/Trades */
        grid-column: 2 / 3;
        grid-row: 2 / 4; /* Span 2 rows */
      }
      .center-column-layout { /* Chart/Trade/Positions */
        grid-column: 1 / 2;
        grid-row: 3 / 4;
      }
    }
    @media (max-width: 900px) {
      body {
        overflow-y: auto;
      }
      .main-layout {
        display: flex;
        flex-direction: column;
        height: auto;
        padding-bottom: 12px;
      }
      /* All panels stack vertically */
    }
    @media (max-width: 720px) {
      .top-nav {
        flex-wrap: wrap;
        gap: 6px;
        height: auto;
        padding-bottom: 8px;
      }
      .nav-main-menu {
        width: 100%;
        justify-content: center;
        flex-wrap: wrap;
      }
      .nav-right {
        width: 100%;
        justify-content: flex-end;
      }
      .hud-strip {
        grid-template-columns: repeat(2, minmax(0, 1fr));
        grid-auto-rows: auto;
      }
    }


    /* =========================
        NEW: RIGHT COL: QUICK WALLET
    ========================== */
    .quick-wallet-panel-body {
      padding: 8px 10px;
      display: flex;
      flex-direction: column;
      gap: 10px;
      flex: 1;
      overflow-y: auto;
    }
    .wallet-asset-row {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      border-bottom: 1px solid var(--border-soft);
      padding-bottom: 6px;
    }
    .wallet-asset-row:last-child {
      border-bottom: none;
    }
    .wallet-asset-info {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    .wallet-asset-name {
      font-size: 14px;
      font-weight: 600;
      color: var(--accent-2);
    }
    [data-theme="holographic"] .wallet-asset-name {
      color: var(--accent-1);
    }
    .wallet-asset-balances {
      font-size: 11px;
      display: flex;
      flex-direction: column;
      gap: 2px;
    }
    .balance-line {
      display: flex;
      justify-content: space-between;
      min-width: 140px;
      gap: 8px;
    }
    .balance-line span:first-child {
      color: var(--text-muted);
    }
    .balance-line span:last-child {
      color: var(--text-main);
      font-family: "JetBrains Mono", monospace;
    }
    .wallet-asset-actions {
      display: flex;
      flex-direction: column;
      gap: 4px;
      align-items: flex-end;
    }
    .quick-wallet-btn {
      padding: 3px 8px;
      font-size: 10px;
      min-width: 60px;
      text-align: center;
    }
  </style>
</head>
<body data-theme="night"> <!-- Default theme -->
  <!-- COSMIC BACKGROUND -->
  <div class="cosmic-bg">
    <div class="cosmic-layer"></div>
    <div class="starfield"></div>
  </div>

  <!-- APP ROOT -->
  <div id="app-root">
    <!-- TOP NAVBAR -->
    <header class="top-nav">
      <div class="nav-logo-area">
        <div class="nav-logo-orca"></div>
        <div class="nav-logo-text">
          <span class="nav-logo-title">AYNU CEX</span>
          <span class="nav-logo-sub">AMRChain · IonFluid · Digital Metals</span>
        </div>
        <nav class="nav-main-menu">
          <!-- NEW: data-view attributes for page switching -->
          <button class="nav-tab" data-view="kyc"><span>home</span></button>
          <button class="nav-tab active" data-view="spot"><span>Spot</span></button>
          <button class="nav-tab" data-view="futures"><span>Futures</span></button>
          <button class="nav-tab" data-view="metals"><span>Metals Vault</span></button>
          <button class="nav-tab" data-view="wallet"><span>Wallet</span></button>
          <button class="nav-tab" data-view="dex"><span>dex</span></button>
          <button class="nav-tab" data-view="demo"><span>demo</span></button>
         

        </nav>
      </div>
      <div class="nav-right">
        <div class="nav-status-pill" id="status-pill">
          <span class="nav-status-dot" id="status-dot"></span>
          <span id="status-text">RPC: Disconnected</span>
        </div>
        <span class="nav-wallet-id" id="wallet-label">Wallet: Not linked</span>
        <button class="btn secondary small" id="btn-open-auth">Login / Register</button>
      </div>
    </header>

    <!-- =========================
        PAGE CONTAINER: SPOT
    ========================== -->
    <div class="page-container" id="page-spot">
      <main class="main-layout">
        <!-- HUD STRIP -->
        <section class="hud-strip">
          <div class="hud-block">
            <span class="hud-label">Pair</span>
            <span class="hud-value" id="hud-pair">AMR / NVR</span>
          </div>
          <div class="hud-block">
            <span class="hud-label">Last Price (NVR)</span>
            <span class="hud-value" id="hud-last">0.00005000</span>
          </div>
          <div class="hud-block">
            <span class="hud-label">24h Change</span>
            <span class="hud-value green" id="hud-change">+0.00%</span>
          </div>
          <div class="hud-block">
            <span class="hud-label">24h High</span>
            <span class="hud-value small" id="hud-high">0.00006000</span>
          </div>
          <div class="hud-block">
            <span class="hud-label">24h Low</span>
            <span class="hud-value small" id="hud-low">0.00004000</span>
          </div>
        </section>

        <!-- Col 1: Orderbook -->
        <div class="panel orderbook-panel">
          <div class="panel-header">
            <span class="panel-title" id="orderbook-title">Spot Orderbook</span>
            <div class="panel-actions">
              <button class="icon-btn" id="btn-depth-chart" title="3D Depth Map">⧉</button>
              <button class="icon-btn" id="btn-sync-orderbook" title="Resync">⟳</button>
            </div>
          </div>
          <div class="orderbook-sides">
            <div class="order-side asks">
              <div class="order-head-row">
                <span>Price</span>
                <span>Amount</span>
                <span>Total</span>
              </div>
              <div id="asks-body"></div>
            </div>
            <div class="order-mid">
              <span id="mid-price">0.00005000</span>
              <span style="font-size:10px;color:var(--text-muted)">NVR</span>
            </div>
            <div class="order-side bids">
              <div class="order-head-row">
                <span>Price</span>
                <span>Amount</span>
                <span>Total</span>
              </div>
              <div id="bids-body"></div>
            </div>
          </div>
        </div>
        
        <!-- Col 2: Chart, Trade, Positions -->
        <section class="center-column-layout">
          <!-- NEW: Drawing Toolbar -->
          <div class="chart-drawing-toolbar" id="drawing-toolbar">
            <button class="drawing-tool-btn active" data-tool="crosshair" title="Crosshair">
              <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4"></path></svg>
            </button>
            <button class="drawing-tool-btn" data-tool="trendline" title="Trend Line">
              <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M4.5 19.5l15-15m-15 0l15 15"></path></svg>
            </button>
            <button class="drawing-tool-btn" data-tool="horizontal" title="Horizontal Line">
              <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M4 12h16"></path></svg>
            </button>
            <button class="drawing-tool-btn" data-tool="fibo" title="Fibonacci">
              <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M4 4h16M4 8h16M4 12h10M4 16h6"></path></svg>
            </button>
             <button class="drawing-tool-btn" data-tool="rect" title="Rectangle">
              <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><rect x="4" y="6" width="16" height="12"></rect></svg>
            </button>
             <button class="drawing-tool-btn" data-tool="brush" title="Brush">
              <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.536L16.732 3.732z"></path></svg>
            </button>
          </div>

          <div class="mode-tabs">
            <button class="mode-tab active" data-mode="spot">Spot</button>
            <button class="mode-tab" data-mode="futures">Futures</button>
            <button class="mode-tab" data-mode="metals">Metals</button>
          </div>
          
          <div class="panel chart-panel">
              <div class="chart-toolbar">
                <div style="display:flex;flex-direction:column;gap:2px;">
                  <span style="font-size:11px;">Cosmic Price Trace</span>
                  <span style="font-size:10px;color:var(--text-muted);" id="chart-subtitle">
                    Interactive OHLC Chart
                  </span>
                </div>
                <div class="chart-controls">
                  <div class="chart-type-switch">
                    <button class="chart-type-btn active" data-chart-type="candles">Candles</button>
                    <button class="chart-type-btn" data-chart-type="line">Line</button>
                  </div>
                  <div class="chart-modes">
                    <button class="chart-mode-btn active" data-tf="1m">1m</button>
                    <button class="chart-mode-btn" data-tf="15m">15m</button>
                    <button class="chart-mode-btn" data-tf="1h">1h</button>
                    <button class="chart-mode-btn" data-tf="4h">4h</button>
                    <button class="chart-mode-btn" data-tf="1d">1d</button>
                  </div>
                  <button class="chart-settings-toggle" id="chart-settings-toggle">
                    ⚙ Chart Style
                  </button>
                </div>
              </div>
              <div class="chart-ohlc-row" id="chart-ohlc-row"></div>
              <div class="chart-settings-panel" id="chart-settings-panel">
                <div class="chart-settings-group">
                  <span class="chart-settings-label">Candle Colors</span>
                  <div class="chart-settings-row">
                    <span>Up</span>
                    <input type="color" id="candle-up-color" value="#4caf50" />
                    <span>Down</span>
                    <input type="color" id="candle-down-color" value="#ff4b7d" />
                  </div>
                </div>
                <div class="chart-settings-group">
                  <span class="chart-settings-label">Visibility</span>
                  <div class="chart-settings-row">
                    <label><input type="checkbox" id="show-grid" checked /> Grid</label>
                  </div>
                  <div class="chart-settings-row">
                    <label><input type="checkbox" id="show-wicks" checked /> Wicks</label>
                  </div>
                </div>
                <div class="chart-settings-group">
                  <span class="chart-settings-label">Theme</span>
                  <div class="chart-settings-row">
                    <select id="chart-theme" style="font-size:10px;padding:2px 4px;border-radius:6px;border:1px solid rgba(150,176,255,0.9);background:#05071a;color:var(--text-main);">
                      <option value="night">Night (Default)</option>
                      <option value="evening">Evening</option>
                      <option value="holographic">Holographic</option>
                    </select>
                  </div>
                </div>
              </div>
              <div class="chart-canvas">
                <div class="chart-grid" id="chart-grid-layer"></div>
                <div class="chart-line-bg" id="chart-line-bg"></div>
                <canvas id="price-chart"></canvas>
              </div>
          </div>

          <div class="panel trade-panel">
            <div class="panel-header">
              <span class="panel-title" id="trade-panel-title">Spot Trade – AMR / NVR</span>
              <div class="panel-actions">
                <span class="tag" id="leverage-badge">Cross · 1x</span>
              </div>
            </div>
            <div id="trade-forms-wrapper">
              <div class="trade-toggle">
                <button class="trade-side-btn active buy" data-side="buy">Buy</button>
                <button class="trade-side-btn sell" data-side="sell">Sell</button>
              </div>
              <form class="trade-form" id="trade-form">
                <div class="form-row">
                  <label for="order-type">Order Type</label>
                  <div class="input-shell">
                    <select id="order-type">
                      <option value="limit">Limit</option>
                      <option value="market">Market</option>
                    </select>
                    <span class="suffix" id="order-type-label">Spot</span>
                  </div>
                </div>
                <div class="form-row">
                  <label>Price</label>
                  <div class="input-shell">
                    <input type="number" id="input-price" step="0.00000001" min="0" />
                    <span class="suffix" id="price-quote">NVR</span>
                  </div>
                </div>
                <div class="form-row">
                  <label>Amount</label>
                  <div class="input-shell">
                    <input type="number" id="input-amount" step="0.00000001" min="0" />
                    <span class="suffix" id="amount-base">AMR</span>
                  </div>
                </div>
                <div class="form-row">
                  <label>Total</label>
                  <div class="input-shell">
                    <input type="text" id="input-total" readonly />
                    <span class="suffix" id="total-quote">NVR</span>
                  </div>
                </div>
                <div class="form-row">
                  <label>Balance (Quote)</label>
                  <div class="input-shell">
                    <input type="text" id="balance-quote" readonly />
                    <span class="suffix" id="balance-quote-symbol">NVR</span>
                  </div>
                </div>
                <div class="form-row">
                  <div class="quick-row">
                    <button type="button" class="quick-btn" data-pct="25">25%</button>
                    <button type="button" class="quick-btn" data-pct="50">50%</button>
                    <button type="button" class="quick-btn" data-pct="75">75%</button>
                    <button type="button" class="quick-btn" data-pct="100">100%</button>
                  </div>
                </div>
                <div class="fee-row">
                  Fee: <span id="fee-rate">0.10%</span> · Est: <span id="fee-estimate">0.00000000</span> NVR
                </div>
                <button class="trade-submit-btn" id="btn-submit-order" type="submit">
                  Login to Trade
                </button>
              </form>
            </div>
            <div id="metals-wrapper" style="display:none;">
              <div style="padding:6px 8px 2px 8px;font-size:11px;color:var(--text-muted);">
                Buy asset-backed digital metals on AMRChain.
              </div>
              <div class="metals-grid" id="metals-grid"></div>
            </div>
          </div>

          <div class="panel positions-panel">
            <div class="panel-header">
              <span class="panel-title" id="active-panel-title">Open Positions (Futures)</span>
              <div class="panel-actions">
                <button class="icon-btn" id="btn-close-all">⨉</button>
              </div>
            </div>
            <div class="positions-table-wrapper">
              <table class="positions-table">
                <thead id="active-orders-thead">
                  <tr>
                    <th>Pair</th>
                    <th>Side</th>
                    <th>Size</th>
                    <th>Entry</th>
                    <th>PnL</th>
                  </tr>
                </thead>
                <tbody id="active-tbody"></tbody>
              </table>
            </div>
          </div>
        </section>
        <aside class="panel quick-wallet-panel">
            <div class="panel-header">
              <span class="panel-title">المحفظة السريعة</span>
              <div class="panel-actions">
                <button class="icon-btn" id="btn-refresh-quick-wallet" title="تحديث الأرصدة">⟳</button>
              </div>
            </div>
            <div class="quick-wallet-panel-body" id="quick-wallet-body">
                            <div class="wallet-asset-row">
                <div class="wallet-asset-info">
                  <span class="wallet-asset-name">AMR</span>
                  <div class="wallet-asset-balances">
                    <div class="balance-line"><span>المتاح:</span> <span>0.0000</span></div>
                    <div class="balance-line"><span>في الطلبات:</span> <span>0.0000</span></div>
                  </div>
                </div>
                <div class="wallet-asset-actions">
                  <button class="btn small secondary quick-wallet-btn">إيداع</button>
                  <button class="btn small secondary quick-wallet-btn">سحب</button>
                </div>
              </div>
              <div class="wallet-asset-row">
                <div class="wallet-asset-info">
                  <span class="wallet-asset-name">NVR</span>
                  <div class="wallet-asset-balances">
                    <div class="balance-line"><span>المتاح:</span> <span>0.0000</span></div>
                    <div class="balance-line"><span>في الطلبات:</span> <span>0.0000</span></div>
                  </div>
                </div>
                <div class="wallet-asset-actions">
                  <button class="btn small secondary quick-wallet-btn">إيداع</button>
                  <button class="btn small secondary quick-wallet-btn">سحب</button>
                </div>
              </div>
            </div>
          </aside>
        <!-- Col 3: Markets, Trades -->
        <section class="right-column-layout">
          <aside class="panel market-panel">
            <div class="panel-header">
              <span class="panel-title">Markets</span>
              <div class="panel-actions">
                <button class="icon-btn" id="btn-refresh-markets" title="Refresh">⟳</button>
              </div>
            </div>
            <div class="market-search">
              <input type="text" id="market-search-input" placeholder="Search pair (e.g. AMR/NVR)" />
            </div>
            <div class="market-tabs">
              <button class="market-tab active" data-market-tab="all">All</button>
              <button class="market-tab" data-market-tab="amr">AMR</button>
              <button class="market-tab" data-market-tab="nvr">NVR</button>
              <button class="market-tab" data-market-tab="ionx">IONX</button>
              <button class="market-tab" data-market-tab="fav">★</button>
            </div>
            <div class="market-table-wrapper">
              <table class="market-table">
                <thead>
                  <tr>
                    <th>Pair</th>
                    <th>Last</th>
                    <th>24h%</th>
                    <th>Vol</th>
                  </tr>
                </thead>
                <tbody id="market-body"></tbody>
              </table>
            </div>
          </aside>

          <div class="trades-panel">
            <div class="bottom-panel-header">
              <span>Recent Trades</span>
              <button class="icon-btn" id="btn-refresh-trades">⟳</button>
            </div>
            <div class="bottom-panel-body">
              <table class="trades-table">
                <thead>
                  <tr>
                    <th>Time</th>
                    <th>Price</th>
                    <th>Amount</th>
                    <th>Side</th>
                  </tr>
                </thead>
                <tbody id="trades-body"></tbody>
              </table>
            </div>
          </div>
          
          <div class="trades-panel">
            <div class="bottom-panel-header">
              <span>System Activity</span>
            </div>
            <div class="bottom-panel-body" id="activity-log" style="font-size:11px;color:var(--text-muted);padding:4px 6px;"></div>
          </div>
        </section>
        
      </main>
    </div> <!-- End #page-spot -->

    <!-- =========================
        PAGE CONTAINER: FUTURES (Placeholder)
    ========================== -->
    <div class="page-container" id="page-futures" style="display:none;">
      <div class="placeholder-page">
        <div class="placeholder-title">Futures Trading</div>
        <div class="placeholder-sub">The dedicated layout for futures, perpetuals, and derivatives trading will be built here.</div>
      </div>
    </div>

    <!-- =========================
        PAGE CONTAINER: METALS VAULT (NEW)
    ========================== -->
    <div class="page-container" id="page-metals" style="display:none;">
      <div class="vault-layout">
        <!-- Main Hologram Display -->
        <div class="vault-display">
          <div class="hologram-object" id="hologram-object">
            <!-- Cube faces -->
            <div class="hologram-face front"></div>
            <div class="hologram-face back"></div>
            <div class="hologram-face left"></div>
            <div class="hologram-face right"></div>
            <div class="hologram-face top"></div>
            <div class="hologram-face bottom"></div>
          </div>
          <div class="hologram-info">
            <div class="hologram-title" id="hologram-title">Lexirium</div>
            <div class="hologram-price" id="hologram-price">Price: 500.0 NVR</div>
          </div>
        </div>
        <!-- Grid of Metals to Select -->
        <div class="vault-grid" id="vault-metals-grid">
          <!-- Populated by JS -->
        </div>
      </div>
    </div>


    <!-- =========================
        MODALS & OVERLAYS
    ========================== -->

    <!-- NEW: Quick Actions HUD -->
    <div id="quick-actions-hud">
      <button class="quick-action-btn" id="hud-buy-market">Buy Market</button>
      <button class="quick-action-btn" id="hud-sell-market">Sell Market</button>
      <button class="quick-action-btn" id="hud-buy-limit">Buy Limit</button>
      <button class="quick-action-btn" id="hud-draw-line">Draw Line</button>
    </div>

    <!-- AUTH / ZK-KYS MODAL -->
    <div class="modal-backdrop" id="auth-modal-backdrop">
      <div class="auth-modal">
        <div class="auth-header">
          <div>
            <div class="auth-title">Zero-Knowledge Access</div>
            <div class="auth-sub">Local zk-password & zk-KYS demo (no real backend yet)</div>
          </div>
          <button class="auth-close" id="btn-auth-close">✕</button>
        </div>
        <div class="auth-form">
          <div class="auth-row">
            <label for="auth-username">Username</label>
            <input type="text" id="auth-username" placeholder="trader.nebula" />
          </div>
          <div class="auth-row">
            <label for="auth-password">Password</label>
            <input type="password" id="auth-password" placeholder="Strong passphrase" />
          </div>
          <div class="auth-row">
            <label for="auth-kys-secret">KYS Secret (ZK-KYS Sim)</label>
            <input type="password" id="auth-kys-secret" placeholder="Encrypted ID hash" />
          </div>
          <div class="auth-row">
            <label>Local zk-Commit (Preview)</label>
            <input type="text" id="auth-commit-preview" readonly />
          </div>
          <div class="auth-row">
            <div class="zk-pill">
              <span class="zk-dot"></span>
              <span id="zk-status-label">ZK-Password & ZK-KYS: Not generated</span>
            </div>
          </div>
        </div>
        <div class="auth-actions">
          <button class="auth-btn secondary" id="btn-generate-zk">Generate ZK Commit</button>
          <button class="auth-btn" id="btn-login-zk">Login with ZK</button>
        </div>
        <div class="auth-footer">
          This is a UI-only prototype.
        </div>
      </div>
    </div>
    
    <!-- WALLET MODAL -->
    <div class="modal-backdrop" id="wallet-modal-backdrop">
      <div class="auth-modal" style="width: 600px;"> <!-- Wider modal -->
        <div class="auth-header">
          <div>
            <div class="auth-title">Wallet Balances</div>
            <div class="auth-sub">Your assets on Aynu CEX</div>
          </div>
          <button class="auth-close" id="btn-wallet-close">✕</button>
        </div>
        <div class="panel-actions" style="padding: 8px 0;">
            <button class="btn secondary small" id="btn-deposit">Deposit (Demo)</button>
            <button class="btn secondary small" id="btn-withdraw">Withdraw (Demo)</button>
        </div>
        <div class="wallet-table-wrapper" style="max-height: 400px;">
          <table class="wallet-table">
            <thead>
              <tr>
                <th>Asset</th>
                <th>Total</th>
                <th>Available</th>
                <th>In Orders</th>
              </tr>
            </thead>
            <tbody id="wallet-modal-body"></tbody>
          </table>
        </div>
      </div>
    </div>


    <!-- TOASTS -->
    <div class="toast-container" id="toast-container"></div>

  <script>
    // ==============================
    // BASIC STATE
    // ==============================
    const state = {
      connected: false,
      wallet: null,
      mode: "spot",     // "spot" | "futures" | "metals"
      view: "spot",    // "spot" | "futures" | "metals"
      markets: [],
      walletAssets: [],
      orderbook: { bids: [], asks: [] },
      trades: [],
      positions: [],
      openOrders: [],
      metals: [],
      feeRate: 0.001, // 0.1%
      zkCommit: null,
      selectedMarket: null,
      selectedHologram: null, // For metals vault
    };

    // ==============================
    // CHART STATE (TradingView-style)
    // ==============================
    const chartState = {
      type: "candles",
      timeFrame: "1m",
      upColor: "#4caf50",
      downColor: "#ff4b7d",
      showGrid: true,
      showWicks: true,
      theme: "night", // Default theme
      candles: [],
      minPrice: 0,
      maxPrice: 0,
      isDragging: false,
      lastDragY: 0,
      yAxisWidth: 60,
      currentTool: 'crosshair', // For drawing tools
    };

    // ==============================
    // DOM HELPERS
    // ==============================
    const qs = s => document.querySelector(s);
    const qsa = s => Array.from(document.querySelectorAll(s));

    function logActivity(message) {
      const log = qs("#activity-log");
      if (!log) return;
      const timestamp = new Date().toLocaleTimeString("en-US", { hour12: false });
      const line = document.createElement("div");
      line.textContent = `[${timestamp}] ${message}`;
      log.prepend(line);
      const maxLines = 50;
      while (log.children.length > maxLines) {
        log.removeChild(log.lastChild);
      }
    }

    function showToast(title, msg, type = "info", timeout = 3200) {
      const container = qs("#toast-container");
      if (!container) return;
      const t = document.createElement("div");
      t.className = "toast " + type;
      t.innerHTML = `<div class="toast-title">${title}</div><div class="toast-msg">${msg}</div>`;
      container.appendChild(t);
      setTimeout(() => {
        t.style.opacity = "0";
        t.style.transform = "translateY(4px)";
        setTimeout(() => container.removeChild(t), 400);
      }, timeout);
    }

    // ==============================
    // MOCK DATA INIT
    // ==============================
    function initMockData() {
      state.markets = [
        { pair: "AMR/NVR", last: 0.000050, change: 0.0, vol: 123456, base: "AMR", quote: "NVR", group: "amr" },
        { pair: "AMR/IONX", last: 0.020100, change: +2.3, vol: 9876, base: "AMR", quote: "IONX", group: "amr" },
        { pair: "NVR/IONX", last: 0.500000, change: -1.4, vol: 5123, base: "NVR", quote: "IONX", group: "nvr" },
        { pair: "IONX/USDT", last: 75.000000, change: +6.1, vol: 300, base: "IONX", quote: "USDT", group: "ionx" },
        { pair: "AMR/USDT", last: 0.000051, change: +0.5, vol: 888888, base: "AMR", quote: "USDT", group: "amr" }
      ];
      state.selectedMarket = state.markets[0];

      state.walletAssets = [
        { asset: "AMR", total: 100000, available: 80000, inOrders: 20000 },
        { asset: "NVR", total: 5000, available: 3000, inOrders: 2000 },
        { asset: "IONX", total: 120, available: 80, inOrders: 40 },
        { asset: "USDT", total: 10000, available: 10000, inOrders: 0 }
      ];
      state.positions = [
        { pair: "AMR/NVR", side: "long", size: 25000, entry: 0.000048, pnl: +12.5 },
        { pair: "IONX/USDT", side: "short", size: 10, entry: 80.0, pnl: -56.0 }
      ];
      state.openOrders = [
        { pair: "AMR/NVR", side: "buy", amount: 20000, price: 0.000045, total: 0.9 }
      ];
      state.metals = [
        { id: "LEX", name: "Lexirium", price: 500.0, desc: "High-density digital metal", tags: ["Core Reserve", "High Cov."], apy: "—", color1: "#7b5bff", color2: "#37c5ff" },
        { id: "CRY", name: "Crystal Shards", price: 50000.0, desc: "Ultra rare crystal layer", tags: ["Ultra Rare", "Illiquid"], apy: "—", color1: "#ff00ff", color2: "#ffffff" },
        { id: "GLD", name: "Digital Gold", price: 1000.0, desc: "1g gold-pegged digital bar", tags: ["Stable", "Backed"], apy: "—", color1: "#ffd700", color2: "#ffec80" },
        { id: "DMS", name: "Dark Matter", price: 10000.0, desc: "Exotic liquidity gravity", tags: ["Experimental", "Cosmic"], apy: "—", color1: "#000000", color2: "#ff00ff" }
      ];
      state.selectedHologram = state.metals[0];

      generateMockOrderbook();
      generateMockTrades();
      initChartData();
    }

    function generateMockOrderbook() {
      const mid = state.selectedMarket?.last || 0.000050;
      const num = 14;
      const asks = [];
      const bids = [];
      for (let i = 1; i <= num; i++) {
        const askPrice = mid + i * (mid * 0.0001);
        const bidPrice = mid - i * (mid * 0.0001);
        const askAmount = 2000 + Math.random() * 8000;
        const bidAmount = 2000 + Math.random() * 8000;
        asks.push({ price: askPrice, amount: askAmount, total: askPrice * askAmount });
        bids.push({ price: bidPrice, amount: bidAmount, total: bidPrice * bidAmount });
      }
      state.orderbook.asks = asks;
      state.orderbook.bids = bids;
    }

    function generateMockTrades() {
      const now = Date.now();
      const mid = state.selectedMarket?.last || 0.000050;
      state.trades = [];
      for (let i = 0; i < 40; i++) {
        const side = Math.random() > 0.5 ? "buy" : "sell";
        const price = mid + (Math.random() - 0.5) * (mid * 0.01);
        const amount = 1000 + Math.random() * 5000;
        state.trades.push({
          side,
          price,
          amount,
          ts: now - i * 60000
        });
      }
    }

    // ==============================
    // CHART DATA (CANDLES)
    // ==============================
    function initChartData() {
      const basePrice = state.selectedMarket?.last || 0.00005;
      chartState.candles = buildRandomCandles(basePrice, 80, chartState.timeFrame);

      const prices = chartState.candles.flatMap(c => [c.high, c.low]);
      let minP = Math.min(...prices);
      let maxP = Math.max(...prices);
      if (!isFinite(minP) || !isFinite(maxP) || minP === maxP) {
        minP = basePrice * 0.95;
        maxP = basePrice * 1.05;
      }
      const padding = (maxP - minP) * 0.1;
      chartState.minPrice = minP - padding;
      chartState.maxPrice = maxP + padding;
    }

    function buildRandomCandles(startPrice, count, tf) {
      const candles = [];
      let lastClose = startPrice;
      const now = Date.now();
      let tfMs;
      switch (tf) {
        case "1m":  tfMs = 60 * 1000; break;
        case "15m": tfMs = 15 * 60 * 1000; break;
        case "1h":  tfMs = 60 * 60 * 1000; break;
        case "4h":  tfMs = 4 * 60 * 60 * 1000; break;
        case "1d":  tfMs = 24 * 60 * 60 * 1000; break;
        default:    tfMs = 60 * 1000;
      }
      for (let i = count - 1; i >= 0; i--) {
        const t = now - i * tfMs;
        const volFactor =
          tf === "1m"  ? 0.005 :
          tf === "15m" ? 0.01 :
          tf === "1h"  ? 0.02 :
          tf === "4h"  ? 0.05 :
                         0.1;
        const drift = (Math.random() - 0.5) * (startPrice * volFactor);
        const open = lastClose;
        let close = open + drift;
        if (close <= 0) close = open * 0.999;
        const high = Math.max(open, close) + Math.abs(drift) * (0.4 + Math.random() * 0.6);
        const low  = Math.min(open, close) - Math.abs(drift) * (0.4 + Math.random() * 0.6);
        candles.push({ time: t, open, high, low, close });
        lastClose = close;
      }
      return candles;
    }

    // ==============================
    // ===== NEW MASTER RENDERER ====
    // ==============================
    function renderAll() {
      if (!state.selectedMarket) return;
      
      // Render components based on the active page
      if (state.view === 'spot') {
        renderMarkets();
        renderHud(state.selectedMarket);
        renderOrderbook();
        renderTrades();
        renderActiveOrdersAndPositions();
        
        updateTradeFormUI(); 
        renderChart();
      } else if (state.view === 'futures') {
        // Render futures components (currently placeholder)
      } else if (state.view === 'metals') {
        renderMetalsVault();
      }
      
      // Always render wallet (for modal)
      renderWallet();
    }

    function updateTradeFormUI() {
      const m = state.selectedMarket;
      if (!m) return;

      // Check if trade form elements exist on this page
      const tradePanelTitle = qs("#trade-panel-title");
      if (!tradePanelTitle) return; // Exit if not on trade page

      const base = m.base;
      const quote = m.quote;
      // Mode (spot/futures) is now state, not just a tab
      const modeTitle = state.mode.charAt(0).toUpperCase() + state.mode.slice(1);

      tradePanelTitle.textContent = `${modeTitle} Trade – ${m.pair}`;
      qs("#price-quote").textContent = quote;
      qs("#amount-base").textContent = base;
      qs("#total-quote").textContent = quote;
      qs("#balance-quote-symbol").textContent = quote;

      const quoteWallet = state.walletAssets.find(a => a.asset === quote);
      qs("#balance-quote").value = quoteWallet ? quoteWallet.available.toFixed(8) : "0.00000000";
      qs("#orderbook-title").textContent = `${modeTitle} Orderbook`;
      qs("#leverage-badge").textContent = state.mode === "spot" ? "Cross · 1x" : "Isolated · 10x (demo)";
      qs("#order-type-label").textContent = state.mode === "spot" ? "Spot" : "Futures";

      // Update submit button text based on login state
      const submitBtn = qs("#btn-submit-order");
      if (state.connected) {
        submitBtn.textContent = getOrderSide() === 'buy' ? "Place Buy Order" : "Place Sell Order";
      } else {
        submitBtn.textContent = "Login to Trade";
      }
    }

    // ==============================
    // RENDER FUNCTIONS (Individual)
    // ==============================
    function renderMarkets() {
      const tbody = qs("#market-body");
      if (!tbody) return;
      const searchInput = qs("#market-search-input");
      const search = searchInput ? searchInput.value.trim().toUpperCase() : "";
      const activeTab = qsa(".market-tab").find(t => t.classList.contains("active"))?.dataset.marketTab || "all";
      tbody.innerHTML = "";
      state.markets
        .filter(m => {
          if (search && !m.pair.toUpperCase().includes(search)) return false;
          if (activeTab === "all") return true;
          if (activeTab === "fav") return m.pair === "AMR/NVR"; // Simple fav logic
          return m.group === activeTab;
        })
        .forEach(m => {
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${m.pair}</td>
            <td>${m.last.toFixed(8)}</td>
            <td class="${m.change > 0 ? "change-up" : m.change < 0 ? "change-down" : ""}">
              ${m.change >= 0 ? "+" : ""}${m.change.toFixed(2)}%
            </td>
            <td>${formatVol(m.vol)}</td>
          `;
          tr.addEventListener("click", () => onSelectMarket(m));
          tbody.appendChild(tr);
        });
    }

    function renderHud(pairObj) {
      const m = pairObj || state.markets[0];
      if (!m) return;
      qs("#hud-pair").textContent = m.pair;
      qs("#hud-last").textContent = m.last.toFixed(8);
      const changeEl = qs("#hud-change");
      changeEl.textContent = (m.change >= 0 ? "+" : "") + m.change.toFixed(2) + "%";
      changeEl.classList.toggle("green", m.change >= 0);
      changeEl.classList.toggle("red", m.change < 0);
      qs("#hud-high").textContent = (m.last * 1.02).toFixed(8); // Mock
      qs("#hud-low").textContent = (m.last * 0.98).toFixed(8); // Mock
    }

    function renderOrderbook() {
      const asksBox = qs("#asks-body");
      const bidsBox = qs("#bids-body");
      if (!asksBox || !bidsBox) return;
      asksBox.innerHTML = "";
      bidsBox.innerHTML = "";
      const asks = [...state.orderbook.asks].sort((a, b) => a.price - b.price);
      const bids = [...state.orderbook.bids].sort((a, b) => b.price - a.price);
      const maxAskTotal = Math.max(...asks.map(a => a.total), 1);
      const maxBidTotal = Math.max(...bids.map(b => b.total), 1);

      asks.forEach(row => {
        const el = document.createElement("div");
        el.className = "order-row ask";
        const depth = (row.total / maxAskTotal) * 100;
        el.style.setProperty('--depth', `${depth.toFixed(1)}%`);
        el.innerHTML = `
          <span>${row.price.toFixed(8)}</span>
          <span>${row.amount.toFixed(2)}</span>
          <span>${row.total.toFixed(6)}</span>
        `;
        asksBox.appendChild(el);
      });

      bids.forEach(row => {
        const el = document.createElement("div");
        el.className = "order-row bid";
        const depth = (row.total / maxBidTotal) * 100;
        el.style.setProperty('--depth', `${depth.toFixed(1)}%`);
        el.innerHTML = `
          <span>${row.price.toFixed(8)}</span>
          <span>${row.amount.toFixed(2)}</span>
          <span>${row.total.toFixed(6)}</span>
        `;
        bidsBox.appendChild(el);
      });

      const bestAsk = asks[0]?.price || 0;
      const bestBid = bids[0]?.price || 0;
      const mid = bestAsk && bestBid ? (bestAsk + bestBid) / 2 : (state.selectedMarket?.last || 0);
      qs("#mid-price").textContent = mid.toFixed(8);
    }

    function renderTrades() {
      const tbody = qs("#trades-body");
      if (!tbody) return;
      tbody.innerHTML = "";
      state.trades.forEach(t => {
        const tr = document.createElement("tr");
        const timeStr = new Date(t.ts).toLocaleTimeString("en-US", { hour12: false });
        tr.innerHTML = `
          <td>${timeStr}</td>
          <td>${t.price.toFixed(8)}</td>
          <td>${t.amount.toFixed(2)}</td>
          <td class="${t.side === "buy" ? "buy-text" : "sell-text"}">${t.side.toUpperCase()}</td>
        `;
        tbody.appendChild(tr);
      });
    }

    function renderWallet() {
      const tbody = qs("#wallet-modal-body");
      if (!tbody) return;
      tbody.innerHTML = "";
      state.walletAssets.forEach(a => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${a.asset}</td>
          <td>${a.total.toFixed(8)}</td>
          <td>${a.available.toFixed(8)}</td>
          <td>${a.inOrders.toFixed(8)}</td>
        `;
        tbody.appendChild(tr);
      });
    }

    function renderActiveOrdersAndPositions() {
      const tbody = qs("#active-tbody");
      const thead = qs("#active-orders-thead");
      const title = qs("#active-panel-title");
      if (!tbody || !thead || !title) return;
      tbody.innerHTML = "";

      if (state.mode === 'futures') {
        title.textContent = "Open Positions (Futures)";
        thead.innerHTML = `
          <tr>
            <th>Pair</th>
            <th>Side</th>
            <th>Size</th>
            <th>Entry</th>
            <th>PnL</th>
          </tr>
        `;
        state.positions.forEach(p => {
          const tr = document.createElement("tr");
          const pnlClass = p.pnl >= 0 ? "buy-text" : "sell-text";
          tr.innerHTML = `
            <td>${p.pair}</td>
            <td><span class="tag ${p.side}">${p.side.toUpperCase()}</span></td>
            <td>${p.size.toFixed(2)}</td>
            <td>${p.entry.toFixed(8)}</td>
            <td class="${pnlClass}">${p.pnl.toFixed(2)}%</td>
          `;
          tbody.appendChild(tr);
        });
      } else {
        // Render Spot Orders
        title.textContent = "Open Orders (Spot)";
        thead.innerHTML = `
          <tr>
            <th>Pair</th>
            <th>Side</th>
            <th>Amount</th>
            <th>Price</th>
            <th>Total</th>
          </tr>
        `;
        state.openOrders.forEach(o => {
          const tr = document.createElement("tr");
          const sideClass = o.side === "buy" ? "buy-text" : "sell-text";
          tr.innerHTML = `
            <td>${o.pair}</td>
            <td class="${sideClass}">${o.side.toUpperCase()}</td>
            <td>${o.amount.toFixed(2)}</td>
            <td>${o.price.toFixed(8)}</td>
            <td>${o.total.toFixed(8)}</td>
          `;
          tbody.appendChild(tr);
        });
      }
    }

function renderQuickWallet() {
      const body = qs("#quick-wallet-body");
      if (!body) return; // ليتم العرض فقط في صفحة spot

      const m = state.selectedMarket;
      if (!m) {
        body.innerHTML = `<span style="color:var(--text-muted);font-size:11px;">الرجاء اختيار سوق...</span>`;
        return;
      }

      const base = state.walletAssets.find(a => a.asset === m.base);
      const quote = state.walletAssets.find(a => a.asset === m.quote);

      const assetsToRender = [
        { symbol: m.base, data: base },
        { symbol: m.quote, data: quote }
      ];

      body.innerHTML = ""; // مسح المحتوى القديم

      assetsToRender.forEach(asset => {
        const available = asset.data ? asset.data.available.toFixed(8) : "0.00000000";
        const inOrders = asset.data ? asset.data.inOrders.toFixed(8) : "0.00000000";
        
        const row = document.createElement("div");
        row.className = "wallet-asset-row";
        row.innerHTML = `
          <div class="wallet-asset-info">
            <span class="wallet-asset-name">${asset.symbol}</span>
            <div class="wallet-asset-balances">
              <div class="balance-line"><span>المتاح:</span> <span>${available}</span></div>
              <div class="balance-line"><span>في الطلبات:</span> <span>${inOrders}</span></div>
            </div>
          </div>
          <div class="wallet-asset-actions">
            <button class="btn small secondary quick-wallet-btn" data-action="deposit" data-asset="${asset.symbol}">إيداع</button>
            <button class="btn small secondary quick-wallet-btn" data-action="withdraw" data-asset="${asset.symbol}">سحب</button>
          </div>
        `;
        body.appendChild(row);
      });
    }
    function renderMetalsVault() {
      const grid = qs("#vault-metals-grid");
      if (!grid) return;
      grid.innerHTML = "";
      
      // Render Grid
      state.metals.forEach(m => {
        const card = document.createElement("div");
        card.className = "vault-metal-card";
        card.innerHTML = `
          <div class="vault-metal-name">${m.name}</div>
          <div class="vault-metal-tagline">${m.desc}</div>
          <div class="vault-metal-price">Price: ${m.price.toLocaleString()} NVR</div>
        `;
        card.addEventListener("click", () => {
          state.selectedHologram = m;
          renderHologram();
        });
        grid.appendChild(card);
      });

      // Render Hologram
      renderHologram();
    }
    
    function renderHologram() {
        const metal = state.selectedHologram;
        if (!metal) return;

        const title = qs("#hologram-title");
        const price = qs("#hologram-price");
        const faces = qsa(".hologram-face");
        
        if (title) title.textContent = metal.name;
        if (price) price.textContent = `Price: ${metal.price.toLocaleString()} NVR`;
        
        faces.forEach(face => {
            face.style.background = `linear-gradient(135deg, ${metal.color1}, ${metal.color2})`;
            face.style.boxShadow = `0 0 20px ${metal.color1}, 0 0 40px ${metal.color2}`;
        });
    }

    // ==============================
    // PAGE/MODE SWITCHING
    // ==============================
    function switchView(view) {
      state.view = view;
      
      // Hide all pages
      qsa(".page-container").forEach(p => p.style.display = "none");
      
      // Show the selected one
      const page = qs(`#page-${view}`);
      if (page) {
        page.style.display = "flex";
      }
      
      // Handle page-specific logic
      if (view === 'spot') {
        state.mode = 'spot';
      } else if (view === 'futures') {
        state.mode = 'futures';
      }
      
      logActivity(`Mapsd to ${view} page`);
      renderAll();
      // Recalculate chart data on view switch if it's a chart page
      if (view === 'spot' || view === 'futures') {
        initChartData();
        renderChart();
      }
    }

    function switchTradeMode(mode) {
      state.mode = mode;
      qsa(".mode-tab").forEach(btn => {
        btn.classList.toggle("active", btn.dataset.mode === mode);
      });

      const tradeWrapper = qs("#trade-forms-wrapper");
      const metalsWrapper = qs("#metals-wrapper");
      
      if (mode === "metals") {
        if(tradeWrapper) tradeWrapper.style.display = "none";
        if(metalsWrapper) metalsWrapper.style.display = "block";
      } else {
        if(tradeWrapper) tradeWrapper.style.display = "block";
        if(metalsWrapper) metalsWrapper.style.display = "none";
      }

      logActivity("Switched trade mode to " + mode);
      renderAll();
    }

    function onSelectMarket(m) {
      state.selectedMarket = m;
      logActivity(`Selected market ${m.pair}`);
      
      generateMockOrderbook();
      generateMockTrades();
      initChartData();
      renderAll();
      renderQuickWallet();
    }

    // ==============================
    // TRADE FORM LOGIC
    // ==============================
    function getOrderSide() {
      const active = qsa(".trade-side-btn").find(b => b.classList.contains("active"));
      return active?.dataset.side || "buy";
    }

    function recalcTrade() {
      const priceEl = qs("#input-price");
      const amountEl = qs("#input-amount");
      const totalEl = qs("#input-total");
      if (!priceEl || !amountEl || !totalEl) return;

      const price = parseFloat(priceEl.value) || 0;
      const amount = parseFloat(amountEl.value) || 0;
      const total = price * amount;
      totalEl.value = total ? total.toFixed(8) : "";
      const fee = total * state.feeRate;
      qs("#fee-rate").textContent = (state.feeRate * 100).toFixed(2) + "%";
      qs("#fee-estimate").textContent = fee.toFixed(8);
    }

    function handleQuickPct(pct) {
      if (!state.selectedMarket) return;
      const quoteWallet = state.walletAssets.find(a => a.asset === state.selectedMarket.quote);
      const baseWallet = state.walletAssets.find(a => a.asset === state.selectedMarket.base);
      
      const quoteBal = quoteWallet ? quoteWallet.available : 0;
      const baseBal = baseWallet ? baseWallet.available : 0;

      const priceEl = qs("#input-price");
      const price = parseFloat(priceEl.value) || (state.selectedMarket.last || 0.00005);
      if (price === 0) return; // Avoid division by zero
      
      const side = getOrderSide();
      let amount = 0;
      
      if (side === "buy") {
        const maxSpend = quoteBal * (pct / 100);
        amount = maxSpend / price;
      } else {
        const maxSell = baseBal * (pct / 100);
        amount = maxSell;
      }

      const amountEl = qs("#input-amount");
      if (amountEl) amountEl.value = amount.toFixed(8);
      recalcTrade();
    }

    /**
     * REBUILT: submitOrder with full wallet logic.
     */
    function submitOrder(e) {
      e.preventDefault();

      if (!state.connected) {
        showToast("Order Failed", "الرجاء تسجيل الدخول أولاً", "error");
        openAuthModal();
        return;
      }

      const side = getOrderSide();
      const price = parseFloat(qs("#input-price").value) || 0;
      const amount = parseFloat(qs("#input-amount").value) || 0;
      const total = price * amount;

      if (!price || !amount || !total) {
        showToast("Order rejected", "الرجاء إدخال سعر وكمية صالحة", "error");
        return;
      }

      const baseSymbol = state.selectedMarket.base;
      const quoteSymbol = state.selectedMarket.quote;
      const baseWallet = state.walletAssets.find(a => a.asset === baseSymbol);
      const quoteWallet = state.walletAssets.find(a => a.asset === quoteSymbol);

      if (!baseWallet || !quoteWallet) {
        showToast("Order Failed", "لم يتم العثور على أصول المحفظة", "error");
        return;
      }

      // --- Wallet Logic ---
      if (side === 'buy') {
        if (quoteWallet.available < total) {
          showToast("Order Failed", `رصيد ${quoteSymbol} غير كافٍ.`, "error");
          return;
        }
        quoteWallet.available -= total;
        quoteWallet.inOrders += total;
      } else { // 'sell'
        if (baseWallet.available < amount) {
          showToast("Order Failed", `رصيد ${baseSymbol} غير كافٍ.`, "error");
          return;
        }
        baseWallet.available -= amount;
        baseWallet.inOrders += amount;
      }

      const logMsg = `تم تقديم الطلب (${state.mode.toUpperCase()}): ${side.toUpperCase()} ${amount.toFixed(4)} ${baseSymbol} @ ${price.toFixed(8)} ${quoteSymbol}`;
      
      if (state.mode === 'futures') {
        state.positions.push({
          pair: state.selectedMarket.pair,
          side: side,
          size: amount,
          entry: price,
          pnl: 0.0
        });
        showToast("Position Opened (UI)", logMsg, "success");
      } else {
        state.openOrders.push({
          pair: state.selectedMarket.pair,
          side: side,
          amount: amount,
          price: price,
          total: total
        });
        showToast("Order Placed (UI)", logMsg, "success");
      }

      playOrderAnimation(side); // NEW: Play animation
      logActivity(logMsg);
      qs("#input-amount").value = "";
      recalcTrade();
      renderAll();
    }
    
    // NEW: Order Execution Animation
    function playOrderAnimation(side) {
        const btn = qs("#btn-submit-order");
        const chart = qs("#price-chart");
        if (!btn || !chart) return;

        const btnRect = btn.getBoundingClientRect();
        const chartRect = chart.getBoundingClientRect();
        
        const line = document.createElement('div');
        line.className = 'order-animation-line';
        
        const startX = btnRect.left + btnRect.width / 2;
        const startY = btnRect.top + btnRect.height / 2;
        const endX = chartRect.left + chartRect.width * 0.75; // Land on chart
        const endY = chartRect.top + chartRect.height / 2;

        line.style.left = `${startX}px`;
        line.style.top = `${startY}px`;
        line.style.background = side === 'buy' ? 'var(--success)' : 'var(--danger)';
        line.style.boxShadow = `0 0 5px ${side === 'buy' ? 'var(--success)' : 'var(--danger)'}`;

        document.body.appendChild(line);

        requestAnimationFrame(() => {
            const deltaX = endX - startX;
            const deltaY = endY - startY;
            line.style.transform = `translate(${deltaX}px, ${deltaY}px) scale(5.0)`;
            line.style.opacity = '0';
        });

        line.addEventListener('transitionend', () => {
            line.remove();
        });
    }

    // ==============================
    // MODAL LOGIC (Auth, Wallet)
    // ==============================
    function openAuthModal() {
      qs("#auth-modal-backdrop").classList.add("active");
    }
    function closeAuthModal() {
      qs("#auth-modal-backdrop").classList.remove("active");
    }
    function openWalletModal() {
        renderWallet(); // Ensure modal is up-to-date
        qs("#wallet-modal-backdrop").classList.add("active");
    }
    function closeWalletModal() {
        qs("#wallet-modal-backdrop").classList.remove("active");
    }

    function deriveHash(str) {
      let h1 = 0, h2 = 0;
      for (let i = 0; i < str.length; i++) {
        const ch = str.charCodeAt(i);
        h1 = (h1 * 31 + ch) | 0;
        h2 = (h2 * 131 + ch) | 0;
      }
      const mix = ((h1 >>> 0).toString(16) + (h2 >>> 0).toString(16)).padStart(32, "0");
      return "zk_" + mix.slice(0, 32);
    }

    function generateZkCommit() {
      const user = qs("#auth-username").value.trim();
      const pass = qs("#auth-password").value;
      const kys = qs("#auth-kys-secret").value;
      if (!user || !pass || !kys) {
        showToast("Missing fields", "الرجاء ملء جميع الحقول", "error");
        return;
      }
      const salted = `${user}::${pass}::${kys}`;
      const commit = deriveHash(salted);
      state.zkCommit = commit;
      qs("#auth-commit-preview").value = commit;
      qs("#zk-status-label").textContent = "تم إنشاء الالتزام (Commit) محلياً";
      localStorage.setItem("aynu_zk_commit", commit);
      localStorage.setItem("aynu_user", user);
      showToast("ZK Commit Ready", "تم إنشاء التزام ZK-KYS محلياً", "success");
      logActivity(`تم إنشاء التزام ZK للمستخدم ${user}`);
    }

    function loginWithZk() {
      if (!state.zkCommit) {
        generateZkCommit();
        if (!state.zkCommit) {
            showToast("No zk-commit", "الرجاء إنشاء التزام أولاً", "error");
            return;
        }
      }
      
      const stored = localStorage.getItem("aynu_zk_commit");
      if (stored && stored === state.zkCommit) {
        const user = localStorage.getItem("aynu_user") || "anonymous";
        state.connected = true;
        state.wallet = `amr-${user}-${Math.random().toString(16).slice(2, 8)}`;
        qs("#wallet-label").textContent = `Wallet: ${state.wallet}`;
        qs("#status-dot").classList.add("online");
        qs("#status-text").textContent = "RPC: Simulated · Local ZK";
        showToast("ZK Session", `تم تسجيل الدخول كـ ${user}`, "success");
        logActivity(`نجاح تسجيل الدخول (ZK) للمستخدم ${user}`);
        closeAuthModal();
        renderAll(); // Re-render to update trade button
      } else {
        showToast("ZK mismatch", "فشل التحقق من الالتزام (تجريبي)", "error");
        logActivity("فشل تسجيل الدخول (ZK) - عدم تطابق الالتزام");
      }
    }
    
    // ==============================
    // THEME LOGIC
    // ==============================
    function setTheme(themeName) {
        document.body.dataset.theme = themeName;
        chartState.theme = themeName;
        
        // Update the dropdown
        const themeSelect = qs("#chart-theme");
        if (themeSelect) themeSelect.value = themeName;
        
        logActivity(`تم تغيير الثيم إلى: ${themeName}`);
        renderChart();
    }

    function applyTimeBasedTheme() {
        const hour = new Date().getHours();
        if (hour > 5 && hour < 12) { // 6am - 11:59am
            setTheme('night'); // Default 'dark' mode
        } else if (hour >= 12 && hour < 18) { // 12pm - 5:59pm
            setTheme('evening'); // 'Evening' mode
        } else { // 6pm - 5:59am
            setTheme('night'); // 'Night' mode
        }
    }

    // ==============================
    // ADVANCED CHART RENDERING
    // ==============================
    function updateOhlcLabel(candle) {
      const row = qs("#chart-ohlc-row");
      if (!row || !candle) return;

      const dirClass = candle.close >= candle.open ? "up" : "down";
      row.innerHTML = `
        <span>O: ${candle.open.toFixed(8)}</span>
        <span>H: ${candle.high.toFixed(8)}</span>
        <span>L: ${candle.low.toFixed(8)}</span>
        <span class="${dirClass}">C: ${candle.close.toFixed(8)}</span>
      `;
    }

    function renderChart() {
      const canvas = qs("#price-chart");
      if (!canvas) return;

      const rect = canvas.getBoundingClientRect();
      if (rect.width === 0 || rect.height === 0) return;

      const dpr = window.devicePixelRatio || 1;
      const ctx = canvas.getContext("2d");

      canvas.width = rect.width * dpr;
      canvas.height = rect.height * dpr;
      ctx.save();
      ctx.scale(dpr, dpr);

      ctx.clearRect(0, 0, rect.width, rect.height);

      const candles = chartState.candles;
      if (!candles || candles.length === 0) {
        ctx.restore();
        return;
      }

      updateOhlcLabel(candles[candles.length - 1]);

      // Theme-aware colors
      const upColor = chartState.theme === 'holographic' ? 'var(--accent-3)' : chartState.upColor;
      const downColor = chartState.theme === 'holographic' ? 'var(--accent-4)' : chartState.downColor;
      const gridColor = chartState.theme === 'holographic' ? 'rgba(0, 255, 255, 0.2)' : 'rgba(255, 255, 255, 0.06)';
      // FIX: Added space between 'const' and 'textColor'
      const textColor = chartState.theme === 'holographic' ? 'var(--text-muted)' : 'rgba(150, 170, 255, 0.8)';

      const bgLayer = qs(".chart-canvas");
      const lineBg = qs("#chart-line-bg");
      if (chartState.theme === "minimal") {
        bgLayer.style.background = "linear-gradient(180deg,#080910,#05040d)";
        lineBg.style.opacity = "0.04";
      } else if (chartState.theme === "neon") {
        bgLayer.style.background = "radial-gradient(circle at top,#222b5a,#05030b)";
        lineBg.style.opacity = "0.20";
      } else if (chartState.theme === "holographic") {
         // Handled by CSS
      } else {
        bgLayer.style.background = "linear-gradient(180deg,rgba(21,28,68,0.9),rgba(8,7,22,0.98))";
        lineBg.style.opacity = "0.12";
      }

      const gridLayer = qs("#chart-grid-layer");
      gridLayer.style.display = chartState.showGrid ? "block" : "none";

      const paddingLeft = 8;
      const paddingRight = chartState.yAxisWidth;
      const paddingTop = 10;
      const paddingBottom = 14;
      const width = rect.width - paddingLeft - paddingRight;
      const height = rect.height - paddingTop - paddingBottom;

      const { minPrice, maxPrice } = chartState;
      if (!isFinite(minPrice) || !isFinite(maxPrice)) {
        ctx.restore(); return;
      }
      const priceRange = maxPrice - minPrice;
      if (priceRange <= 0) {
        ctx.restore(); return;
      }

      const candleCount = candles.length;
      const slotWidth = width / candleCount;
      const candleWidth = Math.max(4, slotWidth * 0.6);

      function yFor(price) {
        const ratio = (price - minPrice) / priceRange;
        return paddingTop + (1 - ratio) * height;
      }

      // LINE mode
      if (chartState.type === "line") {
        ctx.beginPath();
        ctx.lineWidth = 1.4;
        ctx.strokeStyle = chartState.theme === 'holographic' ? 'var(--accent-1)' : "#7ecbff";

        candles.forEach((c, i) => {
          const xCenter = paddingLeft + (i + 0.5) * slotWidth;
          const y = yFor(c.close);
          if (i === 0) ctx.moveTo(xCenter, y);
          else ctx.lineTo(xCenter, y);
        });
        ctx.stroke();

        ctx.lineTo(paddingLeft + (candleCount - 0.5) * slotWidth, paddingTop + height);
        ctx.lineTo(paddingLeft + (0.5) * slotWidth, paddingTop + height);
        ctx.closePath();
        ctx.fillStyle = chartState.theme === 'holographic' ? 'rgba(0, 255, 255, 0.15)' : "rgba(126,203,255,0.12)";
        ctx.fill();

        ctx.restore();
        return;
      }

      // CANDLE mode
      candles.forEach((c, i) => {
        const xCenter = paddingLeft + (i + 0.5) * slotWidth;
        const x = xCenter - candleWidth / 2;
        const yOpen = yFor(c.open);
        const yClose = yFor(c.close);
        const yHigh = yFor(c.high);
        const yLow = yFor(c.low);
        const isUp = c.close >= c.open;
        const color = isUp ? upColor : downColor;

        if (chartState.showWicks) {
          ctx.beginPath();
          ctx.strokeStyle = color;
          ctx.lineWidth = 1;
          ctx.moveTo(xCenter, yHigh);
          ctx.lineTo(xCenter, yLow);
          ctx.stroke();
        }

        const bodyTop = Math.min(yOpen, yClose);
        const bodyBottom = Math.max(yOpen, yClose);
        let bodyHeight = bodyBottom - bodyTop;
        if (bodyHeight < 1) bodyHeight = 1;

        ctx.fillStyle = color + "33"; // transparent
        ctx.fillRect(x - 0.5, bodyTop - 0.5, candleWidth + 1, bodyHeight + 1);
        ctx.fillStyle = color;
        ctx.fillRect(x, bodyTop, candleWidth, bodyHeight);
      });

      // --- Draw Y-Axis (Price Scale) ---
      ctx.strokeStyle = gridColor;
      ctx.fillStyle = textColor;
      ctx.lineWidth = 1;
      ctx.font = "10px 'JetBrains Mono', monospace";
      ctx.textAlign = "left";
      ctx.textBaseline = "middle";

      ctx.beginPath();
      ctx.moveTo(width + paddingLeft, paddingTop);
      ctx.lineTo(width + paddingLeft, height + paddingTop);
      ctx.stroke();

      const numLabels = 5;
      for (let i = 0; i <= numLabels; i++) {
        const ratio = i / numLabels;
        const price = maxPrice - (priceRange * ratio);
        const y = paddingTop + (height * ratio);

        ctx.beginPath();
        ctx.moveTo(width + paddingLeft, y);
        ctx.lineTo(width + paddingLeft + 5, y);
        ctx.stroke();
        ctx.fillText(price.toFixed(8), width + paddingLeft + 8, y);
      }

      ctx.restore();
    }


    // ==============================
    // CHART SETTINGS HANDLERS
    // ==============================
    function bindChartSettings() {
      // chart type
      qsa(".chart-type-btn").forEach(btn => {
        btn.addEventListener("click", () => {
          qsa(".chart-type-btn").forEach(b => b.classList.remove("active"));
          btn.classList.add("active");
          chartState.type = btn.dataset.chartType;
          logActivity(`Chart type: ${chartState.type}`);
          renderChart();
        });
      });

      // timeframe buttons
      qsa(".chart-mode-btn").forEach(btn => {
        btn.addEventListener("click", () => {
          qsa(".chart-mode-btn").forEach(b => b.classList.remove("active"));
          btn.classList.add("active");
          chartState.timeFrame = btn.dataset.tf;
          chartState.candles = buildRandomCandles(state.selectedMarket.last, 80, chartState.timeFrame);
          
          const prices = chartState.candles.flatMap(c => [c.high, c.low]);
          let minP = Math.min(...prices);
          let maxP = Math.max(...prices);
          const padding = (maxP - minP) * 0.1;
          chartState.minPrice = minP - padding;
          chartState.maxPrice = maxP + padding;

          logActivity(`Timeframe: ${chartState.timeFrame}`);
          renderChart();
        });
      });

      // settings panel toggle
      const toggle = qs("#chart-settings-toggle");
      const panel = qs("#chart-settings-panel");
      if (toggle) {
        toggle.addEventListener("click", () => {
          if (panel) panel.classList.toggle("active");
        });
      }

      // colors
      const candleUp = qs("#candle-up-color");
      if (candleUp) candleUp.addEventListener("input", (e) => {
        chartState.upColor = e.target.value;
        renderChart();
      });
      const candleDown = qs("#candle-down-color");
      if (candleDown) candleDown.addEventListener("input", (e) => {
        chartState.downColor = e.target.value;
        renderChart();
      });

      // grid / wicks
      const showGrid = qs("#show-grid");
      if (showGrid) showGrid.addEventListener("change", (e) => {
        chartState.showGrid = e.target.checked;
        renderChart();
      });
      const showWicks = qs("#show-wicks");
      if (showWicks) showWicks.addEventListener("change", (e) => {
        chartState.showWicks = e.target.checked;
        renderChart();
      });

      // theme
      const chartTheme = qs("#chart-theme");
      if (chartTheme) chartTheme.addEventListener("change", (e) => {
        setTheme(e.target.value);
      });

      // resize
      window.addEventListener("resize", () => {
        renderChart();
      });
    }

    // ==============================
    // UTILITIES & BINDINGS
    // ==============================
    function formatVol(v) {
      if (v > 1e9) return (v / 1e9).toFixed(2) + "B";
      if (v > 1e6) return (v / 1e6).toFixed(2) + "M";
      if (v > 1e3) return (v / 1e3).toFixed(2) + "K";
      return v.toFixed(2);
    }

    function bindEvents() {
      // nav tabs
      qsa(".nav-tab").forEach(btn => {
        btn.addEventListener("click", (e) => {
          e.preventDefault();
          qsa(".nav-tab").forEach(b => b.classList.remove("active"));
          btn.classList.add("active");
          
          const view = btn.dataset.view;
          if (view === "kyc") {
            openAuthModal();
          } else if (view === "wallet") {
            openWalletModal();
          } else {
            switchView(view);
          }
        });
      });

      // market tabs
      qsa(".market-tab").forEach(btn => {
        btn.addEventListener("click", () => {
          qsa(".market-tab").forEach(b => b.classList.remove("active"));
          btn.classList.add("active");
          renderMarkets();
        });
      });
      
      const marketSearch = qs("#market-search-input");
      if (marketSearch) marketSearch.addEventListener("input", renderMarkets);
      
      const btnRefreshMarkets = qs("#btn-refresh-markets");
      if(btnRefreshMarkets) btnRefreshMarkets.addEventListener("click", () => {
        generateMockOrderbook();
        renderOrderbook();
        renderMarkets();
        showToast("Markets", "تم تحديث الأسواق", "info");
      });

      // mode tabs
      qsa(".mode-tab").forEach(btn => {
        btn.addEventListener("click", () => {
          switchTradeMode(btn.dataset.mode);
        });
      });

      // order form
      const inputPrice = qs("#input-price");
      if (inputPrice) inputPrice.addEventListener("input", recalcTrade);

      const inputAmount = qs("#input-amount");
      if (inputAmount) inputAmount.addEventListener("input", recalcTrade);

      qsa(".quick-btn").forEach(btn => {
        btn.addEventListener("click", () => handleQuickPct(parseFloat(btn.dataset.pct)));
      });
      qsa(".trade-side-btn").forEach(btn => {
        btn.addEventListener("click", () => {
          qsa(".trade-side-btn").forEach(b => b.classList.remove("active"));
          btn.classList.add("active");
          const side = btn.dataset.side;
          const submit = qs("#btn-submit-order");
          if (submit) {
            submit.textContent = `Place ${side.charAt(0).toUpperCase() + side.slice(1)} Order`;
            submit.classList.toggle("sell", side === "sell");
            if (state.connected) {
                submit.textContent = side === 'buy' ? "Place Buy Order" : "Place Sell Order";
            }
          }
        });
      });
      const tradeForm = qs("#trade-form");
      if (tradeForm) tradeForm.addEventListener("submit", submitOrder);

      // trades / orderbook buttons
      const btnSyncOrderbook = qs("#btn-sync-orderbook");
      if (btnSyncOrderbook) btnSyncOrderbook.addEventListener("click", () => {
        generateMockOrderbook();
        renderOrderbook();
        showToast("Orderbook", "تم تحديث دفتر الطلبات", "info");
      });
      const btnRefreshTrades = qs("#btn-refresh-trades");
      if (btnRefreshTrades) btnRefreshTrades.addEventListener("click", () => {
        generateMockTrades();
        renderTrades();
        showToast("Trades", "تم تحديث الصفقات", "info");
      });

      // wallet actions (in modal)
      const btnDeposit = qs("#btn-deposit");
      if (btnDeposit) btnDeposit.addEventListener("click", () => showToast("Deposit", "هذه ميزة تجريبية", "info"));
      
      const btnWithdraw = qs("#btn-withdraw");
      if (btnWithdraw) btnWithdraw.addEventListener("click", () => showToast("Withdraw", "هذه ميزة تجريبية", "info"));
      
      const btnCloseAll = qs("#btn-close-all");
      if (btnCloseAll) btnCloseAll.addEventListener("click", () => {
        if (state.mode === 'futures') {
            state.positions = [];
            showToast("Positions", "تم إغلاق جميع الصفقات (تجريبي)", "info");
        } else {
            state.openOrders = [];
            showToast("Orders", "تم إلغاء جميع الطلبات (تجريبي)", "info");
        }
        renderActiveOrdersAndPositions();
      });

      // auth modal
      const btnOpenAuth = qs("#btn-open-auth");
      if (btnOpenAuth) btnOpenAuth.addEventListener("click", openAuthModal);

      const btnAuthClose = qs("#btn-auth-close");
      if (btnAuthClose) btnAuthClose.addEventListener("click", closeAuthModal);

      const btnGenZk = qs("#btn-generate-zk");
      if (btnGenZk) btnGenZk.addEventListener("click", generateZkCommit);
      
      const btnLoginZk = qs("#btn-login-zk");
      if (btnLoginZk) btnLoginZk.addEventListener("click", loginWithZk);
      
      const authBackdrop = qs("#auth-modal-backdrop");
      if (authBackdrop) authBackdrop.addEventListener("click", evt => {
        if (evt.target === authBackdrop) closeAuthModal();
      });
      
      // wallet modal
      const btnWalletClose = qs("#btn-wallet-close");
      if (btnWalletClose) btnWalletClose.addEventListener("click", closeWalletModal);
      
      const walletBackdrop = qs("#wallet-modal-backdrop");
      if (walletBackdrop) walletBackdrop.addEventListener("click", evt => {
        if (evt.target === walletBackdrop) closeWalletModal();
      });

      // Chart settings
      bindChartSettings();

      // --- Chart Price Axis Interaction ---
      const canvas = qs("#price-chart");
      if (!canvas) {
        console.error("Chart canvas not found, interactions disabled.");
        return; // Exit if canvas not found
      }
      canvas.addEventListener("mousedown", (e) => {
        const rect = canvas.getBoundingClientRect();
        const x = e.offsetX;
        if (x > rect.width - chartState.yAxisWidth) {
          chartState.isDragging = true;
          chartState.lastDragY = e.clientY;
          canvas.classList.add("y-axis-grabbing");
          e.preventDefault();
        }
      });

      window.addEventListener("mousemove", (e) => {
        if (!chartState.isDragging) return;
        const deltaY = e.clientY - chartState.lastDragY;
        chartState.lastDragY = e.clientY;
        const rect = canvas.getBoundingClientRect();
        const height = rect.height - 10 - 14; // paddingTop/Bottom
        const priceRange = chartState.maxPrice - chartState.minPrice;
        if (height > 0 && priceRange > 0) {
            const pricePerPixel = priceRange / height;
            const priceDelta = deltaY * pricePerPixel;
            chartState.minPrice += priceDelta;
            chartState.maxPrice += priceDelta;
            renderChart();
        }
      });

      window.addEventListener("mouseup", () => {
        chartState.isDragging = false;
        canvas.classList.remove("y-axis-grabbing");
      });

      canvas.addEventListener("wheel", (e) => {
        const rect = canvas.getBoundingClientRect();
        const x = e.offsetX;
        if (x > rect.width - chartState.yAxisWidth) {
          e.preventDefault();
          const zoomFactor = e.deltaY > 0 ? 1.05 : 0.95;
          const priceRange = chartState.maxPrice - chartState.minPrice;
          const newRange = priceRange * zoomFactor;
          const midPrice = (chartState.maxPrice + chartState.minPrice) / 2;
          chartState.minPrice = midPrice - newRange / 2;
          chartState.maxPrice = midPrice + newRange / 2;
          renderChart();
        }
      });
      
      const btnRefreshQuickWallet = qs("#btn-refresh-quick-wallet");
      if (btnRefreshQuickWallet) {
        btnRefreshQuickWallet.addEventListener("click", () => {
          renderQuickWallet();
          showToast("المحفظة السريعة", "تم تحديث الأرصدة", "info");
        });
      }

      const quickWalletBody = qs("#quick-wallet-body");
      if (quickWalletBody) {
        quickWalletBody.addEventListener("click", (e) => {
          const target = e.target.closest(".quick-wallet-btn");
          if (!target) return;
          
          const action = target.dataset.action;
          const asset = target.dataset.asset;
          
          if (action === "deposit") {
            showToast(`إيداع ${asset}`, "هذه ميزة تجريبية", "info");
          } else if (action === "withdraw") {
            showToast(`سحب ${asset}`, "هذه ميزة تجريبية", "info");
          }
        });
      }
      // NEW: Quick Actions HUD
      canvas.addEventListener("contextmenu", (e) => {
          e.preventDefault();
          const hud = qs("#quick-actions-hud");
          hud.style.display = 'flex';
          hud.style.top = `${e.clientY}px`;
          hud.style.left = `${e.clientX}px`;
      });
      window.addEventListener("click", (e) => {
          const hud = qs("#quick-actions-hud");
          if (hud && hud.style.display === 'flex' && !hud.contains(e.target)) {
              hud.style.display = 'none';
          }
      });
      
      // FIX: Add null checks
      const hudBuy = qs("#hud-buy-market");
      if (hudBuy) hudBuy.addEventListener("click", () => {
          showToast("Quick Action", "تم تنفيذ: شراء بسعر السوق (تجريبي)", "success");
          qs("#quick-actions-hud").style.display = 'none';
      });
      
      const hudSell = qs("#hud-sell-market");
      if (hudSell) hudSell.addEventListener("click", () => {
          showToast("Quick Action", "تم تنفيذ: بيع بسعر السوق (تجريبي)", "error");
          qs("#quick-actions-hud").style.display = 'none';
      });

      // NEW: Drawing Tools
      qsa(".drawing-tool-btn").forEach(btn => {
          btn.addEventListener("click", () => {
              qsa(".drawing-tool-btn").forEach(b => b.classList.remove("active"));
              btn.classList.add("active");
              chartState.currentTool = btn.dataset.tool;
              logActivity(`أداة الرسم: ${chartState.currentTool}`);
          });
      });

      // NEW: 3D Depth Map Button
      const depthBtn = qs("#btn-depth-chart");
      if(depthBtn) depthBtn.addEventListener("click", () => {
          showToast("3D Depth Map", "سيتم عرض خريطة العمق ثلاثية الأبعاد هنا (قيد التطوير)", "info");
      });
    }

    function initAnimationTick() {
      setInterval(() => {
        if (state.view !== 'spot') return; // Only update chart on spot page

        const m = state.selectedMarket;
        if (!m) return;
        
        const delta = (Math.random() - 0.5) * (m.last * 0.005);
        m.last = Math.max(0.00000001, m.last + delta);
        m.change += (Math.random() - 0.5) * 0.05;

        const candles = chartState.candles;
        if (candles.length > 0) {
          const last = candles[candles.length - 1];
          const newClose = m.last;
          const updated = {
            ...last,
            close: newClose,
            high: Math.max(last.high, newClose),
            low: Math.min(last.low, newClose)
          };
          candles[candles.length - 1] = updated;
        }
        
        renderHud(m);
        renderChart();
      }, 3500);
    }

    // ==============================
    // INIT
    // ==============================
    function init() {
      initMockData();
      bindEvents();
      
      // Set initial page view
      switchView('spot'); 
      
      // Set initial theme
      applyTimeBasedTheme(); 

      logActivity("Aynu CEX UI مُهيأ · تم تطبيق تصميم باينانس الاحترافي");
      initAnimationTick();
    }

    window.addEventListener("load", init);
  </script>
</body>
</html>
